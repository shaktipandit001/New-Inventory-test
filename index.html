<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Tracker - Real-Time</title>
</head>
<body>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            min-width: 150px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .category-header {
            background-color: #f1f8ff !important;
            font-weight: bold;
        }

        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quantity-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .quantity-btn {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: #2980b9;
        }

        .quantity-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .admin-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .admin-btn:hover {
            background: #c0392b;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .add-btn:hover {
            background: #219653;
        }

        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }

        .edit-btn:hover {
            background: #e67e22;
        }

        .count-summary {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #d1e7f7;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .analysis-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .decimal-btn {
            padding: 3px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .custom-increment {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .custom-increment-input {
            width: 60px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .location-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .location-btn {
            padding: 10px 20px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .location-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .status-banner {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-open {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .readonly-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .relative-container {
            position: relative;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-form button {
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .admin-only {
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
        }

        .user-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .location-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
            text-align: center;
        }

        .protection-code {
            background: white;
            padding: 30px;
            border-radius: 10px;
            color: #333;
            max-width: 400px;
            width: 90%;
        }

        .protection-code input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1.2rem;
            text-align: center;
        }

        .protection-code button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-online {
            background: #27ae60;
            color: white;
        }

        .sync-offline {
            background: #e74c3c;
            color: white;
        }

        .sync-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .stats, .filters, .month-selector {
                flex-direction: column;
            }
            
            .analysis-grid, .user-management {
                grid-template-columns: 1fr;
            }
            
            .quantity-controls {
                flex-wrap: wrap;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .sync-status {
                bottom: 10px;
                right: 10px;
                font-size: 0.8rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Protection Overlay -->
    <div id="protectionOverlay" class="protection-overlay">
        <div class="protection-code">
            <h2>üîí Shakti Featuring Protection</h2>
            <h3>Inventory System Access</h3>
            <p>Enter security code to continue</p>
            <input type="password" id="protectionCode" placeholder="Enter access code" autocomplete="off" onkeypress="if(event.key === 'Enter') checkProtectionCode()">
            <button onclick="checkProtectionCode()">Unlock System</button>
            <p id="protectionError" style="color: red; display: none; margin-top: 10px;">Invalid access code</p>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #666;">
                <p><strong>System Security:</strong> Created by Shakti Pandit</p>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <h2>Inventory System Login</h2>
        <div class="login-form">
            <input type="text" id="username" placeholder="Username" value="" autocomplete="off">
            <input type="password" id="password" placeholder="Password" value="" autocomplete="new-password">
            <button onclick="login()">Login</button>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <p><strong>Made by Shakti :</strong></p>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-status sync-online" style="display: none;">
        <span class="sync-icon">‚úì</span>
        <span>Synced with Server</span>
    </div>

    <div id="app" class="container" style="display: none;">
        <!-- Main App Content -->
        <header>
            <div class="header-content">
                <div>
                    <h1>Inventory Tracker</h1>
                    <p class="subtitle">Professional Inventory Management System - Real-Time</p>
                </div>
                <div class="user-info">
                    <div class="user-role" id="userRoleDisplay">Role: Loading...</div>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalProducts">0</div>
                            <div class="stat-label">Products</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalCategories">0</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalCounted">0</div>
                            <div class="stat-label">Counted Items</div>
                        </div>
                    </div>
                    <button class="admin-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Location Selector -->
        <div class="section">
            <h3>Select Location</h3>
            <div class="location-selector" id="locationSelector">
                <!-- Locations will be dynamically added -->
            </div>
            <div id="locationManagement" style="display: none;">
                <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
            </div>
        </div>

        <!-- Month Selector and Status -->
        <div class="section">
            <div class="month-selector">
                <div>
                    <strong>Current Period:</strong> 
                    <span id="currentPeriodDisplay"></span>
                </div>
                <div>
                    <strong>Status:</strong> 
                    <span id="countingStatus"></span>
                </div>
                <select id="yearSelect" onchange="updateMonthOptions()">
                    <option value="">Select Year</option>
                </select>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="">Select Month</option>
                </select>
                <button class="quantity-btn" onclick="createNewMonth()">Start New Month</button>
            </div>
            <div id="statusBanner" class="status-banner"></div>
        </div>

        <div class="tab-navigation">
            <button class="tab-button active" onclick="openTab('counting')">Quantity Counting</button>
            <button class="tab-button" onclick="openTab('products')">All Products</button>
            <button class="tab-button" onclick="openTab('analysis')">Analysis</button>
            <button class="tab-button" onclick="openTab('summary')">Count Summary</button>
            <button class="tab-button" onclick="openTab('archive')">Monthly Archive</button>
            <button class="tab-button admin-tab" onclick="openTab('activity')" style="display: none;">Activity Log</button>
            <button class="tab-button admin-tab" onclick="openTab('admin')" style="display: none;">Admin Panel</button>
        </div>

        <!-- Counting Tab -->
        <div id="counting" class="tab-content active">
            <div class="section relative-container">
                <div id="readonlyOverlay" class="readonly-overlay" style="display: none;">
                    Counting Period Closed - Read Only Mode
                </div>
                <h2>Quantity Counting - <span id="locationDisplay"></span></h2>
                <p>Use the buttons or type directly in the input field to adjust quantities. Supports any decimal values.</p>
                <div class="filters">
                    <select id="countingCategoryFilter" onchange="filterCountingProducts()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" id="countingSearch" placeholder="Search products..." onkeyup="filterCountingProducts()">
                </div>
                <table id="countingTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Price (‚Ç¨)</th>
                            <th>Quantity</th>
                            <th>Total Value</th>
                        </tr>
                    </thead>
                    <tbody id="countingList"></tbody>
                </table>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="section">
                <h2>Complete Product Catalog</h2>
                <div id="productManagement" style="margin-bottom: 15px; display: none;">
                    <button class="add-btn" onclick="showAddProductForm()">Add New Product</button>
                </div>
                <div class="filters">
                    <select id="categoryFilter" onchange="filterProducts()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()">
                </div>
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Price (‚Ç¨)</th>
                            <th id="productActionsHeader" style="display: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="section">
                <h2>Inventory Analysis - <span id="analysisLocation"></span></h2>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Total Inventory Value</h4>
                        <div class="analysis-value" id="totalInventoryValue">‚Ç¨0.00</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="inventoryProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="analysis-card">
                        <h4>Most Valuable Category</h4>
                        <div class="analysis-value" id="topCategory">-</div>
                        <div id="topCategoryValue">‚Ç¨0.00</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Average Price per Item</h4>
                        <div class="analysis-value" id="avgPrice">‚Ç¨0.00</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Items Counted</h4>
                        <div class="analysis-value" id="itemsCounted">0</div>
                        <div>out of <span id="totalItems">0</span> products</div>
                    </div>
                </div>
                <div class="chart-container">
                    <h4>Inventory Value by Category</h4>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Top 10 Most Valuable Products</h4>
                    <canvas id="topProductsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="section">
                <h2>Count Summary - <span id="summaryLocation"></span></h2>
                <div class="count-summary">
                    <h3>Summary by Category</h3>
                    <div id="categorySummary"></div>
                    <button class="reset-btn" onclick="resetCurrentCounts()">Reset Current Counts</button>
                </div>
                <div class="count-summary" style="margin-top: 20px;">
                    <h3>Total Counted Items</h3>
                    <div class="summary-row">
                        <span>Total Items Counted:</span>
                        <span id="totalItemsCounted">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Total Value:</span>
                        <span id="totalCountedValue">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archive Tab -->
        <div id="archive" class="tab-content">
            <div class="section">
                <h2>Monthly Archive</h2>
                <div class="filters">
                    <select id="archiveLocationFilter" onchange="displayArchive()">
                        <option value="all">All Locations</option>
                    </select>
                    <select id="archiveYearFilter" onchange="displayArchive()">
                        <option value="all">All Years</option>
                    </select>
                </div>
                <table id="archiveTable" class="archive-table">
                    <thead>
                        <tr>
                            <th>Month/Year</th>
                            <th>Location</th>
                            <th>Total Items</th>
                            <th>Total Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="archiveList"></tbody>
                </table>
            </div>
        </div>

        <!-- Activity Log Tab -->
        <div id="activity" class="tab-content">
            <div class="section admin-only">
                <h2>üìù Activity Log - User Actions Tracker</h2>
                <div class="filters">
                    <select id="activityUserFilter" onchange="displayActivityLog()">
                        <option value="all">All Users</option>
                    </select>
                    <select id="activityActionFilter" onchange="displayActivityLog()">
                        <option value="all">All Actions</option>
                        <option value="login">User Login</option>
                        <option value="logout">User Logout</option>
                        <option value="count_update">Quantity Change</option>
                        <option value="product_add">Product Added</option>
                        <option value="product_edit">Product Edited</option>
                        <option value="product_delete">Product Deleted</option>
                        <option value="user_add">User Added</option>
                        <option value="user_edit">User Edited</option>
                        <option value="user_delete">User Deleted</option>
                        <option value="location_add">Location Added</option>
                        <option value="count_reset">Counts Reset</option>
                        <option value="month_create">New Month Created</option>
                        <option value="data_export">Data Exported</option>
                    </select>
                    <select id="activityTimeFilter" onchange="displayActivityLog()">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="quantity-btn" onclick="exportActivityLog()">Export Log</button>
                    <button class="admin-btn" onclick="clearActivityLog()" style="margin-left: auto;">Clear Log</button>
                </div>
                
                <div class="stats" style="margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="stat-value" id="totalActivities">0</div>
                        <div class="stat-label">Total Activities</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="todayActivities">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeUsersCount">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
                
                <div style="max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                    <table>
                        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                            <tr>
                                <th>Time</th>
                                <th>User (Role)</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Location</th>
                                <th>Month</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogList"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
                    <p>üìä <strong>Activity Tracking Active</strong> - All user actions are being recorded</p>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="tab-content">
            <div class="section admin-only">
                <h2>Admin Panel</h2>
                <div class="user-management">
                    <div class="user-card admin">
                        <h4>System Administration</h4>
                        <p>Manage users, locations, and system settings</p>
                        <button class="admin-btn" onclick="showUserManagement()">Manage Users</button>
                        <button class="admin-btn" onclick="showLocationManagement()">Manage Locations</button>
                    </div>
                    <div class="user-card">
                        <h4>Data Management</h4>
                        <p>Export and backup system data</p>
                        <button class="quantity-btn" onclick="exportAllData()">Export All Data</button>
                    </div>
                </div>

                <div id="userManagementSection" style="display: none; margin-top: 30px;">
                    <h3>User Management</h3>
                    <div class="filters">
                        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                        <button class="add-btn" onclick="showAddUserForm()">Add New User</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Location Access</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userList"></tbody>
                    </table>
                </div>

                <div id="locationManagementSection" style="display: none; margin-top: 30px;">
                    <h3>Location Management</h3>
                    <div class="filters">
                        <input type="text" id="locationSearch" placeholder="Search locations..." onkeyup="filterLocations()">
                        <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Location Name</th>
                                <th>Location ID</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminLocationList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add New Product</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Product ID:</label>
                <input type="text" id="modalProductId" placeholder="Unique ID">
            </div>
            <div class="form-group">
                <label>Product Name:</label>
                <input type="text" id="modalProductName" placeholder="Product name">
            </div>
            <div class="form-group">
                <label>Category:</label>
                <input type="text" id="modalProductCategory" placeholder="Category">
            </div>
            <div class="form-group">
                <label>Unit:</label>
                <input type="text" id="modalProductUnit" placeholder="Unit (stuck, kartoon, etc.)">
            </div>
            <div class="form-group">
                <label>Price (‚Ç¨):</label>
                <input type="number" id="modalProductPrice" step="0.01" min="0" placeholder="0.00">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveProduct()">Save Product</button>
                <button class="admin-btn" onclick="closeModal('productModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="locationModalTitle">Add New Location</h3>
                <button class="modal-close" onclick="closeModal('locationModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Location Name:</label>
                <input type="text" id="modalLocationName" placeholder="Location name">
            </div>
            <div class="form-group">
                <label>Location ID:</label>
                <input type="text" id="modalLocationId" placeholder="Unique ID (e.g., 'potsdam')">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveLocation()">Save Location</button>
                <button class="admin-btn" onclick="closeModal('locationModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add New User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="modalUsername" placeholder="Username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="modalPassword" placeholder="Password">
            </div>
            <div class="form-group">
                <label>Role:</label>
                <select id="modalUserRole">
                    <option value="inventory">Inventory User (Count Only)</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location Access:</label>
                <div id="locationAccessList">
                    <!-- Locations will be dynamically added -->
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveUser()">Save User</button>
                <button class="admin-btn" onclick="closeModal('userModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIXED PROTECTION SYSTEM ====================
        const PROTECTION_CODES = [
            'BFS2024INV',    // Main code
            'SHAKTIINV24',   // Backup code  
            'FOODSERVICES',  // Emergency code
            'HAFERKATER',    // Additional code
            'INVENTORY2024'  // Year-specific code
        ];

        const HASHED_CODES = PROTECTION_CODES.map(code => 
            btoa(unescape(encodeURIComponent(code))).replace(/=/g, '')
        );

        function initializeProtection() {
            console.log('Initializing protection system...');
            
            document.getElementById('protectionOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'none';
            
            const sessionUnlocked = sessionStorage.getItem('systemUnlocked');
            if (sessionUnlocked === 'true') {
                console.log('Session unlocked - showing login screen');
                showLoginScreen();
                return;
            }
            
            const protectionSession = localStorage.getItem('protectionSession');
            if (protectionSession) {
                try {
                    const session = JSON.parse(protectionSession);
                    if (session.expires && session.expires > Date.now()) {
                        console.log('Valid session found in localStorage');
                        showLoginScreen();
                        return;
                    } else {
                        console.log('Session expired - clearing');
                        localStorage.removeItem('protectionSession');
                        sessionStorage.removeItem('systemUnlocked');
                    }
                } catch (e) {
                    console.error('Invalid session data:', e);
                    localStorage.removeItem('protectionSession');
                    sessionStorage.removeItem('systemUnlocked');
                }
            }
            
            console.log('No valid session - showing protection screen');
            document.getElementById('protectionOverlay').style.display = 'flex';
            document.getElementById('protectionCode').value = '';
            document.getElementById('protectionError').style.display = 'none';
            
            setTimeout(() => {
                const input = document.getElementById('protectionCode');
                if (input) input.focus();
            }, 100);
        }

        function checkProtectionCode() {
            const inputCode = document.getElementById('protectionCode').value.trim();
            const errorMsg = document.getElementById('protectionError');
            
            errorMsg.style.display = 'none';
            
            if (!inputCode) {
                errorMsg.textContent = 'Please enter an access code';
                errorMsg.style.display = 'block';
                return;
            }
            
            try {
                const encodedInput = unescape(encodeURIComponent(inputCode));
                const inputHash = btoa(encodedInput).replace(/=/g, '');
                
                console.log('Checking code (first 3 chars):', inputCode.substring(0, 3) + '...');
                
                if (HASHED_CODES.includes(inputHash)) {
                    console.log('Access granted!');
                    
                    const sessionData = {
                        unlocked: true,
                        timestamp: Date.now(),
                        expires: Date.now() + (8 * 60 * 60 * 1000)
                    };
                    
                    localStorage.setItem('protectionSession', JSON.stringify(sessionData));
                    sessionStorage.setItem('systemUnlocked', 'true');
                    
                    document.getElementById('protectionOverlay').style.display = 'none';
                    errorMsg.style.display = 'none';
                    
                    showLoginScreen();
                } else {
                    console.log('Access denied - invalid code');
                    errorMsg.textContent = 'Invalid access code. Please try again.';
                    errorMsg.style.display = 'block';
                    document.getElementById('protectionCode').value = '';
                    document.getElementById('protectionCode').focus();
                    
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error checking code:', error);
                errorMsg.textContent = 'System error. Please try again.';
                errorMsg.style.display = 'block';
            }
        }

        function showLoginScreen() {
            console.log('Showing login screen');
            document.getElementById('protectionOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            setTimeout(() => {
                document.getElementById('username').focus();
            }, 100);
        }

        // ==================== REAL-TIME INVENTORY SYSTEM ====================
        let products = [];
        let locations = [];
        let users = [];
        let monthlyData = {};
        let activityLogs = [];
        let currentUser = null;
        let currentLocation = 'ostbahnhof';
        let currentMonth = '';
        let firebaseInitialized = false;
        let isOnline = true;
        let pendingChanges = [];

        // ==================== FIREBASE FUNCTIONS ====================
        function initializeFirebase() {
            if (firebaseInitialized) {
                console.log('Firebase already initialized');
                return;
            }
            
            try {
                console.log('Initializing Firebase...');
                const firebaseConfig = {
                    apiKey: "AIzaSyCvENxXAfEqgegtr5RFIYcolV_eURTcbzA",
                    authDomain: "invbfs.firebaseapp.com",
                    databaseURL: "https://invbfs-default-rtdb.firebaseio.com",
                    projectId: "invbfs",
                    storageBucket: "invbfs.appspot.com",
                    messagingSenderId: "183500505178",
                    appId: "1:183500505178:web:0ca737b5d200005bbc9863"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase initialized successfully');
                } else {
                    console.log('Firebase already initialized');
                }
                
                firebaseInitialized = true;
                
                // Monitor connection status
                firebase.database().ref('.info/connected').on('value', (snapshot) => {
                    isOnline = snapshot.val() === true;
                    updateSyncStatus();
                    
                    if (isOnline && pendingChanges.length > 0) {
                        console.log('Back online, syncing pending changes...');
                        syncPendingChanges();
                    }
                });
                
                // Load all data from Firebase
                loadAllData();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Warning: Firebase initialization failed. Working in offline mode.');
                isOnline = false;
                updateSyncStatus();
                loadFromLocalStorage();
            }
        }

        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            if (!syncStatus) return;
            
            syncStatus.style.display = 'flex';
            
            if (isOnline) {
                syncStatus.className = 'sync-status sync-online';
                syncStatus.innerHTML = '<span class="sync-icon">‚úì</span><span>Synced with Server</span>';
            } else {
                syncStatus.className = 'sync-status sync-offline';
                syncStatus.innerHTML = '<span class="sync-icon">‚ö†</span><span>Offline Mode (Changes queued)</span>';
            }
        }

        function syncPendingChanges() {
            if (!isOnline || pendingChanges.length === 0) return;
            
            console.log(`Syncing ${pendingChanges.length} pending changes...`);
            
            pendingChanges.forEach(change => {
                switch(change.type) {
                    case 'product':
                        saveProductToFirebase(change.data);
                        break;
                    case 'user':
                        saveUserToFirebase(change.data);
                        break;
                    case 'count':
                        saveCountToFirebase(change.data);
                        break;
                    case 'activity':
                        saveActivityToFirebase(change.data);
                        break;
                }
            });
            
            pendingChanges = [];
        }

        // ==================== DATA LOADING FUNCTIONS ====================
        function loadAllData() {
            if (!firebaseInitialized) {
                loadFromLocalStorage();
                return;
            }
            
            console.log('Loading all data from Firebase...');
            
            // Load products
            firebase.database().ref('products').on('value', (snapshot) => {
                const firebaseProducts = snapshot.val();
                
                if (firebaseProducts) {
                    products = Object.keys(firebaseProducts).map(key => ({
                        id: key,
                        ...firebaseProducts[key]
                    }));
                    console.log(`Loaded ${products.length} products from Firebase`);
                } else {
                    console.log('No products in Firebase, importing default...');
                    importAllProductsToFirebase();
                }
                
                // Update UI if needed
                if (document.getElementById('products')?.classList.contains('active')) {
                    displayProducts();
                }
                if (document.getElementById('counting')?.classList.contains('active')) {
                    displayCountingProducts();
                }
                
                updateCategoryFilter();
            });
            
            // Load users
            firebase.database().ref('users').on('value', (snapshot) => {
                const firebaseUsers = snapshot.val();
                
                if (firebaseUsers) {
                    users = Object.keys(firebaseUsers).map(key => ({
                        id: key,
                        ...firebaseUsers[key]
                    }));
                    console.log(`Loaded ${users.length} users from Firebase`);
                } else {
                    console.log('No users in Firebase, creating default admin...');
                    createDefaultAdmin();
                }
            });
            
            // Load locations
            firebase.database().ref('locations').on('value', (snapshot) => {
                const firebaseLocations = snapshot.val();
                
                if (firebaseLocations) {
                    locations = Object.keys(firebaseLocations).map(key => ({
                        id: key,
                        ...firebaseLocations[key]
                    }));
                    console.log(`Loaded ${locations.length} locations from Firebase`);
                } else {
                    console.log('No locations in Firebase, creating defaults...');
                    createDefaultLocations();
                }
                
                updateLocationSelector();
            });
            
            // Load monthly data
            firebase.database().ref('monthly_data').on('value', (snapshot) => {
                const firebaseMonthlyData = snapshot.val();
                
                if (firebaseMonthlyData) {
                    monthlyData = firebaseMonthlyData;
                    console.log(`Loaded monthly data from Firebase`);
                }
                
                if (currentUser) {
                    updateUI();
                    displayArchive();
                }
            });
            
            // Load activity logs
            firebase.database().ref('activity_logs').on('value', (snapshot) => {
                const firebaseActivities = snapshot.val();
                
                if (firebaseActivities) {
                    // Convert to array and sort by timestamp
                    activityLogs = Object.keys(firebaseActivities).map(key => ({
                        id: key,
                        ...firebaseActivities[key]
                    })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    console.log(`Loaded ${activityLogs.length} activity logs from Firebase`);
                }
                
                if (document.getElementById('activity')?.classList.contains('active')) {
                    displayActivityLog();
                }
            });
        }

        function loadFromLocalStorage() {
            console.log('Loading from localStorage (offline mode)');
            
            products = JSON.parse(localStorage.getItem('inventoryProducts')) || [];
            users = JSON.parse(localStorage.getItem('inventoryUsers')) || [];
            locations = JSON.parse(localStorage.getItem('inventoryLocations')) || [];
            monthlyData = JSON.parse(localStorage.getItem('monthlyInventoryData')) || {};
            activityLogs = JSON.parse(localStorage.getItem('inventoryActivityLogs')) || [];
            
            if (products.length === 0) {
                importAllProducts();
            }
            if (users.length === 0) {
                createDefaultAdmin();
            }
            if (locations.length === 0) {
                createDefaultLocations();
            }
        }

        // ==================== DEFAULT DATA CREATION ====================
        function createDefaultAdmin() {
            const defaultAdmin = {
                id: 'admin',
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                locations: ['ostbahnhof', 'potsdam'],
                createdAt: new Date().toISOString(),
                lastLogin: null
            };
            
            users.push(defaultAdmin);
            
            if (isOnline && firebaseInitialized) {
                firebase.database().ref('users/admin').set(defaultAdmin)
                    .then(() => console.log('Default admin created in Firebase'))
                    .catch(error => console.error('Error creating admin:', error));
            } else {
                localStorage.setItem('inventoryUsers', JSON.stringify(users));
            }
        }

        function createDefaultLocations() {
            const defaultLocations = [
                { id: 'ostbahnhof', name: 'Haferkater Ostbahnhof', active: true },
                { id: 'potsdam', name: 'Haferkater Potsdam', active: true }
            ];
            
            locations = defaultLocations;
            
            if (isOnline && firebaseInitialized) {
                defaultLocations.forEach(location => {
                    firebase.database().ref(`locations/${location.id}`).set({
                        name: location.name,
                        active: location.active
                    });
                });
                console.log('Default locations created in Firebase');
            } else {
                localStorage.setItem('inventoryLocations', JSON.stringify(locations));
            }
        }

        // ==================== FIREBASE SAVE FUNCTIONS ====================
        function saveProductToFirebase(product) {
            if (!firebaseInitialized) {
                pendingChanges.push({ type: 'product', data: product });
                saveToLocalStorage('inventoryProducts', products);
                return;
            }
            
            const productId = product.id;
            const { id, ...productData } = product;
            
            firebase.database().ref(`products/${productId}`).set(productData)
                .then(() => console.log(`Product ${productId} saved to Firebase`))
                .catch(error => {
                    console.error('Error saving product to Firebase:', error);
                    pendingChanges.push({ type: 'product', data: product });
                });
                
            saveToLocalStorage('inventoryProducts', products);
        }

        function saveUserToFirebase(user) {
            if (!firebaseInitialized) {
                pendingChanges.push({ type: 'user', data: user });
                saveToLocalStorage('inventoryUsers', users);
                return;
            }
            
            const userId = user.id || user.username;
            const { id, ...userData } = user;
            
            firebase.database().ref(`users/${userId}`).set(userData)
                .then(() => console.log(`User ${userId} saved to Firebase`))
                .catch(error => {
                    console.error('Error saving user to Firebase:', error);
                    pendingChanges.push({ type: 'user', data: user });
                });
                
            saveToLocalStorage('inventoryUsers', users);
        }

        function saveCountToFirebase(data) {
            if (!firebaseInitialized) {
                pendingChanges.push({ type: 'count', data: data });
                saveToLocalStorage('monthlyInventoryData', monthlyData);
                return;
            }
            
            const { location, month, productId, count } = data;
            const key = `${location}|${month}`;
            
            firebase.database().ref(`monthly_data/${key}/counts/${productId}`).set(count)
                .then(() => console.log(`Count for ${productId} saved to Firebase`))
                .catch(error => {
                    console.error('Error saving count to Firebase:', error);
                    pendingChanges.push({ type: 'count', data: data });
                });
                
            saveToLocalStorage('monthlyInventoryData', monthlyData);
        }

        function saveActivityToFirebase(activity) {
            if (!firebaseInitialized) {
                pendingChanges.push({ type: 'activity', data: activity });
                saveToLocalStorage('inventoryActivityLogs', activityLogs);
                return;
            }
            
            const activityId = activity.id;
            const { id, ...activityData } = activity;
            
            firebase.database().ref(`activity_logs/${activityId}`).set(activityData)
                .then(() => console.log(`Activity ${activityId} saved to Firebase`))
                .catch(error => {
                    console.error('Error saving activity to Firebase:', error);
                    pendingChanges.push({ type: 'activity', data: activity });
                });
                
            saveToLocalStorage('inventoryActivityLogs', activityLogs);
        }

        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Error saving to localStorage for ${key}:`, error);
            }
        }

        // ==================== IMPORT PRODUCTS ====================
        function importAllProductsToFirebase() {
            const allProducts = [
                // Your complete product list here (same as before)
                { id: '382224', name: 'B1774_Porridgebecher 500St', unit: 'stuck', category: 'Verbrauch', price: 0.075 },
                // ... (include all 155 products from your list)
            ];
            
            products = allProducts;
            
            if (isOnline && firebaseInitialized) {
                allProducts.forEach(product => {
                    const productId = product.id;
                    const { id, ...productData } = product;
                    firebase.database().ref(`products/${productId}`).set(productData);
                });
                console.log('All products imported to Firebase');
            }
            
            saveToLocalStorage('inventoryProducts', products);
        }

        function importAllProducts() {
            // Same function as before for offline mode
            const allProducts = [
                // Your complete product list here
            ];
            
            products = allProducts;
            saveToLocalStorage('inventoryProducts', products);
        }

        // ==================== ACTIVITY TRACKING ====================
        function logActivity(action, details = {}) {
            if (!currentUser) return;
            
            const activity = {
                id: 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                user: currentUser.username,
                userRole: currentUser.role,
                location: currentLocation,
                month: currentMonth,
                action: action,
                details: details
            };
            
            console.log('Activity logged:', activity);
            
            // Add to local array
            activityLogs.unshift(activity);
            if (activityLogs.length > 1000) activityLogs = activityLogs.slice(0, 1000);
            
            // Save to Firebase
            saveActivityToFirebase(activity);
            
            // Update display if on activity tab
            if (document.getElementById('activity')?.classList.contains('active')) {
                displayActivityLog();
            }
        }

        // ==================== LOGIN SYSTEM ====================
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                console.log('Login successful for user:', username);
                currentUser = user;
                user.lastLogin = new Date().toISOString();
                
                // Update last login
                if (isOnline && firebaseInitialized && user.id) {
                    firebase.database().ref(`users/${user.id}/lastLogin`).set(user.lastLogin);
                }
                
                saveToLocalStorage('inventoryUsers', users);
                
                // Log login activity
                logActivity('login', { 
                    username: username, 
                    role: user.role,
                    locations: user.locations 
                });
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                initializeFirebase();
                init();
            } else {
                alert('Invalid username or password');
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }

        function logout() {
            if (currentUser) {
                logActivity('logout', { username: currentUser.username });
            }
            
            console.log('Logging out...');
            currentUser = null;
            firebaseInitialized = false;
            
            sessionStorage.removeItem('systemUnlocked');
            localStorage.removeItem('protectionSession');
            
            initializeProtection();
        }

        // ==================== INITIALIZATION ====================
        function init() {
            console.log('Initializing inventory app...');
            
            if (products.length === 0 && !firebaseInitialized) {
                importAllProducts();
            }
            
            setupLocationSelector();
            updateCategoryFilter();
            setupYearMonthSelectors();
            setCurrentMonth();
            updateUI();
            displayArchive();
            updateUserInterfaceBasedOnRole();
            
            updateSyncStatus();
        }

        // ==================== USER MANAGEMENT ====================
        function updateUserInterfaceBasedOnRole() {
            if (!currentUser) return;
            
            const isAdmin = currentUser.role === 'admin';
            document.getElementById('userRoleDisplay').textContent = `Role: ${isAdmin ? 'Administrator' : 'Inventory User'}`;
            document.getElementById('productManagement').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('locationManagement').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('productActionsHeader').style.display = isAdmin ? 'table-cell' : 'none';
            
            document.querySelectorAll('.admin-tab').forEach(el => {
                el.style.display = isAdmin ? 'block' : 'none';
            });
            
            updateLocationSelector();
        }

        function showAddUserForm() {
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalUserRole').value = 'inventory';
            
            const locationAccessList = document.getElementById('locationAccessList');
            locationAccessList.innerHTML = '';
            
            locations.filter(l => l.active).forEach(location => {
                const div = document.createElement('div');
                div.className = 'location-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = location.id;
                checkbox.checked = true;
                checkbox.id = `loc-${location.id}`;
                
                const label = document.createElement('label');
                label.textContent = location.name;
                label.htmlFor = `loc-${location.id}`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                locationAccessList.appendChild(div);
            });
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function saveUser() {
            const username = document.getElementById('modalUsername').value.trim();
            const password = document.getElementById('modalPassword').value;
            const role = document.getElementById('modalUserRole').value;
            
            if (!username || !password) {
                alert('Please fill all fields');
                return;
            }
            
            const existingUser = users.find(u => u.username === username);
            const locationAccess = Array.from(document.querySelectorAll('#locationAccessList input:checked'))
                .map(checkbox => checkbox.value);
            
            if (existingUser) {
                // Update existing user
                existingUser.password = password;
                existingUser.role = role;
                existingUser.locations = locationAccess;
                existingUser.updatedAt = new Date().toISOString();
                
                logActivity('user_edit', {
                    username: username,
                    role: role,
                    locations: locationAccess
                });
                
                saveUserToFirebase(existingUser);
            } else {
                // Add new user
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const newUser = {
                    id: userId,
                    username: username,
                    password: password,
                    role: role,
                    locations: locationAccess,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                users.push(newUser);
                
                logActivity('user_add', {
                    username: username,
                    role: role,
                    userId: userId,
                    locations: locationAccess
                });
                
                saveUserToFirebase(newUser);
            }
            
            closeModal('userModal');
            showUserManagement();
            alert(existingUser ? 'User updated successfully' : 'User added successfully');
        }

        function deleteUser(username) {
            if (username === 'admin') {
                alert('Cannot delete admin user');
                return;
            }
            
            const userToDelete = users.find(u => u.username === username);
            if (!userToDelete) return;
            
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                logActivity('user_delete', {
                    username: username,
                    role: userToDelete.role,
                    deletedBy: currentUser.username
                });
                
                users = users.filter(u => u.username !== username);
                
                // Remove from Firebase
                if (isOnline && firebaseInitialized && userToDelete.id) {
                    firebase.database().ref(`users/${userToDelete.id}`).remove()
                        .then(() => console.log(`User ${username} deleted from Firebase`))
                        .catch(error => console.error('Error deleting user:', error));
                }
                
                saveToLocalStorage('inventoryUsers', users);
                displayUsers();
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role === 'admin' ? 'Administrator' : 'Inventory User'}</td>
                    <td>${user.locations.map(l => getLocationDisplayName(l)).join(', ')}</td>
                    <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
                        ${user.username !== 'admin' ? `<button class="admin-btn" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
                    </td>
                `;
            });
        }

        // ==================== PRODUCT MANAGEMENT ====================
        function showAddProductForm() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('modalProductId').value = '';
            document.getElementById('modalProductId').disabled = false;
            document.getElementById('modalProductName').value = '';
            document.getElementById('modalProductCategory').value = '';
            document.getElementById('modalProductUnit').value = '';
            document.getElementById('modalProductPrice').value = '';
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            const id = document.getElementById('modalProductId').value.trim();
            const name = document.getElementById('modalProductName').value.trim();
            const category = document.getElementById('modalProductCategory').value.trim();
            const unit = document.getElementById('modalProductUnit').value.trim();
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            
            if (!id || !name || !category || !unit || isNaN(price)) {
                alert('Please fill all fields correctly');
                return;
            }
            
            const existingProduct = products.find(p => p.id === id);
            
            if (existingProduct) {
                // Update existing product
                const oldData = { ...existingProduct };
                existingProduct.name = name;
                existingProduct.category = category;
                existingProduct.unit = unit;
                existingProduct.price = price;
                
                logActivity('product_edit', {
                    productId: id,
                    changes: {
                        name: { old: oldData.name, new: name },
                        category: { old: oldData.category, new: category },
                        unit: { old: oldData.unit, new: unit },
                        price: { old: oldData.price, new: price }
                    }
                });
                
                saveProductToFirebase(existingProduct);
            } else {
                // Add new product
                const newProduct = { id, name, category, unit, price };
                products.push(newProduct);
                
                logActivity('product_add', {
                    productId: id,
                    productName: name,
                    category: category,
                    unit: unit,
                    price: price
                });
                
                saveProductToFirebase(newProduct);
            }
            
            closeModal('productModal');
            displayProducts();
            updateCategoryFilter();
            alert(existingProduct ? 'Product updated successfully' : 'Product added successfully');
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`Are you sure you want to delete "${product.name}"?`)) {
                logActivity('product_delete', {
                    productId: productId,
                    productName: product.name,
                    category: product.category,
                    price: product.price
                });
                
                products = products.filter(p => p.id !== productId);
                
                // Remove from Firebase
                if (isOnline && firebaseInitialized) {
                    firebase.database().ref(`products/${productId}`).remove()
                        .then(() => console.log(`Product ${productId} deleted from Firebase`))
                        .catch(error => console.error('Error deleting product:', error));
                }
                
                saveToLocalStorage('inventoryProducts', products);
                displayProducts();
                
                // Remove from monthly data
                Object.keys(monthlyData).forEach(key => {
                    if (monthlyData[key].counts && monthlyData[key].counts[productId]) {
                        delete monthlyData[key].counts[productId];
                    }
                });
                saveToLocalStorage('monthlyInventoryData', monthlyData);
            }
        }

        // ==================== COUNTING FUNCTIONS ====================
        function incrementCount(productId, increment = 1) {
            if (isCountingClosed()) return;
            
            const key = `${currentLocation}|${currentMonth}`;
            
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
            }
            
            const currentCount = parseFloat(monthlyData[key].counts[productId]) || 0;
            const product = products.find(p => p.id === productId);
            
            monthlyData[key].counts[productId] = currentCount + increment;
            
            // Save to Firebase
            saveCountToFirebase({
                location: currentLocation,
                month: currentMonth,
                productId: productId,
                count: currentCount + increment
            });
            
            logActivity('count_update', {
                productId: productId,
                productName: product ? product.name : 'Unknown',
                change: increment,
                previousCount: currentCount,
                newCount: currentCount + increment,
                location: currentLocation,
                month: currentMonth
            });
            
            displayCountingProducts();
            updateSummary();
            updateAnalysis();
        }

        function decrementCount(productId, decrement = 1) {
            if (isCountingClosed()) return;
            
            const key = `${currentLocation}|${currentMonth}`;
            
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
            }
            
            const currentCount = parseFloat(monthlyData[key].counts[productId]) || 0;
            const newCount = Math.max(0, currentCount - decrement);
            const product = products.find(p => p.id === productId);
            
            monthlyData[key].counts[productId] = newCount;
            
            // Save to Firebase
            saveCountToFirebase({
                location: currentLocation,
                month: currentMonth,
                productId: productId,
                count: newCount
            });
            
            logActivity('count_update', {
                productId: productId,
                productName: product ? product.name : 'Unknown',
                change: -decrement,
                previousCount: currentCount,
                newCount: newCount,
                location: currentLocation,
                month: currentMonth
            });
            
            displayCountingProducts();
            updateSummary();
            updateAnalysis();
        }

        // ==================== ACTIVITY LOG FUNCTIONS ====================
        function displayActivityLog() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const userFilter = document.getElementById('activityUserFilter').value;
            const actionFilter = document.getElementById('activityActionFilter').value;
            const timeFilter = document.getElementById('activityTimeFilter').value;
            
            // Update user filter options
            const userFilterSelect = document.getElementById('activityUserFilter');
            userFilterSelect.innerHTML = '<option value="all">All Users</option>';
            const uniqueUsers = [...new Set(activityLogs.map(log => log.user))];
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilterSelect.appendChild(option);
            });
            
            // Filter logs
            let filteredLogs = [...activityLogs];
            
            if (userFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.user === userFilter);
            }
            
            if (actionFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.action === actionFilter);
            }
            
            // Time filter
            const now = new Date();
            if (timeFilter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= today);
            } else if (timeFilter === 'yesterday') {
                const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredLogs = filteredLogs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    return logDate >= yesterday && logDate < today;
                });
            } else if (timeFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= weekAgo);
            } else if (timeFilter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= monthAgo);
            }
            
            // Display logs
            const tbody = document.getElementById('activityLogList');
            tbody.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align: center; padding: 20px; color: #666;">No activities found for selected filters</td>`;
                return;
            }
            
            filteredLogs.forEach(log => {
                const row = tbody.insertRow();
                const time = new Date(log.timestamp);
                const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = time.toLocaleDateString();
                
                let detailsHtml = '';
                switch(log.action) {
                    case 'count_update':
                        detailsHtml = `Product: ${log.details.productId}<br>
                                      Change: ${log.details.change > 0 ? '+' : ''}${log.details.change}<br>
                                      New Count: ${log.details.newCount}`;
                        break;
                    case 'product_add':
                        detailsHtml = `ID: ${log.details.productId}<br>
                                      Name: ${log.details.productName}<br>
                                      Category: ${log.details.category}<br>
                                      Price: ‚Ç¨${log.details.price}`;
                        break;
                    case 'product_edit':
                        detailsHtml = `Product ID: ${log.details.productId}<br>
                                      Changes: ${Object.keys(log.details.changes).join(', ')}`;
                        break;
                    case 'product_delete':
                        detailsHtml = `Deleted Product ID: ${log.details.productId}`;
                        break;
                    case 'user_add':
                        detailsHtml = `Username: ${log.details.username}<br>
                                      Role: ${log.details.role}`;
                        break;
                    default:
                        detailsHtml = JSON.stringify(log.details);
                }
                
                let badgeColor = '';
                switch(log.action) {
                    case 'login': badgeColor = '#27ae60'; break;
                    case 'logout': badgeColor = '#e74c3c'; break;
                    case 'count_update': badgeColor = '#3498db'; break;
                    case 'product_add': badgeColor = '#2ecc71'; break;
                    case 'product_delete': badgeColor = '#e74c3c'; break;
                    case 'user_add': badgeColor = '#9b59b6'; break;
                    default: badgeColor = '#f39c12';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${dateStr}</strong><br>
                        <small>${timeStr}</small>
                    </td>
                    <td>
                        <strong>${log.user}</strong><br>
                        <small style="color: #666;">${log.userRole}</small>
                    </td>
                    <td>
                        <span style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">
                            ${log.action.replace('_', ' ')}
                        </span>
                    </td>
                    <td style="max-width: 300px; word-wrap: break-word;">
                        ${detailsHtml}
                    </td>
                    <td>${getLocationDisplayName(log.location)}</td>
                    <td>${log.month ? formatMonthDisplay(log.month) : '-'}</td>
                `;
            });
            
            // Update stats
            document.getElementById('totalActivities').textContent = activityLogs.length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayActivities = activityLogs.filter(log => new Date(log.timestamp) >= today).length;
            document.getElementById('todayActivities').textContent = todayActivities;
            
            const uniqueActiveUsers = [...new Set(activityLogs
                .filter(log => new Date(log.timestamp) >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000))
                .map(log => log.user))].length;
            document.getElementById('activeUsersCount').textContent = uniqueActiveUsers;
        }

        // ==================== OTHER FUNCTIONS (keep as before) ====================
        // [Include all the other functions from your original code here:
        // setupLocationSelector, updateLocationSelector, setLocation,
        // setupYearMonthSelectors, updateMonthOptions, changeMonth,
        // setCurrentMonth, createNewMonth, updateMonthDisplay,
        // updateCountingStatus, displayCountingProducts,
        // setManualCount, applyCustomIncrement, isCountingClosed,
        // formatDecimal, updateSummary, resetCurrentCounts,
        // filterProducts, filterCountingProducts, displayArchive,
        // viewArchive, exportAllData, exportToExcel, updateAnalysis,
        // showAddLocationForm, saveLocation, showUserManagement,
        // showLocationManagement, displayAdminLocations, toggleLocation,
        // deleteLocation, closeModal, getLocationDisplayName,
        // formatMonthDisplay, displayProducts, editProduct,
        // updateCategoryFilter, openTab, updateUI, exportActivityLog,
        // clearActivityLog]

        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded - initializing protection system');
            initializeProtection();
        });
    </script>
</body>
</html>
