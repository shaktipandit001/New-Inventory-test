<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Manager - Real Time</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      padding: 20px 0;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 5px;
    }

    .subtitle {
      font-size: 1rem;
      opacity: 0.8;
    }

    .user-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-role {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }

    .stats {
      display: flex;
      gap: 20px;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .stat-label {
      font-size: 0.8rem;
    }

    .section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filters select, .filters input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      min-width: 150px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .category-header {
      background-color: #f1f8ff !important;
      font-weight: bold;
    }

    .tab-navigation {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #7f8c8d;
      border-bottom: 3px solid transparent;
    }

    .tab-button.active {
      color: #3498db;
      border-bottom: 3px solid #3498db;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .quantity-controls {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-wrap: wrap;
    }

    .quantity-btn {
      padding: 5px 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-weight: bold;
    }

    .quantity-btn:hover {
      background: #2980b9;
    }

    .quantity-input {
      width: 80px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      text-align: center;
    }

    .admin-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .admin-btn:hover {
      background: #c0392b;
    }

    .add-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .add-btn:hover {
      background: #219653;
    }

    .edit-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin: 2px;
    }

    .edit-btn:hover {
      background: #e67e22;
    }

    .count-summary {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #d1e7f7;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .reset-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .analysis-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #3498db;
    }

    .analysis-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #ecf0f1;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #3498db;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }

    .decimal-btn {
      padding: 3px 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .custom-increment {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }

    .custom-increment-input {
      width: 60px;
      padding: 3px;
      border: 1px solid #ddd;
      border-radius: 3px;
      text-align: center;
    }

    .month-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #e8f4fd;
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .location-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .location-btn {
      padding: 10px 20px;
      background: #ecf0f1;
      border: 2px solid #bdc3c7;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .location-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .status-banner {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }

    .status-open {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-closed {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .readonly-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: #e74c3c;
    }

    .relative-container {
      position: relative;
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .login-form input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .login-form button {
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 15px;
    }

    .form-group label {
      font-weight: 600;
      color: #2c3e50;
    }

    .form-group input, .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .admin-only {
      border-left: 4px solid #e74c3c;
      background: #fdf2f2;
    }

    .user-management {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .user-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #3498db;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }

    .location-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .protection-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 1.5rem;
      text-align: center;
    }

    .protection-code {
      background: white;
      padding: 30px;
      border-radius: 10px;
      color: #333;
      max-width: 400px;
      width: 90%;
    }

    .protection-code input {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 2px solid #3498db;
      border-radius: 5px;
      font-size: 1.2rem;
      text-align: center;
    }

    .protection-code button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .sync-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      z-index: 1001;
    }

    .sync-online {
      background: #27ae60;
      color: white;
    }

    .sync-offline {
      background: #e74c3c;
      color: white;
    }

    .sync-syncing {
      background: #f39c12;
      color: white;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .stats, .filters, .month-selector {
        flex-direction: column;
      }
      
      .analysis-grid, .user-management {
        grid-template-columns: 1fr;
      }
      
      .quantity-controls {
        flex-wrap: wrap;
      }
      
      .tab-navigation {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sync Indicator -->
  <div id="syncIndicator" class="sync-indicator sync-offline">Offline</div>

  <!-- Protection Overlay -->
  <div id="protectionOverlay" class="protection-overlay">
    <div class="protection-code">
      <h2>üîí Inventory System Access</h2>
      <h3>Real-Time Inventory Management</h3>
      <p>Enter security code to continue</p>
      <input type="password" id="protectionCode" placeholder="Enter access code" autocomplete="off" onkeypress="if(event.key === 'Enter') checkProtectionCode()">
      <button onclick="checkProtectionCode()">Unlock System</button>
      <p id="protectionError" style="color: red; display: none; margin-top: 10px;">Invalid access code</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container" style="display: none;">
    <h2>Inventory System Login</h2>
    <div class="login-form">
      <input type="text" id="username" placeholder="Username" autocomplete="off">
      <input type="password" id="password" placeholder="Password" autocomplete="new-password">
      <button onclick="login()">Login</button>
    </div>
    <div style="margin-top: 20px; text-align: center;">
      <p><strong>Real-Time Inventory System</strong></p>
      <p>All changes sync instantly across all devices</p>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="container" style="display: none;">
    <header>
      <div class="header-content">
        <div>
          <h1>Real-Time Inventory Tracker</h1>
          <p class="subtitle">Live Sync Across All Devices</p>
        </div>
        <div class="user-info">
          <div class="user-role" id="userRoleDisplay">Role: Loading...</div>
          <div class="stats">
            <div class="stat-box">
              <div class="stat-value" id="totalProducts">0</div>
              <div class="stat-label">Products</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="totalCategories">0</div>
              <div class="stat-label">Categories</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="totalCounted">0</div>
              <div class="stat-label">Counted Items</div>
            </div>
          </div>
          <button class="admin-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <!-- Location Selector -->
    <div class="section">
      <h3>Select Location</h3>
      <div class="location-selector" id="locationSelector">
        <!-- Locations loaded from Firebase -->
      </div>
      <div id="locationManagement" style="display: none;">
        <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
      </div>
    </div>

    <!-- Month Selector -->
    <div class="section">
      <div class="month-selector">
        <div>
          <strong>Current Period:</strong> 
          <span id="currentPeriodDisplay"></span>
        </div>
        <div>
          <strong>Status:</strong> 
          <span id="countingStatus"></span>
        </div>
        <select id="yearSelect" onchange="updateMonthOptions()">
          <option value="">Select Year</option>
        </select>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="">Select Month</option>
        </select>
        <button class="quantity-btn" onclick="createNewMonth()">Start New Month</button>
      </div>
      <div id="statusBanner" class="status-banner"></div>
    </div>

    <!-- Tabs -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="openTab('counting')">Quantity Counting</button>
      <button class="tab-button" onclick="openTab('products')">All Products</button>
      <button class="tab-button" onclick="openTab('analysis')">Analysis</button>
      <button class="tab-button" onclick="openTab('summary')">Count Summary</button>
      <button class="tab-button" onclick="openTab('archive')">Monthly Archive</button>
      <button class="tab-button admin-tab" onclick="openTab('admin')" style="display: none;">Admin Panel</button>
    </div>

    <!-- Counting Tab -->
    <div id="counting" class="tab-content active">
      <div class="section relative-container">
        <div id="readonlyOverlay" class="readonly-overlay" style="display: none;">
          Counting Period Closed - Read Only Mode
        </div>
        <h2>Quantity Counting - <span id="locationDisplay"></span></h2>
        <p>Real-time updates. Changes sync instantly across all devices.</p>
        <div class="filters">
          <select id="countingCategoryFilter" onchange="filterCountingProducts()">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="countingSearch" placeholder="Search products..." onkeyup="filterCountingProducts()">
        </div>
        <table id="countingTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Price (‚Ç¨)</th>
              <th>Quantity</th>
              <th>Total Value</th>
            </tr>
          </thead>
          <tbody id="countingList"></tbody>
        </table>
      </div>
    </div>

    <!-- Products Tab -->
    <div id="products" class="tab-content">
      <div class="section">
        <h2>Complete Product Catalog</h2>
        <div id="productManagement" style="margin-bottom: 15px; display: none;">
          <button class="add-btn" onclick="showAddProductForm()">Add New Product</button>
        </div>
        <div class="filters">
          <select id="categoryFilter" onchange="filterProducts()">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()">
        </div>
        <table id="productTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Price (‚Ç¨)</th>
              <th id="productActionsHeader" style="display: none;">Actions</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>
    </div>

    <!-- Analysis Tab -->
    <div id="analysis" class="tab-content">
      <div class="section">
        <h2>Inventory Analysis - <span id="analysisLocation"></span></h2>
        <div class="analysis-grid">
          <div class="analysis-card">
            <h4>Total Inventory Value</h4>
            <div class="analysis-value" id="totalInventoryValue">‚Ç¨0.00</div>
            <div class="progress-bar">
              <div class="progress-fill" id="inventoryProgress" style="width: 0%"></div>
            </div>
          </div>
          <div class="analysis-card">
            <h4>Most Valuable Category</h4>
            <div class="analysis-value" id="topCategory">-</div>
            <div id="topCategoryValue">‚Ç¨0.00</div>
          </div>
          <div class="analysis-card">
            <h4>Items Counted</h4>
            <div class="analysis-value" id="itemsCounted">0</div>
            <div>out of <span id="totalItems">0</span> products</div>
          </div>
          <div class="analysis-card">
            <h4>Average Price per Item</h4>
            <div class="analysis-value" id="avgPrice">‚Ç¨0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Tab -->
    <div id="summary" class="tab-content">
      <div class="section">
        <h2>Count Summary - <span id="summaryLocation"></span></h2>
        <div class="count-summary">
          <h3>Summary by Category</h3>
          <div id="categorySummary"></div>
          <button class="reset-btn" onclick="resetCurrentCounts()">Reset Current Counts</button>
        </div>
        <div class="count-summary" style="margin-top: 20px;">
          <h3>Total Counted Items</h3>
          <div class="summary-row">
            <span>Total Items Counted:</span>
            <span id="totalItemsCounted">0</span>
          </div>
          <div class="summary-row">
            <span>Total Value:</span>
            <span id="totalCountedValue">‚Ç¨0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Archive Tab -->
    <div id="archive" class="tab-content">
      <div class="section">
        <h2>Monthly Archive</h2>
        <div class="filters">
          <select id="archiveLocationFilter" onchange="displayArchive()">
            <option value="all">All Locations</option>
          </select>
          <select id="archiveYearFilter" onchange="displayArchive()">
            <option value="all">All Years</option>
          </select>
        </div>
        <table id="archiveTable">
          <thead>
            <tr>
              <th>Month/Year</th>
              <th>Location</th>
              <th>Total Items</th>
              <th>Total Value</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archiveList"></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin" class="tab-content">
      <div class="section admin-only">
        <h2>Admin Panel</h2>
        <div class="user-management">
          <div class="user-card">
            <h4>System Administration</h4>
            <p>Manage users, locations, and system settings</p>
            <button class="admin-btn" onclick="showUserManagement()">Manage Users</button>
            <button class="admin-btn" onclick="showLocationManagement()">Manage Locations</button>
          </div>
          <div class="user-card">
            <h4>Data Management</h4>
            <p>Export and backup system data</p>
            <button class="quantity-btn" onclick="exportAllData()">Export All Data</button>
            <button class="quantity-btn" onclick="forceSync()" style="margin-top: 10px;">Force Sync Now</button>
          </div>
        </div>

        <div id="userManagementSection" style="display: none; margin-top: 30px;">
          <h3>User Management</h3>
          <div class="filters">
            <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
            <button class="add-btn" onclick="showAddUserForm()">Add New User</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Location Access</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="userList"></tbody>
          </table>
        </div>

        <div id="locationManagementSection" style="display: none; margin-top: 30px;">
          <h3>Location Management</h3>
          <div class="filters">
            <input type="text" id="locationSearch" placeholder="Search locations..." onkeyup="filterLocations()">
            <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Location Name</th>
                <th>Location ID</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminLocationList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productModalTitle">Add New Product</h3>
        <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Product ID:</label>
        <input type="text" id="modalProductId" placeholder="Unique ID">
      </div>
      <div class="form-group">
        <label>Product Name:</label>
        <input type="text" id="modalProductName" placeholder="Product name">
      </div>
      <div class="form-group">
        <label>Category:</label>
        <input type="text" id="modalProductCategory" placeholder="Category">
      </div>
      <div class="form-group">
        <label>Unit:</label>
        <input type="text" id="modalProductUnit" placeholder="Unit">
      </div>
      <div class="form-group">
        <label>Price (‚Ç¨):</label>
        <input type="number" id="modalProductPrice" step="0.01" min="0" placeholder="0.00">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="add-btn" onclick="saveProduct()">Save Product</button>
        <button class="admin-btn" onclick="closeModal('productModal')">Cancel</button>
      </div>
    </div>
  </div>

  <div id="locationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="locationModalTitle">Add New Location</h3>
        <button class="modal-close" onclick="closeModal('locationModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Location Name:</label>
        <input type="text" id="modalLocationName" placeholder="Location name">
      </div>
      <div class="form-group">
        <label>Location ID:</label>
        <input type="text" id="modalLocationId" placeholder="Unique ID">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="add-btn" onclick="saveLocation()">Save Location</button>
        <button class="admin-btn" onclick="closeModal('locationModal')">Cancel</button>
      </div>
    </div>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userModalTitle">Add New User</h3>
        <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Username:</label>
        <input type="text" id="modalUsername" placeholder="Username">
      </div>
      <div class="form-group">
        <label>Password:</label>
        <input type="password" id="modalPassword" placeholder="Password">
      </div>
      <div class="form-group">
        <label>Role:</label>
        <select id="modalUserRole">
          <option value="inventory">Inventory User</option>
          <option value="admin">Administrator</option>
        </select>
      </div>
      <div class="form-group">
        <label>Location Access:</label>
        <div id="locationAccessList"></div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="add-btn" onclick="saveUser()">Save User</button>
        <button class="admin-btn" onclick="closeModal('userModal')">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== REAL-TIME INVENTORY SYSTEM ====================
    const PROTECTION_CODES = ['BFS2024INV', 'SHAKTIINV24', 'FOODSERVICES', 'HAFERKATER'];
    const HASHED_CODES = PROTECTION_CODES.map(code => btoa(unescape(encodeURIComponent(code))).replace(/=/g, ''));
    
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCvENxXAfEqgegtr5RFIYcolV_eURTcbzA",
      authDomain: "invbfs.firebaseapp.com",
      databaseURL: "https://invbfs-default-rtdb.firebaseio.com",
      projectId: "invbfs",
      storageBucket: "invbfs.appspot.com",
      messagingSenderId: "183500505178",
      appId: "1:183500505178:web:0ca737b5d200005bbc9863"
    };

    // Global variables
    let currentUser = null;
    let currentLocation = 'ostbahnhof';
    let currentMonth = '';
    let db = null;
    let firebaseInitialized = false;
    let syncInProgress = false;
    let pendingChanges = [];

    // Initialize app
    async function init() {
      try {
        console.log('Initializing Firebase...');
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.database();
        firebaseInitialized = true;
        
        // Set up connection monitoring
        const connectedRef = db.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          const indicator = document.getElementById('syncIndicator');
          if (snap.val() === true) {
            indicator.className = 'sync-indicator sync-online';
            indicator.textContent = 'Online';
            // Sync any pending changes when coming back online
            if (pendingChanges.length > 0) {
              syncPendingChanges();
            }
          } else {
            indicator.className = 'sync-indicator sync-offline';
            indicator.textContent = 'Offline';
          }
        });

        // Set current month
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        currentMonth = `${year}-${month}`;
        
        // Load initial data
        await Promise.all([
          loadProducts(),
          loadLocations(),
          loadUsers(),
          loadMonthlyData()
        ]);
        
        // Set up real-time listeners
        setupRealtimeListeners();
        
        // Initialize UI
        setupLocationSelector();
        setupYearMonthSelectors();
        updateMonthDisplay();
        updateUI();
        updateUserInterfaceBasedOnRole();
        
        console.log('App initialized successfully');
      } catch (error) {
        console.error('Initialization error:', error);
        alert('Error initializing app. Please refresh the page.');
      }
    }

    // ==================== REAL-TIME FIREBASE FUNCTIONS ====================

    // Setup real-time listeners
    function setupRealtimeListeners() {
      // Listen for product changes
      db.ref('products').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.products = Object.values(data);
          displayProducts();
          updateCategoryFilter();
          if (document.getElementById('counting').classList.contains('active')) {
            displayCountingProducts();
          }
        }
      });

      // Listen for location changes
      db.ref('locations').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.locations = Object.values(data);
          updateLocationSelector();
          if (currentUser) {
            updateUserInterfaceBasedOnRole();
          }
        }
      });

      // Listen for user changes
      db.ref('users').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.users = Object.values(data);
          if (document.getElementById('userManagementSection').style.display === 'block') {
            displayUsers();
          }
        }
      });

      // Listen for monthly data changes for current location/month
      const monthlyDataRef = db.ref(`monthlyData/${currentLocation}/${currentMonth}`);
      monthlyDataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          if (!window.monthlyData) window.monthlyData = {};
          if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
          window.monthlyData[currentLocation][currentMonth] = data;
          
          // Update UI if on counting tab
          if (document.getElementById('counting').classList.contains('active')) {
            displayCountingProducts();
            updateSummary();
            updateAnalysis();
          }
        }
      });
    }

    // Load initial data
    async function loadProducts() {
      return new Promise((resolve) => {
        db.ref('products').once('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            window.products = Object.values(data);
          } else {
            // Initialize with default products
            window.products = getDefaultProducts();
            saveProductsToFirebase();
          }
          resolve();
        });
      });
    }

    async function loadLocations() {
      return new Promise((resolve) => {
        db.ref('locations').once('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            window.locations = Object.values(data);
          } else {
            window.locations = [
              { id: 'ostbahnhof', name: 'Haferkater Ostbahnhof', active: true },
              { id: 'potsdam', name: 'Haferkater Potsdam', active: true }
            ];
            saveLocationsToFirebase();
          }
          resolve();
        });
      });
    }

    async function loadUsers() {
      return new Promise((resolve) => {
        db.ref('users').once('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            window.users = Object.values(data);
          } else {
            window.users = [
              { 
                username: 'admin', 
                password: 'admin123', 
                role: 'admin', 
                locations: ['ostbahnhof', 'potsdam'], 
                lastLogin: null 
              },
              { 
                username: 'user1', 
                password: 'user123', 
                role: 'inventory', 
                locations: ['ostbahnhof'], 
                lastLogin: null 
              }
            ];
            saveUsersToFirebase();
          }
          resolve();
        });
      });
    }

    async function loadMonthlyData() {
      return new Promise((resolve) => {
        db.ref('monthlyData').once('value', (snapshot) => {
          const data = snapshot.val();
          window.monthlyData = data || {};
          resolve();
        });
      });
    }

    // Save functions with real-time sync
    function saveProductsToFirebase() {
      if (!firebaseInitialized) {
        queueChange('products', window.products);
        return;
      }
      
      syncInProgress = true;
      updateSyncIndicator('syncing');
      
      const productsObj = {};
      window.products.forEach(product => {
        productsObj[product.id] = product;
      });
      
      db.ref('products').set(productsObj)
        .then(() => {
          syncInProgress = false;
          updateSyncIndicator('online');
          console.log('Products saved to Firebase');
        })
        .catch(error => {
          console.error('Error saving products:', error);
          syncInProgress = false;
          updateSyncIndicator('online');
          queueChange('products', window.products);
        });
    }

    function saveLocationsToFirebase() {
      if (!firebaseInitialized) {
        queueChange('locations', window.locations);
        return;
      }
      
      const locationsObj = {};
      window.locations.forEach(location => {
        locationsObj[location.id] = location;
      });
      
      db.ref('locations').set(locationsObj)
        .then(() => console.log('Locations saved to Firebase'))
        .catch(error => {
          console.error('Error saving locations:', error);
          queueChange('locations', window.locations);
        });
    }

    function saveUsersToFirebase() {
      if (!firebaseInitialized) {
        queueChange('users', window.users);
        return;
      }
      
      const usersObj = {};
      window.users.forEach(user => {
        usersObj[user.username] = user;
      });
      
      db.ref('users').set(usersObj)
        .then(() => console.log('Users saved to Firebase'))
        .catch(error => {
          console.error('Error saving users:', error);
          queueChange('users', window.users);
        });
    }

    function saveMonthlyDataToFirebase() {
      if (!firebaseInitialized) return;
      
      db.ref('monthlyData').set(window.monthlyData)
        .then(() => console.log('Monthly data saved to Firebase'))
        .catch(error => console.error('Error saving monthly data:', error));
    }

    function saveCountToFirebase(productId, count) {
      if (!firebaseInitialized) {
        queueChange('count', { productId, count, location: currentLocation, month: currentMonth });
        return;
      }
      
      const updates = {};
      updates[`monthlyData/${currentLocation}/${currentMonth}/counts/${productId}`] = count;
      
      db.ref().update(updates)
        .then(() => console.log('Count updated in Firebase'))
        .catch(error => {
          console.error('Error saving count:', error);
          queueChange('count', { productId, count, location: currentLocation, month: currentMonth });
        });
    }

    // Offline support
    function queueChange(type, data) {
      pendingChanges.push({ type, data, timestamp: Date.now() });
      updateSyncIndicator('offline');
      // Store in localStorage as backup
      localStorage.setItem(`pendingChanges_${type}`, JSON.stringify(data));
    }

    async function syncPendingChanges() {
      if (pendingChanges.length === 0 || syncInProgress) return;
      
      syncInProgress = true;
      updateSyncIndicator('syncing');
      
      for (const change of pendingChanges) {
        try {
          switch (change.type) {
            case 'products':
              await saveProductsToFirebase();
              break;
            case 'locations':
              await saveLocationsToFirebase();
              break;
            case 'users':
              await saveUsersToFirebase();
              break;
            case 'count':
              const updates = {};
              updates[`monthlyData/${change.data.location}/${change.data.month}/counts/${change.data.productId}`] = change.data.count;
              await db.ref().update(updates);
              break;
          }
          // Remove from pending changes
          pendingChanges = pendingChanges.filter(c => c.timestamp !== change.timestamp);
        } catch (error) {
          console.error('Error syncing change:', error);
        }
      }
      
      syncInProgress = false;
      updateSyncIndicator('online');
    }

    function updateSyncIndicator(status) {
      const indicator = document.getElementById('syncIndicator');
      indicator.className = `sync-indicator sync-${status}`;
      indicator.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }

    // ==================== ALL PRODUCTS ====================

    function getDefaultProducts() {
      return [
        // Your existing Trankgourmet products
        { id: '382224', name: 'B1774_Porridgebecher 500St', unit: 'stuck', category: 'Verbrauch', price: 0.075 },
        { id: '252437', name: 'B1774_Deckel Porridge Be.500St', unit: 'stuck', category: 'Verbrauch', price: 0.071 },
        { id: '370981', name: 'B1774_Kaffeebech. 200ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.049 },
        { id: '802049', name: 'B1774_Servietten 5000St', unit: 'stuck', category: 'Verbrauch', price: 0.09 },
        { id: '343306', name: 'B1774_Gro√üe Bowl-Schale 300St', unit: 'stuck', category: 'Verbrauch', price: 0.158 },
        { id: '966396', name: 'B1774_Blockbodenb.klein 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
        { id: '368945', name: 'B1774_Gro√üe Bowl-Deckel 300St', unit: 'stuck', category: 'Verbrauch', price: 0.148 },
        { id: '854238', name: 'B1774_Blockbodenbeu.gro√ü 800St', unit: 'stuck', category: 'Verbrauch', price: 0.043 },
        { id: '340091', name: 'L√ñFFEL HOLZ 16,5CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.027 },
        { id: '317674', name: 'B1774_Kaffe Deckel 90mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.047 },
        { id: '461226', name: 'B1774_Snack-Pap.Zuschn.500St', unit: 'stuck', category: 'Verbrauch', price: 0.187 },
        { id: '448199', name: 'Bechermanschetten braun 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.039 },
        { id: '69636', name: 'B1774_Vitrin.Bowl klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.121 },
        { id: '545740', name: 'Hand.Pap.2lg 25x23 TGQ20x150Bl', unit: 'stuck', category: 'Verbrauch', price: 0.008 },
        { id: '59784', name: 'DECKEL PLA PORTIONSBECHER 2000', unit: 'stuck', category: 'Verbrauch', price: 0.037 },
        { id: '472974', name: 'B1774_Vitri.Deckel.klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.12 },
        { id: '754897', name: 'Sahneabdeckpa.18X24cm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.01 },
        { id: '92548', name: 'MS 120L Stand.blau 25St', unit: 'stuck', category: 'Verbrauch', price: 0.023 },
        { id: '361533', name: 'B1774_Kaffee Bech.300ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.034 },
        { id: '413902', name: 'K√ºchent√ºcher 3lg. TGQ 4x64Bl', unit: 'stuck', category: 'Verbrauch', price: 0.839 },
        { id: '383208', name: 'GABEL HOLZ 16CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.028 },
        { id: '35236', name: 'Dressingbech.30ml transp.100St', unit: 'stuck', category: 'Verbrauch', price: 0.022 },
        { id: '830712', name: 'B1774_Papiertasche klein 250St', unit: 'stuck', category: 'Verbrauch', price: 0.115 },
        { id: '318372', name: 'NITRIL HANDSCH.L WE.PUDE.100ST', unit: 'stuck', category: 'Verbrauch', price: 0.056 },
        { id: '331635', name: 'Deckel DressingCup trans.100St', unit: 'stuck', category: 'Verbrauch', price: 0.017 },
        { id: '105439', name: 'B1774_Kaffe.Deckel 80mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
        { id: '298009', name: 'B1774_Bio Espresso 1kg', unit: 'stuck', category: 'Trockenware', price: 16.761 },
        { id: '896293', name: 'B1774_Bio Granola 4,5kg', unit: 'stuck', category: 'Trockenware', price: 48.532 },
        { id: '768559', name: 'Weizentort.Grill.30cm Fu.18St', unit: 'stuck', category: 'Trockenware', price: 5.99 },
        { id: '959020', name: 'B1774_Bio Apfelmus gew√ºrzt 3kg', unit: 'stuck', category: 'Trockenware', price: 15.445 },
        { id: '118664', name: 'B1774_Hafer bio 25kg', unit: 'stuck', category: 'Trockenware', price: 32.75 },
        { id: '148738', name: 'Bio Ahornsirup TGN 1l', unit: 'stuck', category: 'Trockenware', price: 15.138 },
        { id: '317906', name: 'B1774_Rote Gr√ºtze 3kg', unit: 'stuck', category: 'Trockenware', price: 15.705 },
        { id: '313957', name: 'Viva Con Miwa Leise DPG 0,5l', unit: 'stuck', category: 'Trockenware', price: 0.75 },
        { id: '877743', name: 'Kuv.Tropfen dunkel TGQ 2,5kg', unit: 'stuck', category: 'Trockenware', price: 37.78 },
        { id: '793566', name: 'B1774_Bio Erdnussmus 8kg', unit: 'stuck', category: 'Trockenware', price: 57.3 },
        { id: '438453', name: 'Bio Brotaufstr.medit.Gem. 360g', unit: 'stuck', category: 'Trockenware', price: 3.197 },
        { id: '404403', name: 'B1774_Rotkorn 10kg', unit: 'stuck', category: 'Trockenware', price: 45.75 },
        { id: '495456', name: 'B1774_Haferreis 2,5kg', unit: 'stuck', category: 'Trockenware', price: 6.29 },
        { id: '167742', name: 'Kichererbsen TGQ 2,65l', unit: 'stuck', category: 'Trockenware', price: 3.214 },
        { id: '314664', name: 'Viva Con Miwa Laut DPG 0,5l', unit: 'stuck', category: 'Trockenware', price: 0.75 },
        { id: '185165', name: 'Bio Mandelmus veg. 500g', unit: 'stuck', category: 'Trockenware', price: 12.375 },
        { id: '168702', name: 'Bio Ingwer Kurkuma Shot EW95ml', unit: 'stuck', category: 'Trockenware', price: 1.424 },
        { id: '829463', name: 'Walnusskerne Bruch TGQ 1kg', unit: 'stuck', category: 'Trockenware', price: 9.71 },
        { id: '76407', name: 'Bio H-Milch 3,5% MinusL 1l', unit: 'stuck', category: 'Trockenware', price: 1.724 },
        { id: '720094', name: 'Gomashio W√ºrzmischung Wib.280g', unit: 'stuck', category: 'Trockenware', price: 7.313 },
        { id: '250686', name: 'Bio Ingwer Beeren Shot EW 95ml', unit: 'stuck', category: 'Trockenware', price: 1.424 },
        { id: '727815', name: 'Extaler Miwa Naturell DPG 1l', unit: 'stuck', category: 'Trockenware', price: 0.52 },
        { id: '727143', name: 'Sojasauce Kikko.1l', unit: 'stuck', category: 'Trockenware', price: 7.435 },
        { id: '801642', name: 'Tonys VM Karamel Meers.Tfl.47g', unit: 'stuck', category: 'Trockenware', price: 1.062 },
        { id: '984984', name: 'Bio Zuckerst.hell TGN 500x3,5g', unit: 'stuck', category: 'Trockenware', price: 9.66 },
        { id: '812738', name: 'Bio H-Milch 3,8% TGN 1l', unit: 'stuck', category: 'Trockenware', price: 1.24 },
        { id: '168733', name: 'Bio Bl√ºtenhonig Spend.Imm.350g', unit: 'stuck', category: 'Trockenware', price: 2.854 },
        { id: '610812', name: 'Oliven schw.Schb.TGQ 935ml', unit: 'stuck', category: 'Trockenware', price: 2.703 },
        { id: '764605', name: 'Raspelschokolade ZB Ul.2,5kg', unit: 'stuck', category: 'Trockenware', price: 48.28 },
        { id: '784093', name: 'Bio Agavendicksaft TGN 1,39kg', unit: 'stuck', category: 'Trockenware', price: 8.75 },
        { id: '598394', name: 'Tonys ZB 51% Mandel Tfl.47g', unit: 'stuck', category: 'Trockenware', price: 1.062 },
        { id: '628521', name: 'Kokoschips Nature TGQ 600g', unit: 'stuck', category: 'Trockenware', price: 6.008 },
        { id: '168618', name: 'Oliven√∂l ex.nat. 5l', unit: 'stuck', category: 'Trockenware', price: 51.08 },
        { id: '882410', name: 'Bio Sonnenbl.Ker.gesch.TGN500g', unit: 'stuck', category: 'Trockenware', price: 2.092 },
        { id: '670', name: 'Bio Rohrz.fein-hell TGN 1kg', unit: 'stuck', category: 'Trockenware', price: 2.785 },
        { id: '821922', name: 'Bio Kokosmilch TGN 1l', unit: 'stuck', category: 'Trockenware', price: 3.33 },
        { id: '547116', name: 'Paprika ger√§uchert Wib.270g', unit: 'stuck', category: 'Trockenware', price: 7.94 },
        { id: '182645', name: 'ZITRONENSAFT GLAS EW WE.0,75L', unit: 'stuck', category: 'Trockenware', price: 1.357 },
        { id: '93951', name: 'Vitamin Well Antioxidan EW0,5l', unit: 'stuck', category: 'Trockenware', price: 1.56 },
        { id: '308323', name: 'Vitamin Well Reload EW 0,5l', unit: 'stuck', category: 'Trockenware', price: 1.56 },
        { id: '871225', name: 'Bio Volvic Tee Zitr.EW 0,75l', unit: 'stuck', category: 'Trockenware', price: 1.505 },
        { id: '846238', name: 'Bio Dattelsirup Imm.250ml', unit: 'stuck', category: 'Trockenware', price: 2.27 },
        { id: '6477', name: 'Sonnensalz Speisesalz Esco500g', unit: 'stuck', category: 'Trockenware', price: 0.215 },
        { id: '962589', name: 'Bio Leinsamen braun TGN 1kg', unit: 'stuck', category: 'Trockenware', price: 2.91 },
        { id: '823078', name: 'Orangensaft mit Ff. Elka 250ml', unit: 'stuck', category: 'Trockenware', price: 1.85 },
        { id: '660720', name: 'Sojabohnenpaste Miso AEF.500g', unit: 'stuck', category: 'Trockenware', price: 1.79 },
        { id: '610018', name: 'Backin Backpulver KMF Oet.1kg', unit: 'stuck', category: 'Trockenware', price: 4.955 },
        { id: '883929', name: 'Bio Volvic Tee Pfirs.EW 0,75l', unit: 'stuck', category: 'Trockenware', price: 1.505 },
        { id: '316385', name: 'Assam Schwarztee TGQ 25x1,5g', unit: 'stuck', category: 'Trockenware', price: 1.68 },
        { id: '561296', name: 'Zimt gemahlen TGQ 500g', unit: 'stuck', category: 'Trockenware', price: 7.74 },
        { id: '27169', name: 'B1774_Dinkel-Rog Brot TK14x1kg', unit: 'stuck', category: 'Tk Allgemein', price: 4.01 },
        { id: '47652', name: 'B1774_Karott.Ku.ges.TK12x1600g', unit: 'stuck', category: 'Tk Allgemein', price: 184.14 },
        { id: '151286', name: 'B1774_Ban.BreadSchoko.TK14x1kg', unit: 'stuck', category: 'Tk Allgemein', price: 140.4 },
        { id: '368960', name: 'B1774_Ban.Bread Waln.TK14x1kg', unit: 'stuck', category: 'Tk Allgemein', price: 123.23 },
        { id: '95292', name: 'Falafel geg.vege.TK 1,5kg', unit: 'stuck', category: 'Tk Allgemein', price: 9.38 },
        { id: '875233', name: 'Grillgem√ºse Mediter.TK Sa.1kg', unit: 'stuck', category: 'Tk Allgemein', price: 5.071 },
        { id: '938436', name: 'Eisw√ºrfel Cube TK I.A.2kg', unit: 'stuck', category: 'Tk Allgemein', price: 1.109 },
        { id: '361525', name: 'B1774_Karottenlax vegan TK 3kg', unit: 'stuck', category: 'Tk Allgemein', price: 39.06 },
        { id: '86562', name: 'Edamame gesch√§lt TK GM.1kg', unit: 'stuck', category: 'Tk Allgemein', price: 3.09 },
        { id: '536912', name: 'DPG 6,50 EUR 20 Fl.0,25 +Kiste', unit: 'stuck', category: 'Sammel CM 0', price: 6.5 },
        { id: '887151', name: 'DPG 4,50 EUR 12 Fl.0,25 +Kiste', unit: 'stuck', category: 'Sammel CM 0', price: 4.5 },
        { id: '518470', name: 'DPG 3,00 EUR 12 Fl/Ds 0,25', unit: 'stuck', category: 'Sammel CM 0', price: 3.0 },
        { id: '70297', name: 'DPG 1,50 EUR 6 Fl/Ds 0,25', unit: 'stuck', category: 'Sammel CM 0', price: 1.5 },
        { id: '908177', name: 'LG 0,08 EUR Flasche', unit: 'stuck', category: 'Sammel CM 0', price: 0.08 },
        { id: '436953', name: 'LG 5,10 EUR 24 Fl.0,15 + Kiste', unit: 'stuck', category: 'Sammel CM 0', price: 5.1 },
        { id: '900034', name: 'LG 1,50 EUR Leergutkiste', unit: 'stuck', category: 'Sammel CM 0', price: 1.5 },
        { id: '334068', name: 'Topmatic Clean 5l', unit: 'stuck', category: 'Non Food', price: 41.69 },
        { id: '291662', name: 'Regeneriersalz 500g', unit: 'stuck', category: 'Non Food', price: 1.22 },
        { id: '396219', name: 'Assert Clean 1l', unit: 'stuck', category: 'Non Food', price: 4.0 },
        { id: '773723', name: 'Drysan Oxy 1l', unit: 'stuck', category: 'Non Food', price: 9.97 },
        { id: '236536', name: 'Toipa 2lg Sa.Comf.Hw 8x250Bl', unit: 'stuck', category: 'Non Food', price: 2.66 },
        { id: '304143', name: 'Bio Frischmilch 3,8% ESL 1l', unit: 'stuck', category: 'Frischwaren', price: 1.312 },
        { id: '132609', name: 'B1774_Caesar Mayo. fr. 1kg', unit: 'stuck', category: 'Frischwaren', price: 8.826 },
        { id: '788842', name: 'Violife Greek White Block1,2kg', unit: 'stuck', category: 'Frischwaren', price: 18.55 },
        { id: '988612', name: 'Frischk.Nat.70% TGQ 1,5kg', unit: 'stuck', category: 'Frischwaren', price: 10.78 },
        { id: '96661', name: 'Hummus Classic FR Neni 1kg', unit: 'stuck', category: 'Frischwaren', price: 7.684 },
        { id: '809620', name: 'B1774_Tahin Dressing fr. 1kg', unit: 'stuck', category: 'Frischwaren', price: 13.309 },
        { id: '9280', name: 'B1774_Bal.-Oran. Dress. fr.1kg', unit: 'stuck', category: 'Frischwaren', price: 7.717 },
        { id: '857989', name: 'Bio Porridge Apfel u.Zimt 180g', unit: 'stuck', category: 'Frischwaren', price: 1.418 },
        { id: '943615', name: 'Bio Porridge Blaubeere 180g', unit: 'stuck', category: 'Frischwaren', price: 1.418 },
        { id: '20633', name: 'Bio Tofu natur FR TGN 1,3kg', unit: 'stuck', category: 'Frischwaren', price: 5.06 },
        { id: '892432', name: 'B1774_Honig-Senf Dress. fr.1kg', unit: 'stuck', category: 'Frischwaren', price: 7.91 },
        { id: '514996', name: 'Mozzarella Mini 45% TGQ 125x8g', unit: 'stuck', category: 'Frischwaren', price: 7.33 },
        { id: '198660', name: 'B1774_Bio Dattelw√ºrfel 10kg', unit: 'stuck', category: 'Frischwaren', price: 62.22 },
        { id: '278244', name: 'Bio Tofu ger√§u.FR TGN 1,3kg', unit: 'stuck', category: 'Frischwaren', price: 6.77 },
        { id: '243711', name: 'MANGO.MARA.SMOOTHIE.TRUE.0,25L', unit: 'stuck', category: 'Frischwaren', price: 1.996 },
        { id: '679633', name: 'Tomaten getr.i.√ñl FR TGQ 1,1kg', unit: 'stuck', category: 'Frischwaren', price: 10.67 },
        { id: '243742', name: 'Pink SMOOTHIE TRUE.0,25L', unit: 'stuck', category: 'Frischwaren', price: 2.025 },

        // Gem√ºse Products
        { id: '11410510', name: 'HEIDELBEEREN KG', unit: 'KG', category: 'Gem√ºse', price: 18.05 },
        { id: '11428510', name: 'ERDBEEREN KG', unit: 'KG', category: 'Gem√ºse', price: 132.00 },
        { id: '11428520', name: 'ERDBEEREN NL/BE KG', unit: 'KG', category: 'Gem√ºse', price: 132.00 },
        { id: '11500560', name: 'BIRNE KLEIN KG', unit: 'KG', category: 'Gem√ºse', price: 1.700 },
        { id: '11534560', name: 'APFEL GALA ROYAL GELEGT KG', unit: 'KG', category: 'Gem√ºse', price: 2.080 },
        { id: '11534580', name: 'APFEL BRAEBURN GELEGT KG', unit: 'KG', category: 'Gem√ºse', price: 2.080 },
        { id: '12110510', name: 'BANANEN STANDARD KG', unit: 'KG', category: 'Gem√ºse', price: 1.750 },
        { id: '12110515', name: 'BANANEN STANDARD KISTE 18KG', unit: 'Kiste', category: 'Gem√ºse', price: 14.90 },
        { id: '12371510', name: 'ORANGEN GROSS CA. 300G KG', unit: 'KG', category: 'Gem√ºse', price: 2.080 },
        { id: '12500510', name: 'ZITRONEN ST', unit: 'St√ºck', category: 'Gem√ºse', price: 0.340 },
        { id: '16070510', name: 'GRANATAPFEL ST', unit: 'St√ºck', category: 'Gem√ºse', price: 1890 },
        { id: '16352520', name: 'PHYSALIS 100G SCHALE', unit: 'Schale', category: 'Gem√ºse', price: 1.650 },
        { id: '13330515', name: 'GURKEN 4/5 ER ST', unit: 'St√ºck', category: 'Gem√ºse', price: 1.340 },
        { id: '14581510', name: 'RADIESCHEN OHNE GR√úN KG', unit: 'KG', category: 'Gem√ºse', price: 2.390 },
        { id: '15630510', name: 'TOMATEN STRAUCH KG', unit: 'KG', category: 'Gem√ºse', price: 3.160 },
        { id: '15653515', name: 'TOMATENCHERRYSTRAUCHKISTE', unit: 'Kiste', category: 'Gem√ºse', price: 3.99 },
        { id: '16060510', name: 'INGWER KG', unit: 'KG', category: 'Gem√ºse', price: 4.750 },
        { id: '16310515', name: 'AVOCADO READY TO EAT ST', unit: 'St√ºck', category: 'Gem√ºse', price: 1.430 },
        { id: '13298331', name: 'MINZE 100G PACKUNG', unit: 'Packung', category: 'Gem√ºse', price: 2.3900 },
        { id: '13298334', name: 'KORIANDER 100G PACKUNG', unit: 'Packung', category: 'Gem√ºse', price: 2.3900 },
        { id: '13298340', name: 'BASILIKUM 100G PACKUNG', unit: 'Packung', category: 'Gem√ºse', price: 2.6500 },
        { id: '25048010', name: 'ROTKOHLSTREIFEN1,2-2MM1KGN', unit: 'KG', category: 'Gem√ºse', price: 2.300 },
        { id: '25049020', name: 'ROTKOHLSTREIFEN4-6MM2,5KGR', unit: 'KG', category: 'Gem√ºse', price: 2.300 },
        { id: '25112038', name: 'RUCOLA GEP. EXTRA 0,25KG NAP', unit: 'Packung', category: 'Gem√ºse', price: 2.495 },
        { id: '23148010', name: 'BLATTSALATMIXMONACO1KGNAP', unit: 'KG', category: 'Gem√ºse', price: 5.880 },
        { id: '46005072', name: 'LANDFRISCHK√ÑSE 70% 1,5KG BLD', unit: 'KG', category: 'Gem√ºse', price: 5.600 },
        { id: '46010038', name: 'MOZZARELLAGOURM45%125x8GC Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 7.280 },
        { id: '41001056', name: 'BIOH-MILCH3,5%LAKTOSEFR.10x1 Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 1.560 },
        { id: '30800118', name: 'BARISTAKOKOSNUSSDRINK8x1LAl Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 2.140 },
        { id: '30800210', name: 'HAFERDRINK BARISTA 6x1,5L Oatly Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 1.758 },
        { id: '65008990', name: 'TK EISW√úRFEL 2KG Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 1.437 },
        { id: '55002396', name: 'GREEK WHITE BLK 29% 1,2KG VIOLI Anzahl', unit: 'Anzahl', category: 'Gem√ºse', price: 13.074 },

        // Retail Products
        { id: '60288', name: 'Dr. Quendt Bemmchen 1', unit: 'St√ºck', category: 'Retail', price: 1.931 },
        { id: '42801', name: 'Edel-Hefeflocken konv. 1 f√ºr 200g Pk', unit: 'Packung', category: 'Retail', price: 5.0567 },
        { id: 'TMB07W-00500', name: 'Bio Matcha 500 g Beutel', unit: 'Beutel', category: 'Retail', price: 95.24 },
        { id: 'HK020', name: 'Bio Porridge Topping Tray 1', unit: 'Tray', category: 'Retail', price: 0.84 },
        { id: '2731', name: 'Katerkugel Kirsche - Kakao 1 paket', unit: 'Paket', category: 'Retail', price: 19.14 },
        { id: '2735', name: 'Katerkugel Apfel - Zimt 1 pakt', unit: 'Paket', category: 'Retail', price: 19.14 },
        { id: 'HaGr008', name: 'Bio Hafer Granola Kakao - Crunch 1 (300g)', unit: 'Beutel', category: 'Retail', price: 3.96 },
        { id: 'HaGr007', name: 'Bio Hafer Granola Mandel - Honig 1 (300g)', unit: 'Beutel', category: 'Retail', price: 3.96 },
        { id: '2002-VPE', name: 'VPE 1 Stck - Simply Chai Spicy BIO', unit: 'St√ºck', category: 'Retail', price: 19.1267 },
        { id: 'TS001', name: 'Bio Trinkschokolade, dunkel 1kg', unit: 'KG', category: 'Retail', price: 14.32 },
        { id: 'TS002', name: 'Bio Trinkschokolade, chai 1kg', unit: 'KG', category: 'Retail', price: 14.32 },
        { id: '10122', name: 'Bio Goldlein Protein Pulver - FEIN 1kg', unit: 'KG', category: 'Retail', price: 9.94 },
        { id: 'LoBiCr750', name: 'Lotus Biscoff Crumble 1(750g)', unit: 'Beutel', category: 'Retail', price: 7.145 },
        { id: '0544-100250', name: 'Bio Espresso Entkoffeiniert, gemahlen 1(500g)', unit: 'Beutel', category: 'Retail', price: 11.2967 },
        { id: '18K1257p0110', name: 'Guthabenkarte QR Code, 1', unit: 'St√ºck', category: 'Retail', price: 0.98 }
      ];
    }

    // ==================== UI FUNCTIONS ====================

    function updateUI() {
      updateMonthDisplay();
      displayProducts();
      displayCountingProducts();
      updateSummary();
      updateAnalysis();
    }

    function displayProducts() {
      const tbody = document.getElementById('productList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      const categoryFilter = document.getElementById('categoryFilter')?.value || '';
      const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
      
      let filteredProducts = window.products || [];
      if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
      if (searchTerm) filteredProducts = filteredProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
      
      if (filteredProducts.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `<td colspan="6" style="text-align: center;">No products found</td>`;
        return;
      }
      
      let currentCategory = '';
      filteredProducts.sort((a, b) => {
        if (a.category !== b.category) return a.category.localeCompare(b.category);
        return a.name.localeCompare(b.name);
      }).forEach(product => {
        if (product.category !== currentCategory) {
          currentCategory = product.category;
          const headerRow = tbody.insertRow();
          headerRow.className = 'category-header';
          headerRow.innerHTML = `<td colspan="6">${currentCategory}</td>`;
        }
        
        const row = tbody.insertRow();
        const actionsCell = currentUser?.role === 'admin' ? 
          `<td>
            <button class="edit-btn" onclick="editProduct('${product.id}')">Edit</button>
            <button class="admin-btn" onclick="deleteProduct('${product.id}')">Delete</button>
          </td>` : '';
        
        row.innerHTML = `
          <td>${product.id}</td>
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>${product.unit}</td>
          <td>‚Ç¨${product.price.toFixed(2)}</td>
          ${actionsCell}
        `;
      });
      
      if (document.getElementById('totalProducts')) {
        document.getElementById('totalProducts').textContent = window.products?.length || 0;
        document.getElementById('totalCategories').textContent = [...new Set(window.products?.map(p => p.category))].length || 0;
      }
    }

    function displayCountingProducts() {
      const tbody = document.getElementById('countingList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      const categoryFilter = document.getElementById('countingCategoryFilter')?.value || '';
      const searchTerm = document.getElementById('countingSearch')?.value.toLowerCase() || '';
      
      let filteredProducts = window.products || [];
      if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
      if (searchTerm) filteredProducts = filteredProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
      
      if (filteredProducts.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `<td colspan="6" style="text-align: center;">No products found</td>`;
        return;
      }
      
      // Get counts for current location/month
      const counts = window.monthlyData?.[currentLocation]?.[currentMonth]?.counts || {};
      const isReadOnly = window.monthlyData?.[currentLocation]?.[currentMonth]?.status === 'closed';
      
      let currentCategory = '';
      filteredProducts.sort((a, b) => {
        if (a.category !== b.category) return a.category.localeCompare(b.category);
        return a.name.localeCompare(b.name);
      }).forEach(product => {
        if (product.category !== currentCategory) {
          currentCategory = product.category;
          const headerRow = tbody.insertRow();
          headerRow.className = 'category-header';
          headerRow.innerHTML = `<td colspan="6">${currentCategory}</td>`;
        }
        
        const count = parseFloat(counts[product.id]) || 0;
        const totalValue = count * product.price;
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>${product.unit}</td>
          <td>‚Ç¨${product.price.toFixed(2)}</td>
          <td>
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="decrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>-1</button>
              <button class="decimal-btn" onclick="decrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>-0.1</button>
              <input type="number" class="quantity-input" value="${formatDecimal(count)}" 
                     onchange="setManualCount('${product.id}', this.value)" 
                     onblur="setManualCount('${product.id}', this.value)"
                     min="0" step="0.01" placeholder="0.00" ${isReadOnly ? 'disabled' : ''}>
              <button class="decimal-btn" onclick="incrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>+0.1</button>
              <button class="quantity-btn" onclick="incrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>+1</button>
            </div>
            <div class="custom-increment">
              <input type="number" class="custom-increment-input" id="customIncrement-${product.id}" 
                     placeholder="0.00" step="0.01" min="0.01" ${isReadOnly ? 'disabled' : ''}>
              <button class="custom-increment-btn" onclick="applyCustomIncrement('${product.id}')" ${isReadOnly ? 'disabled' : ''}>Apply</button>
            </div>
          </td>
          <td>‚Ç¨${totalValue.toFixed(2)}</td>
        `;
      });
      
      if (document.getElementById('totalCounted')) {
        const totalCounted = Object.values(counts).reduce((sum, count) => sum + parseFloat(count), 0);
        document.getElementById('totalCounted').textContent = formatDecimal(totalCounted);
      }
    }

    // ==================== PRODUCT MANAGEMENT ====================

    function showAddProductForm() {
      document.getElementById('productModalTitle').textContent = 'Add New Product';
      document.getElementById('modalProductId').value = '';
      document.getElementById('modalProductId').disabled = false;
      document.getElementById('modalProductName').value = '';
      document.getElementById('modalProductCategory').value = '';
      document.getElementById('modalProductUnit').value = '';
      document.getElementById('modalProductPrice').value = '';
      document.getElementById('productModal').style.display = 'flex';
    }

    function editProduct(productId) {
      const product = window.products.find(p => p.id === productId);
      if (product) {
        document.getElementById('productModalTitle').textContent = 'Edit Product';
        document.getElementById('modalProductId').value = product.id;
        document.getElementById('modalProductId').disabled = true;
        document.getElementById('modalProductName').value = product.name;
        document.getElementById('modalProductCategory').value = product.category;
        document.getElementById('modalProductUnit').value = product.unit;
        document.getElementById('modalProductPrice').value = product.price;
        document.getElementById('productModal').style.display = 'flex';
      }
    }

    function saveProduct() {
      const id = document.getElementById('modalProductId').value.trim();
      const name = document.getElementById('modalProductName').value.trim();
      const category = document.getElementById('modalProductCategory').value.trim();
      const unit = document.getElementById('modalProductUnit').value.trim();
      const price = parseFloat(document.getElementById('modalProductPrice').value);
      
      if (!id || !name || !category || !unit || isNaN(price)) {
        alert('Please fill all fields correctly');
        return;
      }
      
      // Check if editing existing product
      const existingIndex = window.products.findIndex(p => p.id === id);
      const newProduct = { id, name, category, unit, price };
      
      if (existingIndex >= 0) {
        // Update existing product
        window.products[existingIndex] = newProduct;
      } else {
        // Add new product
        window.products.push(newProduct);
      }
      
      saveProductsToFirebase();
      closeModal('productModal');
      alert('Product saved successfully');
    }

    function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        window.products = window.products.filter(p => p.id !== productId);
        saveProductsToFirebase();
        
        // Remove from all monthly counts
        Object.keys(window.monthlyData).forEach(location => {
          Object.keys(window.monthlyData[location]).forEach(month => {
            if (window.monthlyData[location][month].counts[productId]) {
              delete window.monthlyData[location][month].counts[productId];
            }
          });
        });
        saveMonthlyDataToFirebase();
      }
    }

    // ==================== QUANTITY FUNCTIONS ====================

    function incrementCount(productId, increment = 1) {
      if (isCountingClosed()) return;
      
      if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
      if (!window.monthlyData[currentLocation][currentMonth]) {
        window.monthlyData[currentLocation][currentMonth] = {
          counts: {},
          created: new Date().toISOString(),
          status: 'open'
        };
      }
      
      const currentCount = parseFloat(window.monthlyData[currentLocation][currentMonth].counts[productId]) || 0;
      const newCount = currentCount + increment;
      window.monthlyData[currentLocation][currentMonth].counts[productId] = newCount;
      
      saveCountToFirebase(productId, newCount);
      updateSummary();
      updateAnalysis();
    }

    function decrementCount(productId, decrement = 1) {
      if (isCountingClosed()) return;
      
      const currentCount = parseFloat(window.monthlyData?.[currentLocation]?.[currentMonth]?.counts?.[productId]) || 0;
      const newCount = Math.max(0, currentCount - decrement);
      
      if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
      if (!window.monthlyData[currentLocation][currentMonth]) {
        window.monthlyData[currentLocation][currentMonth] = {
          counts: {},
          created: new Date().toISOString(),
          status: 'open'
        };
      }
      
      window.monthlyData[currentLocation][currentMonth].counts[productId] = newCount;
      saveCountToFirebase(productId, newCount);
      updateSummary();
      updateAnalysis();
    }

    function setManualCount(productId, value) {
      if (isCountingClosed()) return;
      
      const numValue = parseFloat(value) || 0;
      if (numValue >= 0) {
        if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
        if (!window.monthlyData[currentLocation][currentMonth]) {
          window.monthlyData[currentLocation][currentMonth] = {
            counts: {},
            created: new Date().toISOString(),
            status: 'open'
          };
        }
        
        window.monthlyData[currentLocation][currentMonth].counts[productId] = numValue;
        saveCountToFirebase(productId, numValue);
        updateSummary();
        updateAnalysis();
      }
    }

    function applyCustomIncrement(productId) {
      if (isCountingClosed()) return;
      
      const input = document.getElementById(`customIncrement-${productId}`);
      const value = parseFloat(input.value);
      if (!isNaN(value) && value > 0) {
        incrementCount(productId, value);
        input.value = '';
      }
    }

    // ==================== UTILITY FUNCTIONS ====================

    function formatDecimal(value) {
      const num = parseFloat(value);
      return num % 1 === 0 ? num.toString() : num.toFixed(2);
    }

    function isCountingClosed() {
      const status = window.monthlyData?.[currentLocation]?.[currentMonth]?.status;
      if (status === 'closed') {
        alert('Counting period is closed. No further edits allowed.');
        return true;
      }
      return false;
    }

    function updateCategoryFilter() {
      const categories = [...new Set(window.products?.map(p => p.category))].sort();
      const filter1 = document.getElementById('categoryFilter');
      const filter2 = document.getElementById('countingCategoryFilter');
      
      if (filter1 && filter2) {
        filter1.innerHTML = filter2.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(category => {
          const option1 = document.createElement('option');
          option1.value = category;
          option1.textContent = category;
          filter1.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = category;
          option2.textContent = category;
          filter2.appendChild(option2);
        });
      }
    }

    function filterProducts() {
      displayProducts();
    }

    function filterCountingProducts() {
      displayCountingProducts();
    }

    // ==================== AUTHENTICATION ====================

    function checkProtectionCode() {
      const inputCode = document.getElementById('protectionCode').value.trim();
      const errorMsg = document.getElementById('protectionError');
      
      try {
        const encodedInput = unescape(encodeURIComponent(inputCode));
        const inputHash = btoa(encodedInput).replace(/=/g, '');
        
        if (HASHED_CODES.includes(inputHash)) {
          const sessionData = {
            unlocked: true,
            timestamp: Date.now(),
            expires: Date.now() + (8 * 60 * 60 * 1000)
          };
          
          localStorage.setItem('protectionSession', JSON.stringify(sessionData));
          document.getElementById('protectionOverlay').style.display = 'none';
          showLoginScreen();
        } else {
          errorMsg.textContent = 'Invalid access code';
          errorMsg.style.display = 'block';
          document.getElementById('protectionCode').value = '';
        }
      } catch (error) {
        errorMsg.textContent = 'System error';
        errorMsg.style.display = 'block';
      }
    }

    function showLoginScreen() {
      document.getElementById('protectionOverlay').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('app').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      setTimeout(() => document.getElementById('username').focus(), 100);
    }

    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      const user = window.users.find(u => u.username === username && u.password === password);
      
      if (user) {
        currentUser = user;
        user.lastLogin = new Date().toISOString();
        saveUsersToFirebase();
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        init();
      } else {
        alert('Invalid username or password');
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('app').style.display = 'none';
      localStorage.removeItem('protectionSession');
      initializeProtection();
    }

    // ==================== LOCATION FUNCTIONS ====================

    function setupLocationSelector() {
      const locationSelector = document.getElementById('locationSelector');
      if (!locationSelector) return;
      
      locationSelector.innerHTML = '';
      
      const userLocations = currentUser?.role === 'admin' 
        ? window.locations?.filter(l => l.active) || []
        : window.locations?.filter(l => l.active && currentUser?.locations?.includes(l.id)) || [];
      
      userLocations.forEach(location => {
        const button = document.createElement('button');
        button.className = `location-btn ${location.id === currentLocation ? 'active' : ''}`;
        button.textContent = location.name;
        button.onclick = () => setLocation(location.id);
        locationSelector.appendChild(button);
      });
    }

    function setLocation(locationId) {
      if (!currentUser?.locations?.includes(locationId) && currentUser?.role !== 'admin') {
        alert('No access to this location');
        return;
      }
      
      currentLocation = locationId;
      document.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update real-time listener for new location
      if (db) {
        const monthlyDataRef = db.ref(`monthlyData/${currentLocation}/${currentMonth}`);
        monthlyDataRef.off(); // Remove old listener
        monthlyDataRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
            window.monthlyData[currentLocation][currentMonth] = data;
            if (document.getElementById('counting').classList.contains('active')) {
              displayCountingProducts();
              updateSummary();
              updateAnalysis();
            }
          }
        });
      }
      
      updateUI();
    }

    // ==================== MONTH/YEAR FUNCTIONS ====================

    function setupYearMonthSelectors() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      
      if (!yearSelect || !monthSelect) return;
      
      yearSelect.innerHTML = '<option value="">Select Year</option>';
      for (let year = 2024; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonthNum = today.getMonth() + 1;
      
      yearSelect.value = currentYear;
      updateMonthOptions();
      monthSelect.value = currentMonthNum.toString().padStart(2, '0');
    }

    function updateMonthOptions() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const selectedYear = yearSelect.value;
      
      monthSelect.innerHTML = '<option value="">Select Month</option>';
      
      if (selectedYear) {
        for (let month = 1; month <= 12; month++) {
          const option = document.createElement('option');
          const monthStr = month.toString().padStart(2, '0');
          option.value = `${selectedYear}-${monthStr}`;
          option.textContent = new Date(selectedYear, month - 1).toLocaleString('default', { month: 'long' });
          monthSelect.appendChild(option);
        }
      }
    }

    function changeMonth() {
      const monthSelect = document.getElementById('monthSelect');
      const selectedMonth = monthSelect.value;
      
      if (selectedMonth) {
        currentMonth = selectedMonth;
        
        // Initialize data if it doesn't exist
        if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
        if (!window.monthlyData[currentLocation][currentMonth]) {
          window.monthlyData[currentLocation][currentMonth] = {
            counts: {},
            created: new Date().toISOString(),
            status: 'open'
          };
          saveMonthlyDataToFirebase();
        }
        
        updateUI();
      }
    }

    function updateMonthDisplay() {
      const [year, month] = currentMonth.split('-');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('currentPeriodDisplay').textContent = `${monthNames[parseInt(month) - 1]} ${year}`;
      
      // Update location displays
      const locationName = getLocationDisplayName(currentLocation);
      document.getElementById('locationDisplay').textContent = locationName;
      document.getElementById('analysisLocation').textContent = locationName;
      document.getElementById('summaryLocation').textContent = locationName;
      
      updateCountingStatus();
    }

    function getLocationDisplayName(locationId) {
      const location = window.locations?.find(l => l.id === locationId);
      return location ? location.name : locationId;
    }

    function updateCountingStatus() {
      const today = new Date();
      const [year, month] = currentMonth.split('-');
      const countingDeadline = new Date(year, parseInt(month), 10);
      
      const monthData = window.monthlyData?.[currentLocation]?.[currentMonth];
      
      let status, bannerClass, bannerText;
      
      if (today > countingDeadline && monthData?.status === 'open') {
        monthData.status = 'closed';
        saveMonthlyDataToFirebase();
      }
      
      if (monthData?.status === 'closed') {
        status = 'CLOSED';
        bannerClass = 'status-closed';
        bannerText = `Counting period for ${document.getElementById('currentPeriodDisplay').textContent} is CLOSED. No further edits allowed.`;
        document.getElementById('readonlyOverlay').style.display = 'flex';
      } else {
        status = 'OPEN';
        bannerClass = 'status-open';
        const daysLeft = Math.ceil((countingDeadline - today) / (1000 * 60 * 60 * 24));
        bannerText = `Counting period for ${document.getElementById('currentPeriodDisplay').textContent} is OPEN. ${daysLeft} days left until closing on the 10th of next month.`;
        document.getElementById('readonlyOverlay').style.display = 'none';
      }
      
      document.getElementById('countingStatus').textContent = status;
      const banner = document.getElementById('statusBanner');
      banner.className = `status-banner ${bannerClass}`;
      banner.textContent = bannerText;
    }

    function createNewMonth() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      
      if (!yearSelect.value || !monthSelect.value) {
        alert('Please select both year and month');
        return;
      }
      
      currentMonth = monthSelect.value;
      
      if (window.monthlyData?.[currentLocation]?.[currentMonth]) {
        alert('This month already exists!');
        return;
      }
      
      if (!window.monthlyData[currentLocation]) window.monthlyData[currentLocation] = {};
      window.monthlyData[currentLocation][currentMonth] = {
        counts: {},
        created: new Date().toISOString(),
        status: 'open'
      };
      
      saveMonthlyDataToFirebase();
      updateUI();
      alert(`New counting period created for ${document.getElementById('currentPeriodDisplay').textContent}`);
    }

    // ==================== SUMMARY FUNCTIONS ====================

    function updateSummary() {
      const counts = window.monthlyData?.[currentLocation]?.[currentMonth]?.counts || {};
      const categorySummary = document.getElementById('categorySummary');
      if (!categorySummary) return;
      
      categorySummary.innerHTML = '';
      const categories = {};
      
      window.products?.forEach(product => {
        if (!categories[product.category]) categories[product.category] = { count: 0, value: 0 };
        const count = parseFloat(counts[product.id]) || 0;
        categories[product.category].count += count;
        categories[product.category].value += count * product.price;
      });
      
      Object.keys(categories).sort().forEach(category => {
        const data = categories[category];
        if (data.count > 0) {
          const row = document.createElement('div');
          row.className = 'summary-row';
          row.innerHTML = `<span>${category}:</span><span>${formatDecimal(data.count)} items (‚Ç¨${data.value.toFixed(2)})</span>`;
          categorySummary.appendChild(row);
        }
      });
      
      let totalItems = 0, totalValue = 0;
      Object.keys(counts).forEach(productId => {
        const product = window.products?.find(p => p.id == productId);
        if (product) {
          totalItems += parseFloat(counts[productId]);
          totalValue += parseFloat(counts[productId]) * product.price;
        }
      });
      
      document.getElementById('totalItemsCounted').textContent = formatDecimal(totalItems);
      document.getElementById('totalCountedValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;
    }

    function resetCurrentCounts() {
      if (isCountingClosed()) return;
      
      if (confirm('Are you sure you want to reset all counts for the current period?')) {
        if (window.monthlyData[currentLocation] && window.monthlyData[currentLocation][currentMonth]) {
          window.monthlyData[currentLocation][currentMonth].counts = {};
          saveMonthlyDataToFirebase();
          displayCountingProducts();
          updateSummary();
          updateAnalysis();
        }
      }
    }

    // ==================== ANALYSIS FUNCTIONS ====================

    function updateAnalysis() {
      const counts = window.monthlyData?.[currentLocation]?.[currentMonth]?.counts || {};
      
      let totalValue = 0;
      let itemsCounted = 0;
      const categoryValues = {};
      
      window.products?.forEach(product => {
        const count = parseFloat(counts[product.id]) || 0;
        const value = count * product.price;
        totalValue += value;
        if (count > 0) itemsCounted++;
        
        if (!categoryValues[product.category]) {
          categoryValues[product.category] = 0;
        }
        categoryValues[product.category] += value;
      });
      
      document.getElementById('totalInventoryValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;
      document.getElementById('itemsCounted').textContent = formatDecimal(itemsCounted);
      document.getElementById('totalItems').textContent = window.products?.length || 0;
      
      const avgPrice = itemsCounted > 0 ? totalValue / itemsCounted : 0;
      document.getElementById('avgPrice').textContent = `‚Ç¨${avgPrice.toFixed(2)}`;
      
      let topCategory = '-';
      let topCategoryValue = 0;
      Object.keys(categoryValues).forEach(category => {
        if (categoryValues[category] > topCategoryValue) {
          topCategory = category;
          topCategoryValue = categoryValues[category];
        }
      });
      document.getElementById('topCategory').textContent = topCategory;
      document.getElementById('topCategoryValue').textContent = `‚Ç¨${topCategoryValue.toFixed(2)}`;
      
      const progressPercent = (itemsCounted / (window.products?.length || 1)) * 100;
      document.getElementById('inventoryProgress').style.width = `${progressPercent}%`;
    }

    // ==================== ARCHIVE FUNCTIONS ====================

    function displayArchive() {
      const locationFilter = document.getElementById('archiveLocationFilter')?.value || 'all';
      const yearFilter = document.getElementById('archiveYearFilter')?.value || 'all';
      const tbody = document.getElementById('archiveList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      const locationSelect = document.getElementById('archiveLocationFilter');
      if (locationSelect) {
        locationSelect.innerHTML = '<option value="all">All Locations</option>';
        window.locations?.filter(l => l.active).forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = location.name;
          locationSelect.appendChild(option);
        });
      }
      
      const years = new Set();
      Object.keys(window.monthlyData || {}).forEach(location => {
        Object.keys(window.monthlyData[location] || {}).forEach(month => {
          const year = month.split('-')[0];
          years.add(year);
        });
      });
      
      const yearSelect = document.getElementById('archiveYearFilter');
      if (yearSelect) {
        yearSelect.innerHTML = '<option value="all">All Years</option>';
        Array.from(years).sort().reverse().forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
      }
      
      const archiveEntries = [];
      Object.keys(window.monthlyData || {}).forEach(location => {
        Object.keys(window.monthlyData[location] || {}).forEach(month => {
          const year = month.split('-')[0];
          
          if (locationFilter !== 'all' && location !== locationFilter) return;
          if (yearFilter !== 'all' && year !== yearFilter) return;
          
          const data = window.monthlyData[location][month];
          let totalItems = 0, totalValue = 0;
          Object.keys(data.counts || {}).forEach(productId => {
            const product = window.products?.find(p => p.id == productId);
            if (product) {
              totalItems += parseFloat(data.counts[productId]);
              totalValue += parseFloat(data.counts[productId]) * product.price;
            }
          });
          
          archiveEntries.push({
            location: location,
            month: month,
            totalItems: totalItems,
            totalValue: totalValue,
            status: data.status,
            created: data.created
          });
        });
      });
      
      archiveEntries.sort((a, b) => b.month.localeCompare(a.month));
      
      if (archiveEntries.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `<td colspan="6" style="text-align: center;">No archive data found</td>`;
        return;
      }
      
      archiveEntries.forEach(entry => {
        const row = tbody.insertRow();
        const [year, monthNum] = entry.month.split('-');
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'];
        
        row.innerHTML = `
          <td>${monthNames[parseInt(monthNum) - 1]} ${year}</td>
          <td>${getLocationDisplayName(entry.location)}</td>
          <td>${formatDecimal(entry.totalItems)}</td>
          <td>‚Ç¨${entry.totalValue.toFixed(2)}</td>
          <td><span class="${entry.status === 'open' ? 'status-open' : 'status-closed'}" style="padding: 4px 8px; border-radius: 3px;">${entry.status.toUpperCase()}</span></td>
          <td>
            <button class="decimal-btn" onclick="viewArchive('${entry.location}', '${entry.month}')">View</button>
          </td>
        `;
      });
    }

    function viewArchive(location, month) {
      currentLocation = location;
      currentMonth = month;
      
      // Update selectors
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      if (yearSelect && monthSelect) {
        const [year, monthNum] = month.split('-');
        yearSelect.value = year;
        updateMonthOptions();
        monthSelect.value = currentMonth;
      }
      
      // Update location selector
      document.querySelectorAll('.location-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === getLocationDisplayName(location)) {
          btn.classList.add('active');
        }
      });
      
      updateUI();
      openTab('counting');
    }

    // ==================== ADMIN FUNCTIONS ====================

    function updateUserInterfaceBasedOnRole() {
      if (!currentUser) return;
      
      const isAdmin = currentUser.role === 'admin';
      document.getElementById('userRoleDisplay').textContent = `Role: ${isAdmin ? 'Administrator' : 'Inventory User'}`;
      
      const productManagement = document.getElementById('productManagement');
      const locationManagement = document.getElementById('locationManagement');
      const productActionsHeader = document.getElementById('productActionsHeader');
      
      if (productManagement) productManagement.style.display = isAdmin ? 'block' : 'none';
      if (locationManagement) locationManagement.style.display = isAdmin ? 'block' : 'none';
      if (productActionsHeader) productActionsHeader.style.display = isAdmin ? 'table-cell' : 'none';
      
      document.querySelectorAll('.admin-tab').forEach(el => {
        if (el) el.style.display = isAdmin ? 'block' : 'none';
      });
      
      setupLocationSelector();
    }

    function showAddLocationForm() {
      document.getElementById('locationModalTitle').textContent = 'Add New Location';
      document.getElementById('modalLocationName').value = '';
      document.getElementById('modalLocationId').value = '';
      document.getElementById('locationModal').style.display = 'flex';
    }

    function saveLocation() {
      const name = document.getElementById('modalLocationName').value.trim();
      const id = document.getElementById('modalLocationId').value.trim();
      
      if (!name || !id) {
        alert('Please fill all fields');
        return;
      }
      
      if (window.locations.find(l => l.id === id)) {
        alert('Location ID already exists');
        return;
      }
      
      window.locations.push({ id, name, active: true });
      saveLocationsToFirebase();
      closeModal('locationModal');
      updateLocationSelector();
      alert('Location added successfully');
    }

    function showAddUserForm() {
      document.getElementById('userModalTitle').textContent = 'Add New User';
      document.getElementById('modalUsername').value = '';
      document.getElementById('modalPassword').value = '';
      document.getElementById('modalUserRole').value = 'inventory';
      
      const locationAccessList = document.getElementById('locationAccessList');
      locationAccessList.innerHTML = '';
      
      window.locations?.filter(l => l.active).forEach(location => {
        const div = document.createElement('div');
        div.className = 'location-checkbox';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = location.id;
        checkbox.checked = true;
        checkbox.id = `loc-${location.id}`;
        
        const label = document.createElement('label');
        label.textContent = location.name;
        label.htmlFor = `loc-${location.id}`;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        locationAccessList.appendChild(div);
      });
      
      document.getElementById('userModal').style.display = 'flex';
    }

    function saveUser() {
      const username = document.getElementById('modalUsername').value.trim();
      const password = document.getElementById('modalPassword').value;
      const role = document.getElementById('modalUserRole').value;
      
      if (!username || !password) {
        alert('Please fill all fields');
        return;
      }
      
      if (window.users.find(u => u.username === username)) {
        alert('Username already exists');
        return;
      }
      
      const locationAccess = Array.from(document.querySelectorAll('#locationAccessList input:checked'))
        .map(checkbox => checkbox.value);
      
      window.users.push({
        username,
        password,
        role,
        locations: locationAccess,
        lastLogin: null
      });
      
      saveUsersToFirebase();
      closeModal('userModal');
      showUserManagement();
      alert('User added successfully');
    }

    function showUserManagement() {
      document.getElementById('userManagementSection').style.display = 'block';
      document.getElementById('locationManagementSection').style.display = 'none';
      displayUsers();
    }

    function showLocationManagement() {
      document.getElementById('locationManagementSection').style.display = 'block';
      document.getElementById('userManagementSection').style.display = 'none';
      displayAdminLocations();
    }

    function displayUsers() {
      const tbody = document.getElementById('userList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      window.users?.forEach(user => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${user.username}</td>
          <td>${user.role === 'admin' ? 'Administrator' : 'Inventory User'}</td>
          <td>${user.locations?.map(l => getLocationDisplayName(l)).join(', ') || ''}</td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
          <td>
            <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
            ${user.username !== 'admin' ? `<button class="admin-btn" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
          </td>
        `;
      });
    }

    function displayAdminLocations() {
      const tbody = document.getElementById('adminLocationList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      window.locations?.forEach(location => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${location.name}</td>
          <td>${location.id}</td>
          <td>${location.active ? 'Yes' : 'No'}</td>
          <td>
            <button class="edit-btn" onclick="toggleLocation('${location.id}')">${location.active ? 'Disable' : 'Enable'}</button>
            ${location.id !== 'ostbahnhof' && location.id !== 'potsdam' ? `<button class="admin-btn" onclick="deleteLocation('${location.id}')">Delete</button>` : ''}
          </td>
        `;
      });
    }

    function deleteUser(username) {
      if (username === 'admin') {
        alert('Cannot delete admin user');
        return;
      }
      
      if (confirm(`Are you sure you want to delete user ${username}?`)) {
        window.users = window.users.filter(u => u.username !== username);
        saveUsersToFirebase();
        displayUsers();
      }
    }

    function toggleLocation(locationId) {
      const location = window.locations.find(l => l.id === locationId);
      if (location) {
        location.active = !location.active;
        saveLocationsToFirebase();
        displayAdminLocations();
        updateLocationSelector();
      }
    }

    function deleteLocation(locationId) {
      if (locationId === 'ostbahnhof' || locationId === 'potsdam') {
        alert('Cannot delete default locations');
        return;
      }
      
      if (confirm(`Are you sure you want to delete this location?`)) {
        window.locations = window.locations.filter(l => l.id !== locationId);
        saveLocationsToFirebase();
        displayAdminLocations();
        updateLocationSelector();
      }
    }

    // ==================== TAB FUNCTIONS ====================

    function openTab(tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');
      
      if (tabName === 'analysis') {
        updateAnalysis();
      } else if (tabName === 'archive') {
        displayArchive();
      }
    }

    // ==================== MODAL FUNCTIONS ====================

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // ==================== EXPORT FUNCTIONS ====================

    function exportAllData() {
      const data = {
        products: window.products,
        locations: window.locations,
        users: window.users,
        monthlyData: window.monthlyData,
        exported: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function forceSync() {
      syncPendingChanges();
      alert('Sync initiated. Changes will be synced to all devices.');
    }

    // ==================== INITIALIZATION ====================

    function initializeProtection() {
      const session = localStorage.getItem('protectionSession');
      if (session) {
        try {
          const data = JSON.parse(session);
          if (data.expires > Date.now()) {
            showLoginScreen();
            return;
          }
        } catch (e) {
          localStorage.removeItem('protectionSession');
        }
      }
      
      document.getElementById('protectionOverlay').style.display = 'flex';
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'none';
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeProtection);

  </script>
</body>
</html>
