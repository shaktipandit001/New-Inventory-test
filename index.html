<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Manager</title>
</head>
<body>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            min-width: 150px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .category-header {
            background-color: #f1f8ff !important;
            font-weight: bold;
        }

        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quantity-controls {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .quantity-btn {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: #2980b9;
        }

        .quantity-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .admin-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .admin-btn:hover {
            background: #c0392b;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .add-btn:hover {
            background: #219653;
        }

        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }

        .edit-btn:hover {
            background: #e67e22;
        }

        .count-summary {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #d1e7f7;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .analysis-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .decimal-btn {
            padding: 3px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .custom-increment {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .custom-increment-input {
            width: 60px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .location-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .location-btn {
            padding: 10px 20px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .location-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .status-banner {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-open {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .readonly-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .relative-container {
            position: relative;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-form button {
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .admin-only {
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
        }

        .user-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .location-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
            text-align: center;
        }

        .protection-code {
            background: white;
            padding: 30px;
            border-radius: 10px;
            color: #333;
            max-width: 400px;
            width: 90%;
        }

        .protection-code input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #3498db;
            border-radius: 5px;
            font-size: 1.2rem;
            text-align: center;
        }

        .protection-code button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .stats, .filters, .month-selector {
                flex-direction: column;
            }
            
            .analysis-grid, .user-management {
                grid-template-columns: 1fr;
            }
            
            .quantity-controls {
                flex-wrap: wrap;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Protection Overlay -->
    <div id="protectionOverlay" class="protection-overlay">
        <div class="protection-code">
            <h2>üîí Shakti Featuring Protection</h2>
            <h3>Inventory System Access</h3>
            <p>Enter security code to continue</p>
            <input type="password" id="protectionCode" placeholder="Enter access code" autocomplete="off" onkeypress="if(event.key === 'Enter') checkProtectionCode()">
            <button onclick="checkProtectionCode()">Unlock System</button>
            <p id="protectionError" style="color: red; display: none; margin-top: 10px;">Invalid access code</p>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #666;">
                <p><strong>System Security:</strong> Created by Shakti Pandit</p>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container" style="display: none;">
        <h2>Inventory System Login</h2>
        <div class="login-form">
            <input type="text" id="username" placeholder="Username" value="" autocomplete="off">
            <input type="password" id="password" placeholder="Password" value="" autocomplete="new-password">
            <button onclick="login()">Login</button>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <p><strong>Made by Shakti :</strong></p>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <!-- Main App Content -->
        <header>
            <div class="header-content">
                <div>
                    <h1>Inventory Tracker</h1>
                    <p class="subtitle">Professional Inventory Management System</p>
                </div>
                <div class="user-info">
                    <div class="user-role" id="userRoleDisplay">Role: Loading...</div>
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalProducts">0</div>
                            <div class="stat-label">Products</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalCategories">0</div>
                            <div class="stat-label">Categories</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalCounted">0</div>
                            <div class="stat-label">Counted Items</div>
                        </div>
                    </div>
                    <button class="admin-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Location Selector -->
        <div class="section">
            <h3>Select Location</h3>
            <div class="location-selector" id="locationSelector">
                <!-- Locations will be dynamically added -->
            </div>
            <div id="locationManagement" style="display: none;">
                <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
            </div>
        </div>

        <!-- Month Selector and Status -->
        <div class="section">
            <div class="month-selector">
                <div>
                    <strong>Current Period:</strong> 
                    <span id="currentPeriodDisplay"></span>
                </div>
                <div>
                    <strong>Status:</strong> 
                    <span id="countingStatus"></span>
                </div>
                <select id="yearSelect" onchange="updateMonthOptions()">
                    <option value="">Select Year</option>
                </select>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="">Select Month</option>
                </select>
                <button class="quantity-btn" onclick="createNewMonth()">Start New Month</button>
            </div>
            <div id="statusBanner" class="status-banner"></div>
        </div>

        <div class="tab-navigation">
            <button class="tab-button active" onclick="openTab('counting')">Quantity Counting</button>
            <button class="tab-button" onclick="openTab('products')">All Products</button>
            <button class="tab-button" onclick="openTab('analysis')">Analysis</button>
            <button class="tab-button" onclick="openTab('summary')">Count Summary</button>
            <button class="tab-button" onclick="openTab('archive')">Monthly Archive</button>
            <button class="tab-button admin-tab" onclick="openTab('activity')" style="display: none;">Activity Log</button>
            <button class="tab-button admin-tab" onclick="openTab('admin')" style="display: none;">Admin Panel</button>
        </div>

        <!-- Counting Tab -->
        <div id="counting" class="tab-content active">
            <div class="section relative-container">
                <div id="readonlyOverlay" class="readonly-overlay" style="display: none;">
                    Counting Period Closed - Read Only Mode
                </div>
                <h2>Quantity Counting - <span id="locationDisplay"></span></h2>
                <p>Use the buttons or type directly in the input field to adjust quantities. Supports any decimal values.</p>
                <div class="filters">
                    <select id="countingCategoryFilter" onchange="filterCountingProducts()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" id="countingSearch" placeholder="Search products..." onkeyup="filterCountingProducts()">
                </div>
                <table id="countingTable">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Price (‚Ç¨)</th>
                            <th>Quantity</th>
                            <th>Total Value</th>
                        </tr>
                    </thead>
                    <tbody id="countingList"></tbody>
                </table>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="section">
                <h2>Complete Product Catalog</h2>
                <div id="productManagement" style="margin-bottom: 15px; display: none;">
                    <button class="add-btn" onclick="showAddProductForm()">Add New Product</button>
                </div>
                <div class="filters">
                    <select id="categoryFilter" onchange="filterProducts()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()">
                </div>
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Unit</th>
                            <th>Price (‚Ç¨)</th>
                            <th id="productActionsHeader" style="display: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="section">
                <h2>Inventory Analysis - <span id="analysisLocation"></span></h2>
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Total Inventory Value</h4>
                        <div class="analysis-value" id="totalInventoryValue">‚Ç¨0.00</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="inventoryProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="analysis-card">
                        <h4>Most Valuable Category</h4>
                        <div class="analysis-value" id="topCategory">-</div>
                        <div id="topCategoryValue">‚Ç¨0.00</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Average Price per Item</h4>
                        <div class="analysis-value" id="avgPrice">‚Ç¨0.00</div>
                    </div>
                    <div class="analysis-card">
                        <h4>Items Counted</h4>
                        <div class="analysis-value" id="itemsCounted">0</div>
                        <div>out of <span id="totalItems">0</span> products</div>
                    </div>
                </div>
                <div class="chart-container">
                    <h4>Inventory Value by Category</h4>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Top 10 Most Valuable Products</h4>
                    <canvas id="topProductsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="section">
                <h2>Count Summary - <span id="summaryLocation"></span></h2>
                <div class="count-summary">
                    <h3>Summary by Category</h3>
                    <div id="categorySummary"></div>
                    <button class="reset-btn" onclick="resetCurrentCounts()">Reset Current Counts</button>
                </div>
                <div class="count-summary" style="margin-top: 20px;">
                    <h3>Total Counted Items</h3>
                    <div class="summary-row">
                        <span>Total Items Counted:</span>
                        <span id="totalItemsCounted">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Total Value:</span>
                        <span id="totalCountedValue">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archive Tab -->
        <div id="archive" class="tab-content">
            <div class="section">
                <h2>Monthly Archive</h2>
                <div class="filters">
                    <select id="archiveLocationFilter" onchange="displayArchive()">
                        <option value="all">All Locations</option>
                    </select>
                    <select id="archiveYearFilter" onchange="displayArchive()">
                        <option value="all">All Years</option>
                    </select>
                </div>
                <table id="archiveTable" class="archive-table">
                    <thead>
                        <tr>
                            <th>Month/Year</th>
                            <th>Location</th>
                            <th>Total Items</th>
                            <th>Total Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="archiveList"></tbody>
                </table>
            </div>
        </div>

        <!-- Activity Log Tab -->
        <div id="activity" class="tab-content">
            <div class="section admin-only">
                <h2>üìù Activity Log - User Actions Tracker</h2>
                <div class="filters">
                    <select id="activityUserFilter" onchange="displayActivityLog()">
                        <option value="all">All Users</option>
                    </select>
                    <select id="activityActionFilter" onchange="displayActivityLog()">
                        <option value="all">All Actions</option>
                        <option value="login">User Login</option>
                        <option value="logout">User Logout</option>
                        <option value="count_update">Quantity Change</option>
                        <option value="product_add">Product Added</option>
                        <option value="product_edit">Product Edited</option>
                        <option value="product_delete">Product Deleted</option>
                        <option value="user_add">User Added</option>
                        <option value="user_edit">User Edited</option>
                        <option value="user_delete">User Deleted</option>
                        <option value="location_add">Location Added</option>
                        <option value="count_reset">Counts Reset</option>
                        <option value="month_create">New Month Created</option>
                        <option value="data_export">Data Exported</option>
                    </select>
                    <select id="activityTimeFilter" onchange="displayActivityLog()">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="quantity-btn" onclick="exportActivityLog()">Export Log</button>
                    <button class="admin-btn" onclick="clearActivityLog()" style="margin-left: auto;">Clear Log</button>
                </div>
                
                <div class="stats" style="margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="stat-value" id="totalActivities">0</div>
                        <div class="stat-label">Total Activities</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="todayActivities">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeUsersCount">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
                
                <div style="max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                    <table>
                        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                            <tr>
                                <th>Time</th>
                                <th>User (Role)</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Location</th>
                                <th>Month</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogList"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
                    <p>üìä <strong>Activity Tracking Active</strong> - All user actions are being recorded</p>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="tab-content">
            <div class="section admin-only">
                <h2>Admin Panel</h2>
                <div class="user-management">
                    <div class="user-card admin">
                        <h4>System Administration</h4>
                        <p>Manage users, locations, and system settings</p>
                        <button class="admin-btn" onclick="showUserManagement()">Manage Users</button>
                        <button class="admin-btn" onclick="showLocationManagement()">Manage Locations</button>
                    </div>
                    <div class="user-card">
                        <h4>Data Management</h4>
                        <p>Export and backup system data</p>
                        <button class="quantity-btn" onclick="exportCurrentInventory()">Export Current Inventory</button>
                        <button class="quantity-btn" onclick="exportAllData()" style="margin-top: 10px;">Export All System Data</button>
                    </div>
                </div>

                <div id="userManagementSection" style="display: none; margin-top: 30px;">
                    <h3>User Management</h3>
                    <div class="filters">
                        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                        <button class="add-btn" onclick="showAddUserForm()">Add New User</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Location Access</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userList"></tbody>
                    </table>
                </div>

                <div id="locationManagementSection" style="display: none; margin-top: 30px;">
                    <h3>Location Management</h3>
                    <div class="filters">
                        <input type="text" id="locationSearch" placeholder="Search locations..." onkeyup="filterLocations()">
                        <button class="add-btn" onclick="showAddLocationForm()">Add New Location</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Location Name</th>
                                <th>Location ID</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminLocationList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add New Product</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Product ID:</label>
                <input type="text" id="modalProductId" placeholder="Unique ID">
            </div>
            <div class="form-group">
                <label>Product Name:</label>
                <input type="text" id="modalProductName" placeholder="Product name">
            </div>
            <div class="form-group">
                <label>Category:</label>
                <input type="text" id="modalProductCategory" placeholder="Category">
            </div>
            <div class="form-group">
                <label>Unit:</label>
                <input type="text" id="modalProductUnit" placeholder="Unit (stuck, kartoon, etc.)">
            </div>
            <div class="form-group">
                <label>Price (‚Ç¨):</label>
                <input type="number" id="modalProductPrice" step="0.01" min="0" placeholder="0.00">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveProduct()">Save Product</button>
                <button class="admin-btn" onclick="closeModal('productModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="locationModalTitle">Add New Location</h3>
                <button class="modal-close" onclick="closeModal('locationModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Location Name:</label>
                <input type="text" id="modalLocationName" placeholder="Location name">
            </div>
            <div class="form-group">
                <label>Location ID:</label>
                <input type="text" id="modalLocationId" placeholder="Unique ID (e.g., 'potsdam')">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveLocation()">Save Location</button>
                <button class="admin-btn" onclick="closeModal('locationModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add New User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="modalUsername" placeholder="Username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="modalPassword" placeholder="Password">
            </div>
            <div class="form-group">
                <label>Role:</label>
                <select id="modalUserRole">
                    <option value="inventory">Inventory User (Count Only)</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <div class="form-group">
                <label>Location Access:</label>
                <div id="locationAccessList">
                    <!-- Locations will be dynamically added -->
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="add-btn" onclick="saveUser()">Save User</button>
                <button class="admin-btn" onclick="closeModal('userModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIXED PROTECTION SYSTEM ====================
        const PROTECTION_CODES = [
            'BFS2024INV',    // Main code
            'SHAKTIINV24',   // Backup code  
            'FOODSERVICES',  // Emergency code
            'HAFERKATER',    // Additional code
            'INVENTORY2024'  // Year-specific code
        ];

        // Pre-hash the codes for faster comparison
        const HASHED_CODES = PROTECTION_CODES.map(code => 
            btoa(unescape(encodeURIComponent(code))).replace(/=/g, '')
        );

        function initializeProtection() {
            console.log('Initializing protection system...');
            
            // Hide everything first
            document.getElementById('protectionOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'none';
            
            // Check session storage first (short-term)
            const sessionUnlocked = sessionStorage.getItem('systemUnlocked');
            if (sessionUnlocked === 'true') {
                console.log('Session unlocked - showing login screen');
                showLoginScreen();
                return;
            }
            
            // Check localStorage for longer-term session
            const protectionSession = localStorage.getItem('protectionSession');
            if (protectionSession) {
                try {
                    const session = JSON.parse(protectionSession);
                    if (session.expires && session.expires > Date.now()) {
                        console.log('Valid session found in localStorage');
                        showLoginScreen();
                        return;
                    } else {
                        console.log('Session expired - clearing');
                        localStorage.removeItem('protectionSession');
                        sessionStorage.removeItem('systemUnlocked');
                    }
                } catch (e) {
                    console.error('Invalid session data:', e);
                    localStorage.removeItem('protectionSession');
                    sessionStorage.removeItem('systemUnlocked');
                }
            }
            
            // If no valid session, show protection screen
            console.log('No valid session - showing protection screen');
            document.getElementById('protectionOverlay').style.display = 'flex';
            document.getElementById('protectionCode').value = '';
            document.getElementById('protectionError').style.display = 'none';
            
            // Focus on input field
            setTimeout(() => {
                const input = document.getElementById('protectionCode');
                if (input) input.focus();
            }, 100);
        }

        function checkProtectionCode() {
            const inputCode = document.getElementById('protectionCode').value.trim();
            const errorMsg = document.getElementById('protectionError');
            
            // Clear any previous error
            errorMsg.style.display = 'none';
            
            if (!inputCode) {
                errorMsg.textContent = 'Please enter an access code';
                errorMsg.style.display = 'block';
                return;
            }
            
            try {
                // Encode the input properly before converting to base64
                const encodedInput = unescape(encodeURIComponent(inputCode));
                const inputHash = btoa(encodedInput).replace(/=/g, '');
                
                console.log('Checking code (first 3 chars):', inputCode.substring(0, 3) + '...');
                
                // Check against stored hashes
                if (HASHED_CODES.includes(inputHash)) {
                    console.log('Access granted!');
                    
                    // Create session data
                    const sessionData = {
                        unlocked: true,
                        timestamp: Date.now(),
                        expires: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                    };
                    
                    // Save to storage
                    localStorage.setItem('protectionSession', JSON.stringify(sessionData));
                    sessionStorage.setItem('systemUnlocked', 'true');
                    
                    // Hide protection overlay
                    document.getElementById('protectionOverlay').style.display = 'none';
                    errorMsg.style.display = 'none';
                    
                    // Show login screen
                    showLoginScreen();
                } else {
                    console.log('Access denied - invalid code');
                    errorMsg.textContent = 'Invalid access code. Please try again.';
                    errorMsg.style.display = 'block';
                    document.getElementById('protectionCode').value = '';
                    document.getElementById('protectionCode').focus();
                    
                    // Clear error after 3 seconds
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error checking code:', error);
                errorMsg.textContent = 'System error. Please try again.';
                errorMsg.style.display = 'block';
            }
        }

        function showLoginScreen() {
            console.log('Showing login screen');
            document.getElementById('protectionOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            
            // Clear login fields
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Focus on username field
            setTimeout(() => {
                document.getElementById('username').focus();
            }, 100);
        }

        // ==================== INVENTORY CODE ====================
        let products = JSON.parse(localStorage.getItem('inventoryProducts')) || [];
        let locations = JSON.parse(localStorage.getItem('inventoryLocations')) || [
            { id: 'ostbahnhof', name: 'Haferkater Ostbahnhof', active: true },
            { id: 'potsdam', name: 'Haferkater Potsdam', active: true }
        ];
        let users = JSON.parse(localStorage.getItem('inventoryUsers')) || [
            { username: 'admin', password: 'admin123', role: 'admin', locations: ['ostbahnhof', 'potsdam'], lastLogin: null },
            { username: 'user1', password: 'user123', role: 'inventory', locations: ['ostbahnhof'], lastLogin: null }
        ];
        let monthlyData = JSON.parse(localStorage.getItem('monthlyInventoryData')) || {};
        let currentUser = null;
        let currentLocation = 'ostbahnhof';
        let currentMonth = '';
        let firebaseInitialized = false;

        // ==================== ACTIVITY TRACKING ====================
        let activityLogs = JSON.parse(localStorage.getItem('inventoryActivityLogs')) || [];

        // Log user activity
        function logActivity(action, details = {}) {
            if (!currentUser) return;
            
            const activity = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                user: currentUser.username,
                userRole: currentUser.role,
                location: currentLocation,
                month: currentMonth,
                action: action,
                details: details,
                ip: 'tracked'
            };
            
            console.log('Activity logged:', activity);
            
            // Save to Firebase if initialized
            if (firebaseInitialized) {
                try {
                    firebase.database().ref(`activity_logs/${activity.id}`).set(activity)
                        .then(() => console.log('Activity saved to Firebase'))
                        .catch(error => console.error('Firebase save error:', error));
                } catch (error) {
                    console.error('Firebase error:', error);
                }
            }
            
            // Save locally
            activityLogs.unshift(activity); // Add to beginning
            if (activityLogs.length > 1000) activityLogs = activityLogs.slice(0, 1000); // Keep only last 1000
            localStorage.setItem('inventoryActivityLogs', JSON.stringify(activityLogs));
            
            // Update display if on activity tab
            if (document.getElementById('activity')?.classList.contains('active')) {
                displayActivityLog();
            }
        }

        // Initialize the app
        function init() {
            console.log('Initializing inventory app...');
            if (products.length === 0) {
                importAllProducts();
            }
            setupLocationSelector();
            updateCategoryFilter();
            setupYearMonthSelectors();
            setCurrentMonth();
            updateUI();
            displayArchive();
            updateUserInterfaceBasedOnRole();
        }

        // Firebase initialization (called only after successful login)
        function initializeFirebase() {
            if (firebaseInitialized) {
                console.log('Firebase already initialized');
                return;
            }
            
            try {
                console.log('Initializing Firebase...');
                const firebaseConfig = {
                    apiKey: "AIzaSyCvENxXAfEqgegtr5RFIYcolV_eURTcbzA",
                    authDomain: "invbfs.firebaseapp.com",
                    databaseURL: "https://invbfs-default-rtdb.firebaseio.com",
                    projectId: "invbfs",
                    storageBucket: "invbfs.appspot.com",
                    messagingSenderId: "183500505178",
                    appId: "1:183500505178:web:0ca737b5d200005bbc9863"
                };

                // Check if Firebase is already initialized
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase initialized successfully');
                } else {
                    console.log('Firebase already initialized');
                }
                
                firebaseInitialized = true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Warning: Firebase initialization failed. Some features may not work.');
            }
        }

        // Login system
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                console.log('Login successful for user:', username);
                currentUser = user;
                user.lastLogin = new Date().toISOString();
                saveUsers();
                
                // Log login activity
                logActivity('login', { 
                    username: username, 
                    role: user.role,
                    locations: user.locations 
                });
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Initialize Firebase after successful login
                initializeFirebase();
                init();
            } else {
                alert('Invalid username or password');
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }

        function logout() {
            // Log logout activity
            if (currentUser) {
                logActivity('logout', { username: currentUser.username });
            }
            
            console.log('Logging out...');
            currentUser = null;
            firebaseInitialized = false;
            
            // Clear all sessions
            sessionStorage.removeItem('systemUnlocked');
            localStorage.removeItem('protectionSession');
            
            // Show protection screen
            initializeProtection();
        }

        function updateUserInterfaceBasedOnRole() {
            if (!currentUser) return;
            
            const isAdmin = currentUser.role === 'admin';
            document.getElementById('userRoleDisplay').textContent = `Role: ${isAdmin ? 'Administrator' : 'Inventory User'}`;
            document.getElementById('productManagement').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('locationManagement').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('productActionsHeader').style.display = isAdmin ? 'table-cell' : 'none';
            
            // Show admin tabs
            document.querySelectorAll('.admin-tab').forEach(el => {
                el.style.display = isAdmin ? 'block' : 'none';
            });
            
            updateLocationSelector();
        }

        // Enhanced Month/Year selection
        function setupYearMonthSelectors() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            for (let year = 2024; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonthNum = today.getMonth() + 1;
            
            yearSelect.value = currentYear;
            updateMonthOptions();
            monthSelect.value = currentMonthNum.toString().padStart(2, '0');
        }

        function updateMonthOptions() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            const selectedYear = yearSelect.value;
            
            monthSelect.innerHTML = '<option value="">Select Month</option>';
            
            if (selectedYear) {
                for (let month = 1; month <= 12; month++) {
                    const option = document.createElement('option');
                    const monthStr = month.toString().padStart(2, '0');
                    option.value = `${selectedYear}-${monthStr}`;
                    option.textContent = new Date(selectedYear, month - 1).toLocaleString('default', { month: 'long' });
                    monthSelect.appendChild(option);
                }
            }
        }

        function changeMonth() {
            const monthSelect = document.getElementById('monthSelect');
            const selectedMonth = monthSelect.value;
            
            if (selectedMonth) {
                currentMonth = selectedMonth;
                const key = `${currentLocation}|${currentMonth}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        counts: {},
                        created: new Date().toISOString(),
                        status: 'open'
                    };
                    saveMonthlyData();
                }
                
                updateUI();
            }
        }

        function setCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            currentMonth = `${year}-${month}`;
            
            const key = `${currentLocation}|${currentMonth}`;
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
                saveMonthlyData();
            }
            
            document.getElementById('yearSelect').value = year;
            updateMonthOptions();
            document.getElementById('monthSelect').value = currentMonth;
            
            updateMonthDisplay();
        }

        function createNewMonth() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            if (!yearSelect.value || !monthSelect.value) {
                alert('Please select both year and month');
                return;
            }
            
            currentMonth = monthSelect.value;
            const key = `${currentLocation}|${currentMonth}`;
            
            if (monthlyData[key]) {
                alert('This month already exists!');
                return;
            }
            
            monthlyData[key] = {
                counts: {},
                created: new Date().toISOString(),
                status: 'open'
            };
            
            saveMonthlyData();
            
            // Log new month creation
            logActivity('month_create', {
                location: currentLocation,
                month: currentMonth,
                createdBy: currentUser.username
            });
            
            updateUI();
            alert(`New counting period created for ${formatMonthDisplay(currentMonth)}`);
        }

        function updateMonthDisplay() {
            document.getElementById('currentPeriodDisplay').textContent = formatMonthDisplay(currentMonth);
            document.getElementById('locationDisplay').textContent = getLocationDisplayName(currentLocation);
            document.getElementById('analysisLocation').textContent = getLocationDisplayName(currentLocation);
            document.getElementById('summaryLocation').textContent = getLocationDisplayName(currentLocation);
            
            updateCountingStatus();
        }

        function updateCountingStatus() {
            const today = new Date();
            const [year, month] = currentMonth.split('-');
            const countingDeadline = new Date(year, parseInt(month), 10);
            
            const key = `${currentLocation}|${currentMonth}`;
            const monthData = monthlyData[key];
            
            let status, bannerClass, bannerText;
            
            if (today > countingDeadline && monthData.status === 'open') {
                monthData.status = 'closed';
                saveMonthlyData();
            }
            
            if (monthData.status === 'closed') {
                status = 'CLOSED';
                bannerClass = 'status-closed';
                bannerText = `Counting period for ${formatMonthDisplay(currentMonth)} is CLOSED. No further edits allowed.`;
                document.getElementById('readonlyOverlay').style.display = 'flex';
            } else {
                status = 'OPEN';
                bannerClass = 'status-open';
                const daysLeft = Math.ceil((countingDeadline - today) / (1000 * 60 * 60 * 24));
                bannerText = `Counting period for ${formatMonthDisplay(currentMonth)} is OPEN. ${daysLeft} days left until closing on the 10th of next month.`;
                document.getElementById('readonlyOverlay').style.display = 'none';
            }
            
            document.getElementById('countingStatus').textContent = status;
            const banner = document.getElementById('statusBanner');
            banner.className = `status-banner ${bannerClass}`;
            banner.textContent = bannerText;
        }

        // Location management
        function setupLocationSelector() {
            updateLocationSelector();
        }

        function updateLocationSelector() {
            const locationSelector = document.getElementById('locationSelector');
            locationSelector.innerHTML = '';
            
            const userLocations = currentUser.role === 'admin' 
                ? locations.filter(l => l.active)
                : locations.filter(l => l.active && currentUser.locations.includes(l.id));
            
            userLocations.forEach(location => {
                const button = document.createElement('button');
                button.className = `location-btn ${location.id === currentLocation ? 'active' : ''}`;
                button.textContent = location.name;
                button.onclick = function() {
                    setLocation(location.id);
                };
                locationSelector.appendChild(button);
            });
        }

        // FIXED: setLocation function
        function setLocation(locationId) {
            if (!currentUser.locations.includes(locationId) && currentUser.role !== 'admin') {
                alert('You do not have access to this location');
                return;
            }
            
            currentLocation = locationId;
            
            // Remove active class from all location buttons
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the clicked button
            const locationSelector = document.getElementById('locationSelector');
            const buttons = locationSelector.getElementsByClassName('location-btn');
            for (let i = 0; i < buttons.length; i++) {
                if (buttons[i].textContent === getLocationDisplayName(locationId)) {
                    buttons[i].classList.add('active');
                    break;
                }
            }
            
            // Initialize data for this location and month if it doesn't exist
            const key = `${currentLocation}|${currentMonth}`;
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
                saveMonthlyData();
            }
            
            updateUI();
        }

        // Product management
        function showAddProductForm() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('modalProductId').value = '';
            document.getElementById('modalProductId').disabled = false;
            document.getElementById('modalProductName').value = '';
            document.getElementById('modalProductCategory').value = '';
            document.getElementById('modalProductUnit').value = '';
            document.getElementById('modalProductPrice').value = '';
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            const id = document.getElementById('modalProductId').value.trim();
            const name = document.getElementById('modalProductName').value.trim();
            const category = document.getElementById('modalProductCategory').value.trim();
            const unit = document.getElementById('modalProductUnit').value.trim();
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            
            if (!id || !name || !category || !unit || isNaN(price)) {
                alert('Please fill all fields correctly');
                return;
            }
            
            const existingProduct = products.find(p => p.id === id);
            
            if (existingProduct) {
                // Update existing product
                const oldData = { ...existingProduct };
                existingProduct.name = name;
                existingProduct.category = category;
                existingProduct.unit = unit;
                existingProduct.price = price;
                
                // Log edit activity
                logActivity('product_edit', {
                    productId: id,
                    changes: {
                        name: { old: oldData.name, new: name },
                        category: { old: oldData.category, new: category },
                        unit: { old: oldData.unit, new: unit },
                        price: { old: oldData.price, new: price }
                    }
                });
            } else {
                // Add new product
                products.push({ id, name, category, unit, price });
                
                // Log add activity
                logActivity('product_add', {
                    productId: id,
                    productName: name,
                    category: category,
                    unit: unit,
                    price: price
                });
            }
            
            saveProducts();
            closeModal('productModal');
            displayProducts();
            updateCategoryFilter();
            alert(existingProduct ? 'Product updated successfully' : 'Product added successfully');
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`Are you sure you want to delete "${product.name}"?`)) {
                // Log delete activity
                logActivity('product_delete', {
                    productId: productId,
                    productName: product.name,
                    category: product.category,
                    price: product.price
                });
                
                products = products.filter(p => p.id !== productId);
                saveProducts();
                displayProducts();
                Object.keys(monthlyData).forEach(key => {
                    if (monthlyData[key].counts[productId]) {
                        delete monthlyData[key].counts[productId];
                    }
                });
                saveMonthlyData();
            }
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('modalProductId').value = product.id;
                document.getElementById('modalProductId').disabled = true;
                document.getElementById('modalProductName').value = product.name;
                document.getElementById('modalProductCategory').value = product.category;
                document.getElementById('modalProductUnit').value = product.unit;
                document.getElementById('modalProductPrice').value = product.price;
                document.getElementById('productModal').style.display = 'flex';
            }
        }

        function updateCategoryFilter() {
            const filter1 = document.getElementById('categoryFilter');
            const filter2 = document.getElementById('countingCategoryFilter');
            filter1.innerHTML = filter2.innerHTML = '<option value="">All Categories</option>';
            const categories = [...new Set(products.map(p => p.category))].sort();
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                filter1.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                filter2.appendChild(option2);
            });
        }

        // Display counting products - FIXED: Properly uses current location and month
        function displayCountingProducts() {
            const tbody = document.getElementById('countingList');
            tbody.innerHTML = '';
            const categoryFilter = document.getElementById('countingCategoryFilter').value;
            const searchTerm = document.getElementById('countingSearch').value.toLowerCase();
            
            let filteredProducts = products;
            if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            if (searchTerm) filteredProducts = filteredProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align: center;">No products found</td>`;
                return;
            }
            
            // KEY FIX: Always use currentLocation and currentMonth
            const key = `${currentLocation}|${currentMonth}`;
            
            // Make sure data exists for this location/month
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
                saveMonthlyData();
            }
            
            const currentCounts = monthlyData[key].counts || {};
            const isReadOnly = monthlyData[key].status === 'closed';
            
            let currentCategory = '';
            filteredProducts.sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.name.localeCompare(b.name);
            }).forEach(product => {
                if (product.category !== currentCategory) {
                    currentCategory = product.category;
                    const headerRow = tbody.insertRow();
                    headerRow.className = 'category-header';
                    headerRow.innerHTML = `<td colspan="6">${currentCategory}</td>`;
                }
                const count = currentCounts[product.id] || 0;
                const totalValue = count * product.price;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.unit}</td>
                    <td>‚Ç¨${product.price.toFixed(2)}</td>
                    <td>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="decrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>-1</button>
                            <button class="decimal-btn" onclick="decrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>-0.1</button>
                            <input type="number" class="quantity-input" value="${formatDecimal(count)}" 
                                   onchange="setManualCount('${product.id}', this.value)" 
                                   onblur="setManualCount('${product.id}', this.value)"
                                   min="0" step="0.01" placeholder="0.00" ${isReadOnly ? 'disabled' : ''}>
                            <button class="decimal-btn" onclick="incrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>+0.1</button>
                            <button class="quantity-btn" onclick="incrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>+1</button>
                        </div>
                        <div class="custom-increment">
                            <input type="number" class="custom-increment-input" id="customIncrement-${product.id}" 
                                   placeholder="0.00" step="0.01" min="0.01" ${isReadOnly ? 'disabled' : ''}>
                            <button class="custom-increment-btn" onclick="applyCustomIncrement('${product.id}')" ${isReadOnly ? 'disabled' : ''}>Apply</button>
                        </div>
                    </td>
                    <td>‚Ç¨${totalValue.toFixed(2)}</td>
                `;
            });
            
            const totalCounted = Object.values(currentCounts).reduce((sum, count) => sum + parseFloat(count), 0);
            document.getElementById('totalCounted').textContent = formatDecimal(totalCounted);
        }

        // Quantity functions - FIXED: Always use currentLocation and currentMonth
        function incrementCount(productId, increment = 1) {
            if (isCountingClosed()) return;
            
            const key = `${currentLocation}|${currentMonth}`;
            
            // Make sure data exists
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
            }
            
            const currentCount = parseFloat(monthlyData[key].counts[productId]) || 0;
            const product = products.find(p => p.id === productId);
            
            monthlyData[key].counts[productId] = currentCount + increment;
            saveMonthlyData();
            
            // Log activity
            logActivity('count_update', {
                productId: productId,
                productName: product ? product.name : 'Unknown',
                change: increment,
                previousCount: currentCount,
                newCount: currentCount + increment,
                location: currentLocation,
                month: currentMonth
            });
            
            displayCountingProducts();
            updateSummary();
            updateAnalysis();
        }

        function decrementCount(productId, decrement = 1) {
            if (isCountingClosed()) return;
            
            const key = `${currentLocation}|${currentMonth}`;
            
            // Make sure data exists
            if (!monthlyData[key]) {
                monthlyData[key] = {
                    counts: {},
                    created: new Date().toISOString(),
                    status: 'open'
                };
            }
            
            const currentCount = parseFloat(monthlyData[key].counts[productId]) || 0;
            const newCount = Math.max(0, currentCount - decrement);
            const product = products.find(p => p.id === productId);
            
            monthlyData[key].counts[productId] = newCount;
            saveMonthlyData();
            
            // Log activity
            logActivity('count_update', {
                productId: productId,
                productName: product ? product.name : 'Unknown',
                change: -decrement,
                previousCount: currentCount,
                newCount: newCount,
                location: currentLocation,
                month: currentMonth
            });
            
            displayCountingProducts();
            updateSummary();
            updateAnalysis();
        }

        function setManualCount(productId, value) {
            if (isCountingClosed()) return;
            
            const numValue = parseFloat(value) || 0;
            if (numValue >= 0) {
                const key = `${currentLocation}|${currentMonth}`;
                const currentCount = parseFloat(monthlyData[key]?.counts[productId]) || 0;
                const product = products.find(p => p.id === productId);
                
                // Make sure data exists
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        counts: {},
                        created: new Date().toISOString(),
                        status: 'open'
                    };
                }
                
                monthlyData[key].counts[productId] = numValue;
                saveMonthlyData();
                
                // Log activity if count changed
                if (currentCount !== numValue) {
                    logActivity('count_update', {
                        productId: productId,
                        productName: product ? product.name : 'Unknown',
                        change: numValue - currentCount,
                        previousCount: currentCount,
                        newCount: numValue,
                        location: currentLocation,
                        month: currentMonth
                    });
                }
                
                displayCountingProducts();
                updateSummary();
                updateAnalysis();
            }
        }

        function applyCustomIncrement(productId) {
            if (isCountingClosed()) return;
            
            const input = document.getElementById(`customIncrement-${productId}`);
            const value = parseFloat(input.value);
            if (!isNaN(value) && value > 0) {
                incrementCount(productId, value);
                input.value = '';
            }
        }

        function isCountingClosed() {
            const key = `${currentLocation}|${currentMonth}`;
            if (monthlyData[key]?.status === 'closed') {
                alert('Counting period is closed. No further edits allowed.');
                return true;
            }
            return false;
        }

        function formatDecimal(value) {
            const num = parseFloat(value);
            return num % 1 === 0 ? num.toString() : num.toFixed(2);
        }

        // Update summary
        function updateSummary() {
            const key = `${currentLocation}|${currentMonth}`;
            const currentCounts = monthlyData[key]?.counts || {};
            
            const totalCounted = Object.values(currentCounts).reduce((sum, count) => sum + parseFloat(count), 0);
            const categorySummary = document.getElementById('categorySummary');
            categorySummary.innerHTML = '';
            const categories = {};
            
            products.forEach(product => {
                if (!categories[product.category]) categories[product.category] = { count: 0, value: 0 };
                const count = parseFloat(currentCounts[product.id]) || 0;
                categories[product.category].count += count;
                categories[product.category].value += count * product.price;
            });
            
            Object.keys(categories).sort().forEach(category => {
                const data = categories[category];
                if (data.count > 0) {
                    const row = document.createElement('div');
                    row.className = 'summary-row';
                    row.innerHTML = `<span>${category}:</span><span>${formatDecimal(data.count)} items (‚Ç¨${data.value.toFixed(2)})</span>`;
                    categorySummary.appendChild(row);
                }
            });
            
            let totalItems = 0, totalValue = 0;
            Object.keys(currentCounts).forEach(productId => {
                const product = products.find(p => p.id == productId);
                if (product) {
                    totalItems += parseFloat(currentCounts[productId]);
                    totalValue += parseFloat(currentCounts[productId]) * product.price;
                }
            });
            
            document.getElementById('totalItemsCounted').textContent = formatDecimal(totalItems);
            document.getElementById('totalCountedValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;
        }

        function resetCurrentCounts() {
            if (isCountingClosed()) return;
            
            if (confirm('Are you sure you want to reset all counts for the current period?')) {
                const key = `${currentLocation}|${currentMonth}`;
                const oldCounts = { ...monthlyData[key].counts };
                
                monthlyData[key].counts = {};
                saveMonthlyData();
                
                // Log reset activity
                logActivity('count_reset', {
                    location: currentLocation,
                    month: currentMonth,
                    resetItems: Object.keys(oldCounts).length,
                    resetBy: currentUser.username
                });
                
                displayCountingProducts();
                updateSummary();
                updateAnalysis();
            }
        }

        // Filter functions
        function filterProducts() { displayProducts(); }
        function filterCountingProducts() { displayCountingProducts(); }

        // Archive functions
        function displayArchive() {
            const locationFilter = document.getElementById('archiveLocationFilter').value;
            const yearFilter = document.getElementById('archiveYearFilter').value;
            const tbody = document.getElementById('archiveList');
            tbody.innerHTML = '';
            
            const locationSelect = document.getElementById('archiveLocationFilter');
            locationSelect.innerHTML = '<option value="all">All Locations</option>';
            locations.filter(l => l.active).forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                locationSelect.appendChild(option);
            });
            
            const years = new Set();
            Object.keys(monthlyData).forEach(key => {
                const [location, month] = key.split('|');
                const year = month.split('-')[0];
                years.add(year);
            });
            const yearSelect = document.getElementById('archiveYearFilter');
            yearSelect.innerHTML = '<option value="all">All Years</option>';
            Array.from(years).sort().reverse().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            const archiveEntries = [];
            Object.keys(monthlyData).forEach(key => {
                const [location, month] = key.split('|');
                const year = month.split('-')[0];
                
                if (locationFilter !== 'all' && location !== locationFilter) return;
                if (yearFilter !== 'all' && year !== yearFilter) return;
                
                const data = monthlyData[key];
                let totalItems = 0, totalValue = 0;
                Object.keys(data.counts).forEach(productId => {
                    const product = products.find(p => p.id == productId);
                    if (product) {
                        totalItems += parseFloat(data.counts[productId]);
                        totalValue += parseFloat(data.counts[productId]) * product.price;
                    }
                });
                
                archiveEntries.push({
                    key: key,
                    location: location,
                    month: month,
                    totalItems: totalItems,
                    totalValue: totalValue,
                    status: data.status,
                    created: data.created
                });
            });
            
            archiveEntries.sort((a, b) => b.month.localeCompare(a.month));
            
            if (archiveEntries.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align: center;">No archive data found</td>`;
                return;
            }
            
            archiveEntries.forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatMonthDisplay(entry.month)}</td>
                    <td>${getLocationDisplayName(entry.location)}</td>
                    <td>${formatDecimal(entry.totalItems)}</td>
                    <td>‚Ç¨${entry.totalValue.toFixed(2)}</td>
                    <td><span class="${entry.status === 'open' ? 'status-open' : 'status-closed'}" style="padding: 4px 8px; border-radius: 3px;">${entry.status.toUpperCase()}</span></td>
                    <td>
                        <button class="decimal-btn" onclick="viewArchive('${entry.key}')">View</button>
                    </td>
                `;
            });
        }

        function viewArchive(key) {
            const [location, month] = key.split('|');
            currentLocation = location;
            currentMonth = month;
            document.getElementById('yearSelect').value = month.split('-')[0];
            updateMonthOptions();
            document.getElementById('monthSelect').value = currentMonth;
            
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === getLocationDisplayName(location)) {
                    btn.classList.add('active');
                }
            });
            
            updateUI();
            openTab('counting');
        }

        // ==================== EXPORT FUNCTIONS - EXCEL FORMAT ====================

        function exportAllData() {
            const data = {
                products: products,
                locations: locations,
                users: users,
                monthlyData: monthlyData,
                currentLocation: currentLocation,
                currentMonth: currentMonth,
                exported: new Date().toISOString()
            };
            
            exportToExcel(data);
            
            // Log export activity
            logActivity('data_export', {
                type: 'full_export',
                productsCount: products.length,
                locationsCount: locations.length,
                usersCount: users.length,
                monthlyDataCount: Object.keys(monthlyData).length
            });
        }

        function exportToExcel(data) {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // 1. CURRENT INVENTORY COUNT SHEET (Most Important!)
            const key = `${data.currentLocation}|${data.currentMonth}`;
            const currentCounts = data.monthlyData[key]?.counts || {};
            
            const inventoryData = [
                ["CURRENT INVENTORY COUNT"],
                ["Location:", getLocationDisplayName(data.currentLocation)],
                ["Period:", formatMonthDisplay(data.currentMonth)],
                ["Export Date:", new Date().toLocaleString()],
                [],
                ["Product ID", "Product Name", "Category", "Unit", "Price (‚Ç¨)", "Quantity", "Total Value (‚Ç¨)"]
            ];
            
            let totalItemsCounted = 0;
            let totalInventoryValue = 0;
            
            // Add products with counts
            data.products.forEach(product => {
                const count = parseFloat(currentCounts[product.id]) || 0;
                const totalValue = count * product.price;
                
                if (count > 0) {
                    inventoryData.push([
                        product.id,
                        product.name,
                        product.category,
                        product.unit,
                        product.price,
                        count,
                        totalValue
                    ]);
                    
                    totalItemsCounted += count;
                    totalInventoryValue += totalValue;
                }
            });
            
            // Add summary rows
            inventoryData.push([]);
            inventoryData.push(["TOTAL ITEMS COUNTED:", totalItemsCounted]);
            inventoryData.push(["TOTAL INVENTORY VALUE:", totalInventoryValue]);
            
            const inventoryWs = XLSX.utils.aoa_to_sheet(inventoryData);
            XLSX.utils.book_append_sheet(wb, inventoryWs, "Current Inventory");
            
            // 2. ALL PRODUCTS SHEET (Complete catalog)
            const productsData = [
                ["COMPLETE PRODUCT CATALOG"],
                ["Total Products:", data.products.length],
                [],
                ["ID", "Name", "Category", "Unit", "Price (‚Ç¨)"]
            ];
            
            // Group by category
            const categories = {};
            data.products.forEach(product => {
                if (!categories[product.category]) {
                    categories[product.category] = [];
                }
                categories[product.category].push(product);
            });
            
            Object.keys(categories).sort().forEach(category => {
                productsData.push([category.toUpperCase() + " CATEGORY"]);
                categories[category].forEach(product => {
                    productsData.push([
                        product.id,
                        product.name,
                        product.category,
                        product.unit,
                        product.price
                    ]);
                });
                productsData.push([]);
            });
            
            const productsWs = XLSX.utils.aoa_to_sheet(productsData);
            XLSX.utils.book_append_sheet(wb, productsWs, "All Products");
            
            // 3. COUNTED ITEMS DETAILED SHEET (All items with counts)
            const countedData = [
                ["INVENTORY COUNT DETAILED REPORT"],
                ["Location:", getLocationDisplayName(data.currentLocation)],
                ["Period:", formatMonthDisplay(data.currentMonth)],
                [],
                ["Category", "Product Name", "Unit", "Price (‚Ç¨)", "Quantity", "Total Value (‚Ç¨)"]
            ];
            
            // Group by category
            const countedByCategory = {};
            data.products.forEach(product => {
                const count = parseFloat(currentCounts[product.id]) || 0;
                if (count > 0) {
                    if (!countedByCategory[product.category]) {
                        countedByCategory[product.category] = [];
                    }
                    countedByCategory[product.category].push({
                        name: product.name,
                        unit: product.unit,
                        price: product.price,
                        count: count,
                        totalValue: count * product.price
                    });
                }
            });
            
            Object.keys(countedByCategory).sort().forEach(category => {
                countedData.push([category.toUpperCase()]);
                let categoryTotal = 0;
                
                countedByCategory[category].forEach(item => {
                    countedData.push([
                        "", // Empty for category column since we're grouping
                        item.name,
                        item.unit,
                        item.price,
                        item.count,
                        item.totalValue
                    ]);
                    categoryTotal += item.totalValue;
                });
                
                countedData.push([
                    "Category Total:",
                    "",
                    "",
                    "",
                    "",
                    categoryTotal
                ]);
                countedData.push([]);
            });
            
            // Add final totals
            countedData.push(["GRAND TOTAL", "", "", "", totalItemsCounted, totalInventoryValue]);
            
            const countedWs = XLSX.utils.aoa_to_sheet(countedData);
            XLSX.utils.book_append_sheet(wb, countedWs, "Counted Items");
            
            // 4. MONTHLY ARCHIVE SHEET
            const monthlyHeader = ["Location|Month", "Location Name", "Month", "Status", "Total Items", "Total Value (‚Ç¨)", "Created Date"];
            const monthlyRows = [];
            
            Object.keys(data.monthlyData).forEach(key => {
                const [location, month] = key.split('|');
                const entry = data.monthlyData[key];
                let totalItems = 0;
                let totalValue = 0;
                
                Object.keys(entry.counts).forEach(productId => {
                    const product = data.products.find(p => p.id == productId);
                    if (product) {
                        totalItems += parseFloat(entry.counts[productId]);
                        totalValue += parseFloat(entry.counts[productId]) * product.price;
                    }
                });
                
                monthlyRows.push([
                    key,
                    getLocationDisplayName(location),
                    formatMonthDisplay(month),
                    entry.status.toUpperCase(),
                    totalItems,
                    totalValue,
                    new Date(entry.created).toLocaleString()
                ]);
            });
            
            const monthlyDataSheet = [monthlyHeader, ...monthlyRows];
            const monthlyWs = XLSX.utils.aoa_to_sheet(monthlyDataSheet);
            XLSX.utils.book_append_sheet(wb, monthlyWs, "Monthly Archive");
            
            // 5. SUMMARY SHEET
            const summaryData = [
                ["INVENTORY SYSTEM EXPORT SUMMARY"],
                ["Generated:", new Date().toLocaleString()],
                [],
                ["SYSTEM STATISTICS"],
                ["Total Products:", data.products.length],
                ["Total Locations:", data.locations.length],
                ["Total Users:", data.users.length],
                ["Total Monthly Records:", Object.keys(data.monthlyData).length],
                [],
                ["CURRENT INVENTORY STATISTICS"],
                ["Current Location:", getLocationDisplayName(data.currentLocation)],
                ["Current Period:", formatMonthDisplay(data.currentMonth)],
                ["Items Counted:", totalItemsCounted],
                ["Total Inventory Value:", totalInventoryValue],
                ["Export Date:", new Date().toISOString().split('T')[0]]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
            
            // Generate Excel file
            const fileName = `inventory_${getLocationDisplayName(data.currentLocation).replace(/\s+/g, '_')}_${data.currentMonth}_export.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Add this function for exporting just the current counted inventory
        function exportCurrentInventory() {
            const key = `${currentLocation}|${currentMonth}`;
            const currentCounts = monthlyData[key]?.counts || {};
            
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Main inventory sheet
            const inventoryData = [
                ["HAFERKATER INVENTORY COUNT REPORT"],
                ["Location:", getLocationDisplayName(currentLocation)],
                ["Period:", formatMonthDisplay(currentMonth)],
                ["Export Date:", new Date().toLocaleString()],
                ["Status:", monthlyData[key]?.status === 'closed' ? 'CLOSED' : 'OPEN'],
                [],
                ["Product ID", "Product Name", "Category", "Unit", "Price (‚Ç¨)", "Quantity", "Total Value (‚Ç¨)"]
            ];
            
            let totalItemsCounted = 0;
            let totalInventoryValue = 0;
            
            // Group by category
            const categories = {};
            products.forEach(product => {
                const count = parseFloat(currentCounts[product.id]) || 0;
                if (count > 0) {
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push({
                        id: product.id,
                        name: product.name,
                        unit: product.unit,
                        price: product.price,
                        count: count,
                        totalValue: count * product.price
                    });
                    
                    totalItemsCounted += count;
                    totalInventoryValue += count * product.price;
                }
            });
            
            // Add categorized data
            Object.keys(categories).sort().forEach(category => {
                // Add category header
                inventoryData.push([category.toUpperCase() + " CATEGORY"]);
                
                // Add products in this category
                let categoryTotal = 0;
                categories[category].forEach(item => {
                    inventoryData.push([
                        item.id,
                        item.name,
                        category,
                        item.unit,
                        item.price,
                        item.count,
                        item.totalValue
                    ]);
                    categoryTotal += item.totalValue;
                });
                
                // Add category subtotal
                inventoryData.push([
                    "Category Total:",
                    "",
                    "",
                    "",
                    "",
                    "",
                    categoryTotal
                ]);
                inventoryData.push([]);
            });
            
            // Add grand totals
            inventoryData.push([]);
            inventoryData.push(["GRAND TOTAL", "", "", "", "", totalItemsCounted, totalInventoryValue]);
            
            const inventoryWs = XLSX.utils.aoa_to_sheet(inventoryData);
            XLSX.utils.book_append_sheet(wb, inventoryWs, "Inventory Count");
            
            // Summary sheet
            const summaryData = [
                ["INVENTORY COUNT SUMMARY"],
                ["Location:", getLocationDisplayName(currentLocation)],
                ["Period:", formatMonthDisplay(currentMonth)],
                ["Export Date:", new Date().toLocaleString()],
                [],
                ["SUMMARY BY CATEGORY"]
            ];
            
            // Add category summaries
            Object.keys(categories).sort().forEach(category => {
                let categoryItems = 0;
                let categoryValue = 0;
                
                categories[category].forEach(item => {
                    categoryItems += item.count;
                    categoryValue += item.totalValue;
                });
                
                summaryData.push([
                    category + ":",
                    categoryItems.toFixed(2) + " items",
                    "‚Ç¨" + categoryValue.toFixed(2)
                ]);
            });
            
            summaryData.push([]);
            summaryData.push(["TOTAL ITEMS COUNTED:", totalItemsCounted.toFixed(2)]);
            summaryData.push(["TOTAL INVENTORY VALUE:", "‚Ç¨" + totalInventoryValue.toFixed(2)]);
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
            
            // Generate Excel file
            const fileName = `haferkater_inventory_${getLocationDisplayName(currentLocation).replace(/\s+/g, '_')}_${currentMonth}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Log activity
            logActivity('data_export', {
                type: 'inventory_count_export',
                location: currentLocation,
                month: currentMonth,
                itemsCounted: totalItemsCounted,
                totalValue: totalInventoryValue
            });
        }

        // Analysis functions
        function updateAnalysis() {
            const key = `${currentLocation}|${currentMonth}`;
            const currentCounts = monthlyData[key]?.counts || {};
            
            let totalValue = 0;
            let itemsCounted = 0;
            const categoryValues = {};
            
            products.forEach(product => {
                const count = parseFloat(currentCounts[product.id]) || 0;
                const value = count * product.price;
                totalValue += value;
                if (count > 0) itemsCounted++;
                
                if (!categoryValues[product.category]) {
                    categoryValues[product.category] = 0;
                }
                categoryValues[product.category] += value;
            });
            
            document.getElementById('totalInventoryValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;
            document.getElementById('itemsCounted').textContent = formatDecimal(itemsCounted);
            document.getElementById('totalItems').textContent = products.length;
            
            const avgPrice = itemsCounted > 0 ? totalValue / itemsCounted : 0;
            document.getElementById('avgPrice').textContent = `‚Ç¨${avgPrice.toFixed(2)}`;
            
            let topCategory = '-';
            let topCategoryValue = 0;
            Object.keys(categoryValues).forEach(category => {
                if (categoryValues[category] > topCategoryValue) {
                    topCategory = category;
                    topCategoryValue = categoryValues[category];
                }
            });
            document.getElementById('topCategory').textContent = topCategory;
            document.getElementById('topCategoryValue').textContent = `‚Ç¨${topCategoryValue.toFixed(2)}`;
            
            const progressPercent = (itemsCounted / products.length) * 100;
            document.getElementById('inventoryProgress').style.width = `${progressPercent}%`;
        }

        // Location management
        function showAddLocationForm() {
            document.getElementById('locationModalTitle').textContent = 'Add New Location';
            document.getElementById('modalLocationName').value = '';
            document.getElementById('modalLocationId').value = '';
            document.getElementById('locationModal').style.display = 'flex';
        }

        function saveLocation() {
            const name = document.getElementById('modalLocationName').value.trim();
            const id = document.getElementById('modalLocationId').value.trim();
            
            if (!name || !id) {
                alert('Please fill all fields');
                return;
            }
            
            if (locations.find(l => l.id === id)) {
                alert('Location ID already exists');
                return;
            }
            
            locations.push({ id, name, active: true });
            saveLocations();
            
            // Log location add activity
            logActivity('location_add', {
                locationId: id,
                locationName: name
            });
            
            closeModal('locationModal');
            updateLocationSelector();
            alert('Location added successfully');
        }

        // User management
        function showAddUserForm() {
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalUserRole').value = 'inventory';
            
            const locationAccessList = document.getElementById('locationAccessList');
            locationAccessList.innerHTML = '';
            
            locations.filter(l => l.active).forEach(location => {
                const div = document.createElement('div');
                div.className = 'location-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = location.id;
                checkbox.checked = true;
                checkbox.id = `loc-${location.id}`;
                
                const label = document.createElement('label');
                label.textContent = location.name;
                label.htmlFor = `loc-${location.id}`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                locationAccessList.appendChild(div);
            });
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function saveUser() {
            const username = document.getElementById('modalUsername').value.trim();
            const password = document.getElementById('modalPassword').value;
            const role = document.getElementById('modalUserRole').value;
            
            if (!username || !password) {
                alert('Please fill all fields');
                return;
            }
            
            const existingUser = users.find(u => u.username === username);
            const locationAccess = Array.from(document.querySelectorAll('#locationAccessList input:checked'))
                .map(checkbox => checkbox.value);
            
            if (existingUser) {
                // Update existing user
                existingUser.password = password;
                existingUser.role = role;
                existingUser.locations = locationAccess;
                
                logActivity('user_edit', {
                    username: username,
                    role: role,
                    locations: locationAccess
                });
            } else {
                // Add new user
                users.push({
                    username,
                    password,
                    role,
                    locations: locationAccess,
                    lastLogin: null
                });
                
                logActivity('user_add', {
                    username: username,
                    role: role,
                    locations: locationAccess
                });
            }
            
            saveUsers();
            closeModal('userModal');
            showUserManagement();
            alert(existingUser ? 'User updated successfully' : 'User added successfully');
        }

        function showUserManagement() {
            document.getElementById('userManagementSection').style.display = 'block';
            document.getElementById('locationManagementSection').style.display = 'none';
            displayUsers();
        }

        function showLocationManagement() {
            document.getElementById('locationManagementSection').style.display = 'block';
            document.getElementById('userManagementSection').style.display = 'none';
            displayAdminLocations();
        }

        function displayUsers() {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role === 'admin' ? 'Administrator' : 'Inventory User'}</td>
                    <td>${user.locations.map(l => getLocationDisplayName(l)).join(', ')}</td>
                    <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
                        ${user.username !== 'admin' ? `<button class="admin-btn" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
                    </td>
                `;
            });
        }

        function displayAdminLocations() {
            const tbody = document.getElementById('adminLocationList');
            tbody.innerHTML = '';
            
            locations.forEach(location => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${location.name}</td>
                    <td>${location.id}</td>
                    <td>${location.active ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="edit-btn" onclick="toggleLocation('${location.id}')">${location.active ? 'Disable' : 'Enable'}</button>
                        ${location.id !== 'ostbahnhof' && location.id !== 'potsdam' ? `<button class="admin-btn" onclick="deleteLocation('${location.id}')">Delete</button>` : ''}
                    </td>
                `;
            });
        }

        function deleteUser(username) {
            if (username === 'admin') {
                alert('Cannot delete admin user');
                return;
            }
            
            const userToDelete = users.find(u => u.username === username);
            if (!userToDelete) return;
            
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                logActivity('user_delete', {
                    username: username,
                    role: userToDelete.role,
                    deletedBy: currentUser.username
                });
                
                users = users.filter(u => u.username !== username);
                saveUsers();
                displayUsers();
            }
        }

        function toggleLocation(locationId) {
            const location = locations.find(l => l.id === locationId);
            if (location) {
                location.active = !location.active;
                saveLocations();
                displayAdminLocations();
                updateLocationSelector();
            }
        }

        function deleteLocation(locationId) {
            if (locationId === 'ostbahnhof' || locationId === 'potsdam') {
                alert('Cannot delete default locations');
                return;
            }
            
            if (confirm(`Are you sure you want to delete this location?`)) {
                locations = locations.filter(l => l.id !== locationId);
                saveLocations();
                displayAdminLocations();
                updateLocationSelector();
            }
        }

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function getLocationDisplayName(locationId) {
            const location = locations.find(l => l.id === locationId);
            return location ? location.name : locationId;
        }

        function formatMonthDisplay(month) {
            const [year, monthNum] = month.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
        }

        // Data persistence
        function saveProducts() {
            localStorage.setItem('inventoryProducts', JSON.stringify(products));
        }

        function saveLocations() {
            localStorage.setItem('inventoryLocations', JSON.stringify(locations));
        }

        function saveUsers() {
            localStorage.setItem('inventoryUsers', JSON.stringify(users));
        }

        function saveMonthlyData() {
            localStorage.setItem('monthlyInventoryData', JSON.stringify(monthlyData));
        }

        // Import ALL products including Retail and Gem√ºse
        function importAllProducts() {
            console.log('Importing default products...');
            products = [
                // Your existing Trankgourmet products
                { id: '382224', name: 'B1774_Porridgebecher 500St', unit: 'stuck', category: 'Verbrauch', price: 0.075 },
                { id: '252437', name: 'B1774_Deckel Porridge Be.500St', unit: 'stuck', category: 'Verbrauch', price: 0.071 },
                { id: '370981', name: 'B1774_Kaffeebech. 200ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.049 },
                { id: '802049', name: 'B1774_Servietten 5000St', unit: 'stuck', category: 'Verbrauch', price: 0.09 },
                { id: '343306', name: 'B1774_Gro√üe Bowl-Schale 300St', unit: 'stuck', category: 'Verbrauch', price: 0.158 },
                { id: '966396', name: 'B1774_Blockbodenb.klein 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
                { id: '368945', name: 'B1774_Gro√üe Bowl-Deckel 300St', unit: 'stuck', category: 'Verbrauch', price: 0.148 },
                { id: '854238', name: 'B1774_Blockbodenbeu.gro√ü 800St', unit: 'stuck', category: 'Verbrauch', price: 0.043 },
                { id: '340091', name: 'L√ñFFEL HOLZ 16,5CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.027 },
                { id: '317674', name: 'B1774_Kaffe Deckel 90mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.047 },
                { id: '461226', name: 'B1774_Snack-Pap.Zuschn.500St', unit: 'stuck', category: 'Verbrauch', price: 0.187 },
                { id: '448199', name: 'Bechermanschetten braun 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.039 },
                { id: '69636', name: 'B1774_Vitrin.Bowl klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.121 },
                { id: '545740', name: 'Hand.Pap.2lg 25x23 TGQ20x150Bl', unit: 'stuck', category: 'Verbrauch', price: 0.008 },
                { id: '59784', name: 'DECKEL PLA PORTIONSBECHER 2000', unit: 'stuck', category: 'Verbrauch', price: 0.037 },
                { id: '472974', name: 'B1774_Vitri.Deckel.klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.12 },
                { id: '754897', name: 'Sahneabdeckpa.18X24cm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.01 },
                { id: '92548', name: 'MS 120L Stand.blau 25St', unit: 'stuck', category: 'Verbrauch', price: 0.023 },
                { id: '361533', name: 'B1774_Kaffee Bech.300ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.034 },
                { id: '413902', name: 'K√ºchent√ºcher 3lg. TGQ 4x64Bl', unit: 'stuck', category: 'Verbrauch', price: 0.839 },
                { id: '383208', name: 'GABEL HOLZ 16CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.028 },
                { id: '35236', name: 'Dressingbech.30ml transp.100St', unit: 'stuck', category: 'Verbrauch', price: 0.022 },
                { id: '830712', name: 'B1774_Papiertasche klein 250St', unit: 'stuck', category: 'Verbrauch', price: 0.115 },
                { id: '318372', name: 'NITRIL HANDSCH.L WE.PUDE.100ST', unit: 'stuck', category: 'Verbrauch', price: 0.056 },
                { id: '331635', name: 'Deckel DressingCup trans.100St', unit: 'stuck', category: 'Verbrauch', price: 0.017 },
                { id: '105439', name: 'B1774_Kaffe.Deckel 80mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
                { id: '298009', name: 'B1774_Bio Espresso 1kg', unit: 'stuck', category: 'Trockenware', price: 16.761 },
                { id: '896293', name: 'B1774_Bio Granola 4,5kg', unit: 'stuck', category: 'Trockenware', price: 48.532 },
                { id: '768559', name: 'Weizentort.Grill.30cm Fu.18St', unit: 'stuck', category: 'Trockenware', price: 5.99 },
                { id: '959020', name: 'B1774_Bio Apfelmus gew√ºrzt 3kg', unit: 'stuck', category: 'Trockenware', price: 15.445 },
                { id: '118664', name: 'B1774_Hafer bio 25kg', unit: 'stuck', category: 'Trockenware', price: 32.75 },
                { id: '148738', name: 'Bio Ahornsirup TGN 1l', unit: 'stuck', category: 'Trockenware', price: 15.138 },
                { id: '317906', name: 'B1774_Rote Gr√ºtze 3kg', unit: 'stuck', category: 'Trockenware', price: 15.705 },
                { id: '313957', name: 'Viva Con Miwa Leise DPG 0,5l', unit: 'stuck', category: 'Trockenware', price: 0.75 },
                { id: '877743', name: 'Kuv.Tropfen dunkel TGQ 2,5kg', unit: 'stuck', category: 'Trockenware', price: 37.78 },
                { id: '793566', name: 'B1774_Bio Erdnussmus 8kg', unit: 'stuck', category: 'Trockenware', price: 57.3 },
                { id: '438453', name: 'Bio Brotaufstr.medit.Gem. 360g', unit: 'stuck', category: 'Trockenware', price: 3.197 },
                { id: '404403', name: 'B1774_Rotkorn 10kg', unit: 'stuck', category: 'Trockenware', price: 45.75 },
                { id: '495456', name: 'B1774_Haferreis 2,5kg', unit: 'stuck', category: 'Trockenware', price: 6.29 },
                { id: '167742', name: 'Kichererbsen TGQ 2,65l', unit: 'stuck', category: 'Trockenware', price: 3.214 },
                { id: '314664', name: 'Viva Con Miwa Laut DPG 0,5l', unit: 'stuck', category: 'Trockenware', price: 0.75 },
                { id: '185165', name: 'Bio Mandelmus veg. 500g', unit: 'stuck', category: 'Trockenware', price: 12.375 },
                { id: '168702', name: 'Bio Ingwer Kurkuma Shot EW95ml', unit: 'stuck', category: 'Trockenware', price: 1.424 },
                { id: '829463', name: 'Walnusskerne Bruch TGQ 1kg', unit: 'stuck', category: 'Trockenware', price: 9.71 },
                { id: '76407', name: 'Bio H-Milch 3,5% MinusL 1l', unit: 'stuck', category: 'Trockenware', price: 1.724 },
                { id: '720094', name: 'Gomashio W√ºrzmischung Wib.280g', unit: 'stuck', category: 'Trockenware', price: 7.313 },
                { id: '250686', name: 'Bio Ingwer Beeren Shot EW 95ml', unit: 'stuck', category: 'Trockenware', price: 1.424 },
                { id: '727815', name: 'Extaler Miwa Naturell DPG 1l', unit: 'stuck', category: 'Trockenware', price: 0.52 },
                { id: '727143', name: 'Sojasauce Kikko.1l', unit: 'stuck', category: 'Trockenware', price: 7.435 },
                { id: '801642', name: 'Tonys VM Karamel Meers.Tfl.47g', unit: 'stuck', category: 'Trockenware', price: 1.062 },
                { id: '984984', name: 'Bio Zuckerst.hell TGN 500x3,5g', unit: 'stuck', category: 'Trockenware', price: 9.66 },
                { id: '812738', name: 'Bio H-Milch 3,8% TGN 1l', unit: 'stuck', category: 'Trockenware', price: 1.24 },
                { id: '168733', name: 'Bio Bl√ºtenhonig Spend.Imm.350g', unit: 'stuck', category: 'Trockenware', price: 2.854 },
                { id: '610812', name: 'Oliven schw.Schb.TGQ 935ml', unit: 'stuck', category: 'Trockenware', price: 2.703 },
                { id: '764605', name: 'Raspelschokolade ZB Ul.2,5kg', unit: 'stuck', category: 'Trockenware', price: 48.28 },
                { id: '784093', name: 'Bio Agavendicksaft TGN 1,39kg', unit: 'stuck', category: 'Trockenware', price: 8.75 },
                { id: '598394', name: 'Tonys ZB 51% Mandel Tfl.47g', unit: 'stuck', category: 'Trockenware', price: 1.062 },
                { id: '628521', name: 'Kokoschips Nature TGQ 600g', unit: 'stuck', category: 'Trockenware', price: 6.008 },
                { id: '168618', name: 'Oliven√∂l ex.nat. 5l', unit: 'stuck', category: 'Trockenware', price: 51.08 },
                { id: '882410', name: 'Bio Sonnenbl.Ker.gesch.TGN500g', unit: 'stuck', category: 'Trockenware', price: 2.092 },
                { id: '670', name: 'Bio Rohrz.fein-hell TGN 1kg', unit: 'stuck', category: 'Trockenware', price: 2.785 },
                { id: '821922', name: 'Bio Kokosmilch TGN 1l', unit: 'stuck', category: 'Trockenware', price: 3.33 },
                { id: '547116', name: 'Paprika ger√§uchert Wib.270g', unit: 'stuck', category: 'Trockenware', price: 7.94 },
                { id: '182645', name: 'ZITRONENSAFT GLAS EW WE.0,75L', unit: 'stuck', category: 'Trockenware', price: 1.357 },
                { id: '93951', name: 'Vitamin Well Antioxidan EW0,5l', unit: 'stuck', category: 'Trockenware', price: 1.56 },
                { id: '308323', name: 'Vitamin Well Reload EW 0,5l', unit: 'stuck', category: 'Trockenware', price: 1.56 },
                { id: '871225', name: 'Bio Volvic Tee Zitr.EW 0,75l', unit: 'stuck', category: 'Trockenware', price: 1.505 },
                { id: '846238', name: 'Bio Dattelsirup Imm.250ml', unit: 'stuck', category: 'Trockenware', price: 2.27 },
                { id: '6477', name: 'Sonnensalz Speisesalz TGQ 1kg', unit: 'stuck', category: 'Trockenware', price: 0.99 },
                { id: '55988', name: 'Bio Sojaghurt N. 1,5% TGN 1kg', unit: 'stuck', category: 'Trockenware', price: 2.575 },
                { id: '937418', name: 'Basilikum grob TGN 50g', unit: 'stuck', category: 'Trockenware', price: 2.31 },
                { id: '68171', name: 'Gem√ºsebr√ºhe TGN 60g', unit: 'stuck', category: 'Trockenware', price: 2.475 },
                { id: '266167', name: 'Leinsamen geschr. TGN 500g', unit: 'stuck', category: 'Trockenware', price: 2.09 },
                { id: '743096', name: 'Paprikapulver edels√º√ü TGN 75g', unit: 'stuck', category: 'Trockenware', price: 1.815 },
                { id: '918127', name: 'Kokos√∂l nativ TGN 1l', unit: 'stuck', category: 'Trockenware', price: 15.87 },
                { id: '479912', name: 'Buchweizen Vollk. TGN 500g', unit: 'stuck', category: 'Trockenware', price: 2.64 },
                { id: '959162', name: 'Sesam gesch√§lt TGN 500g', unit: 'stuck', category: 'Trockenware', price: 3.52 },
                { id: '456027', name: 'Vanillemark TGN 100g', unit: 'stuck', category: 'Trockenware', price: 8.36 },
                { id: '262955', name: 'Zimtpulver TGN 40g', unit: 'stuck', category: 'Trockenware', price: 1.815 },
                { id: '117439', name: 'Bio Cranberries getr. 500g', unit: 'stuck', category: 'Trockenware', price: 7.975 },
                { id: '990293', name: 'Bio Cashewkerne ger√∂st. 500g', unit: 'stuck', category: 'Trockenware', price: 9.35 },
                { id: '524726', name: 'Kurkumapulver TGN 50g', unit: 'stuck', category: 'Trockenware', price: 2.09 },
                { id: '683850', name: 'Ingwerpulver TGN 70g', unit: 'stuck', category: 'Trockenware', price: 2.475 },
                
                // Retail Products
                { id: 'R001', name: 'Bio Granola 250g', unit: 'stuck', category: 'Retail', price: 6.50 },
                { id: 'R002', name: 'Bio Porridge Hafer', unit: 'stuck', category: 'Retail', price: 4.90 },
                { id: 'R003', name: 'Bio Kaffee Bohnen 500g', unit: 'stuck', category: 'Retail', price: 14.90 },
                { id: 'R004', name: 'Haferdrink 1L', unit: 'stuck', category: 'Retail', price: 2.99 },
                { id: 'R005', name: 'Energy Balls 3er Pack', unit: 'stuck', category: 'Retail', price: 3.90 },
                { id: 'R006', name: 'Bio Tee Mischung', unit: 'stuck', category: 'Retail', price: 5.50 },
                { id: 'R007', name: 'Nussmus Glas 250g', unit: 'stuck', category: 'Retail', price: 7.90 },
                { id: 'R008', name: 'Reiswaffeln Sesam', unit: 'stuck', category: 'Retail', price: 2.50 },
                { id: 'R009', name: 'Datteln Medjool 500g', unit: 'stuck', category: 'Retail', price: 8.90 },
                { id: 'R010', name: 'Bio Schokolade 85%', unit: 'stuck', category: 'Retail', price: 4.50 },
                { id: 'R011', name: 'Kr√§utersalz Glas', unit: 'stuck', category: 'Retail', price: 6.90 },
                { id: 'R012', name: 'Fruchtriegel Beere', unit: 'stuck', category: 'Retail', price: 2.20 },
                { id: 'R013', name: 'Kokoschips gesalzen', unit: 'stuck', category: 'Retail', price: 5.90 },
                { id: 'R014', name: 'Ingwer Shot 95ml', unit: 'stuck', category: 'Retail', price: 3.50 },
                { id: 'R015', name: 'Studentenfutter 200g', unit: 'stuck', category: 'Retail', price: 4.20 },
                { id: 'R016', name: 'Quinoa 500g', unit: 'stuck', category: 'Retail', price: 6.90 },
                { id: 'R017', name: 'Linsen Rot 500g', unit: 'stuck', category: 'Retail', price: 3.90 },
                { id: 'R018', name: 'Chia Samen 250g', unit: 'stuck', category: 'Retail', price: 5.90 },
                { id: 'R019', name: 'Protein Pulver 500g', unit: 'stuck', category: 'Retail', price: 19.90 },
                { id: 'R020', name: 'Kurkuma Latte Mix', unit: 'stuck', category: 'Retail', price: 8.90 },
                
                // Gem√ºse (Vegetables) Category
                { id: 'V001', name: 'Kartoffeln mehlig 2.5kg', unit: 'stuck', category: 'Gem√ºse', price: 3.50 },
                { id: 'V002', name: 'Zwiebeln rot 1kg', unit: 'stuck', category: 'Gem√ºse', price: 2.90 },
                { id: 'V003', name: 'Knoblauch 500g', unit: 'stuck', category: 'Gem√ºse', price: 4.50 },
                { id: 'V004', name: 'Karotten 2kg', unit: 'stuck', category: 'Gem√ºse', price: 3.20 },
                { id: 'V005', name: 'Sellerie Stange', unit: 'stuck', category: 'Gem√ºse', price: 2.80 },
                { id: 'V006', name: 'Lauch 1kg', unit: 'stuck', category: 'Gem√ºse', price: 3.90 },
                { id: 'V007', name: 'Spinat TK 1kg', unit: 'stuck', category: 'Gem√ºse', price: 5.20 },
                { id: 'V008', name: 'Brokkoli 1kg', unit: 'stuck', category: 'Gem√ºse', price: 4.80 },
                { id: 'V009', name: 'Blumenkohl 1kg', unit: 'stuck', category: 'Gem√ºse', price: 4.50 },
                { id: 'V010', name: 'Paprika rot 1kg', unit: 'stuck', category: 'Gem√ºse', price: 8.90 },
                { id: 'V011', name: 'Zucchini 1kg', unit: 'stuck', category: 'Gem√ºse', price: 6.50 },
                { id: 'V012', name: 'Aubergine 1kg', unit: 'stuck', category: 'Gem√ºse', price: 7.90 },
                { id: 'V013', name: 'Tomaten 1kg', unit: 'stuck', category: 'Gem√ºse', price: 5.90 },
                { id: 'V014', name: 'Gurken 1kg', unit: 'stuck', category: 'Gem√ºse', price: 4.20 },
                { id: 'V015', name: 'Champignons 1kg', unit: 'stuck', category: 'Gem√ºse', price: 7.50 },
                { id: 'V016', name: 'Ingwer 500g', unit: 'stuck', category: 'Gem√ºse', price: 9.90 },
                { id: 'V017', name: 'Kr√§uter Mix Bund', unit: 'stuck', category: 'Gem√ºse', price: 3.50 },
                { id: 'V018', name: 'Salat Mix 500g', unit: 'stuck', category: 'Gem√ºse', price: 4.90 },
                { id: 'V019', name: 'Rote Bete 1kg', unit: 'stuck', category: 'Gem√ºse', price: 4.20 },
                { id: 'V020', name: 'K√ºrbis 1kg', unit: 'stuck', category: 'Gem√ºse', price: 3.90 }
            ];
            
            saveProducts();
            console.log('All products imported successfully:', products.length);
        }

        // Display products in Products tab
        function displayProducts() {
            const tbody = document.getElementById('productList');
            tbody.innerHTML = '';
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            
            let filteredProducts = products;
            if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            if (searchTerm) filteredProducts = filteredProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
            
            if (filteredProducts.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align: center;">No products found</td>`;
                return;
            }
            
            let currentCategory = '';
            filteredProducts.sort((a, b) => {
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.name.localeCompare(b.name);
            }).forEach(product => {
                if (product.category !== currentCategory) {
                    currentCategory = product.category;
                    const headerRow = tbody.insertRow();
                    headerRow.className = 'category-header';
                    headerRow.innerHTML = `<td colspan="6">${currentCategory}</td>`;
                }
                const row = tbody.insertRow();
                const isAdmin = currentUser && currentUser.role === 'admin';
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.unit}</td>
                    <td>‚Ç¨${product.price.toFixed(2)}</td>
                    <td>
                        ${isAdmin ? `
                            <button class="edit-btn" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="admin-btn" onclick="deleteProduct('${product.id}')">Delete</button>
                        ` : ''}
                    </td>
                `;
            });
        }

        function updateUI() {
            updateMonthDisplay();
            displayCountingProducts();
            displayProducts();
            updateSummary();
            updateAnalysis();
            displayArchive();
            
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalCategories').textContent = new Set(products.map(p => p.category)).size;
            
            const key = `${currentLocation}|${currentMonth}`;
            const currentCounts = monthlyData[key]?.counts || {};
            const totalCounted = Object.values(currentCounts).reduce((sum, count) => sum + parseFloat(count), 0);
            document.getElementById('totalCounted').textContent = formatDecimal(totalCounted);
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick*="${tabName}"]`).classList.add('active');
            
            if (tabName === 'analysis') {
                setTimeout(() => {
                    renderCharts();
                }, 100);
            } else if (tabName === 'activity') {
                displayActivityLog();
            } else if (tabName === 'admin') {
                showUserManagement();
            }
        }

        function renderCharts() {
            const key = `${currentLocation}|${currentMonth}`;
            const currentCounts = monthlyData[key]?.counts || {};
            
            const categoryValues = {};
            const productValues = [];
            
            products.forEach(product => {
                const count = parseFloat(currentCounts[product.id]) || 0;
                const value = count * product.price;
                
                if (count > 0) {
                    if (!categoryValues[product.category]) {
                        categoryValues[product.category] = 0;
                    }
                    categoryValues[product.category] += value;
                    
                    productValues.push({
                        name: product.name,
                        value: value
                    });
                }
            });
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryValues),
                    datasets: [{
                        label: 'Value (‚Ç¨)',
                        data: Object.values(categoryValues),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Top Products Chart
            const topProducts = productValues.sort((a, b) => b.value - a.value).slice(0, 10);
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            new Chart(topProductsCtx, {
                type: 'horizontalBar',
                data: {
                    labels: topProducts.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name),
                    datasets: [{
                        label: 'Value (‚Ç¨)',
                        data: topProducts.map(p => p.value),
                        backgroundColor: '#27ae60',
                        borderColor: '#219653',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== ACTIVITY LOG FUNCTIONS ====================
        
        function displayActivityLog() {
            const userFilter = document.getElementById('activityUserFilter').value;
            const actionFilter = document.getElementById('activityActionFilter').value;
            const timeFilter = document.getElementById('activityTimeFilter').value;
            
            // Update user filter options
            const userFilterSelect = document.getElementById('activityUserFilter');
            const currentOptions = Array.from(userFilterSelect.options).map(opt => opt.value);
            const allUsers = [...new Set(activityLogs.map(log => log.user))];
            
            // Only update if users have changed
            if (allUsers.length !== currentOptions.length - 1) { // -1 for "all" option
                userFilterSelect.innerHTML = '<option value="all">All Users</option>';
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilterSelect.appendChild(option);
                });
            }
            
            // Filter logs
            let filteredLogs = activityLogs;
            
            if (userFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.user === userFilter);
            }
            
            if (actionFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.action === actionFilter);
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 30);
            
            if (timeFilter === 'today') {
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= today);
            } else if (timeFilter === 'yesterday') {
                filteredLogs = filteredLogs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    return logDate >= yesterday && logDate < today;
                });
            } else if (timeFilter === 'week') {
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= weekAgo);
            } else if (timeFilter === 'month') {
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= monthAgo);
            }
            
            // Update statistics
            document.getElementById('totalActivities').textContent = activityLogs.length;
            document.getElementById('todayActivities').textContent = activityLogs.filter(log => new Date(log.timestamp) >= today).length;
            
            const activeUsers = new Set(activityLogs
                .filter(log => new Date(log.timestamp) >= weekAgo)
                .map(log => log.user));
            document.getElementById('activeUsersCount').textContent = activeUsers.size;
            
            // Display logs
            const tbody = document.getElementById('activityLogList');
            tbody.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align: center;">No activity logs found</td>`;
                return;
            }
            
            filteredLogs.slice(0, 100).forEach(log => { // Limit to 100 logs for performance
                const row = tbody.insertRow();
                
                // Format timestamp
                const logDate = new Date(log.timestamp);
                const timeStr = `${logDate.toLocaleDateString()} ${logDate.toLocaleTimeString()}`;
                
                // Format action with icon
                let actionIcon = 'üìù';
                if (log.action.includes('login')) actionIcon = 'üîê';
                else if (log.action.includes('logout')) actionIcon = 'üö™';
                else if (log.action.includes('count')) actionIcon = 'üìä';
                else if (log.action.includes('product')) actionIcon = 'üì¶';
                else if (log.action.includes('user')) actionIcon = 'üë§';
                else if (log.action.includes('export')) actionIcon = 'üì§';
                
                // Format details
                let details = JSON.stringify(log.details);
                if (details.length > 50) {
                    details = details.substring(0, 50) + '...';
                }
                
                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${log.user} (${log.userRole})</td>
                    <td>${actionIcon} ${log.action.replace('_', ' ')}</td>
                    <td>${details}</td>
                    <td>${getLocationDisplayName(log.location)}</td>
                    <td>${formatMonthDisplay(log.month)}</td>
                `;
            });
        }

        function exportActivityLog() {
            const wb = XLSX.utils.book_new();
            
            const logData = [
                ["ACTIVITY LOG EXPORT"],
                ["Generated:", new Date().toLocaleString()],
                ["Total Logs:", activityLogs.length],
                [],
                ["Timestamp", "User", "User Role", "Action", "Details", "Location", "Month", "IP"]
            ];
            
            activityLogs.forEach(log => {
                logData.push([
                    new Date(log.timestamp).toLocaleString(),
                    log.user,
                    log.userRole,
                    log.action,
                    JSON.stringify(log.details),
                    getLocationDisplayName(log.location),
                    formatMonthDisplay(log.month),
                    log.ip
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(logData);
            XLSX.utils.book_append_sheet(wb, ws, "Activity Log");
            
            // Summary sheet
            const summaryData = [
                ["ACTIVITY LOG SUMMARY"],
                ["Generated:", new Date().toLocaleString()],
                [],
                ["TOTAL LOGS:", activityLogs.length],
                [],
                ["LOGS BY ACTION TYPE"]
            ];
            
            const actions = {};
            activityLogs.forEach(log => {
                actions[log.action] = (actions[log.action] || 0) + 1;
            });
            
            Object.keys(actions).sort().forEach(action => {
                summaryData.push([action, actions[action]]);
            });
            
            summaryData.push([], ["LOGS BY USER"]);
            
            const users = {};
            activityLogs.forEach(log => {
                users[log.user] = (users[log.user] || 0) + 1;
            });
            
            Object.keys(users).sort().forEach(user => {
                summaryData.push([user, users[user]]);
            });
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
            
            const fileName = `activity_log_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            logActivity('data_export', {
                type: 'activity_log_export',
                logCount: activityLogs.length,
                exportedBy: currentUser.username
            });
        }

        function clearActivityLog() {
            if (confirm('Are you sure you want to clear the entire activity log? This action cannot be undone.')) {
                activityLogs = [];
                localStorage.setItem('inventoryActivityLogs', JSON.stringify(activityLogs));
                displayActivityLog();
                
                logActivity('log_clear', {
                    clearedBy: currentUser.username,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // ==================== MAIN INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing protection...');
            initializeProtection();
            
            // Add event listener for Enter key in protection code
            document.getElementById('protectionCode').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    checkProtectionCode();
                }
            });
            
            // Add event listener for Enter key in login
            document.getElementById('password').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    login();
                }
            });
        });

        // ==================== HELPERS ====================
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('modalUsername').value = user.username;
                document.getElementById('modalUsername').disabled = true;
                document.getElementById('modalPassword').value = user.password;
                document.getElementById('modalUserRole').value = user.role;
                
                const locationAccessList = document.getElementById('locationAccessList');
                locationAccessList.innerHTML = '';
                
                locations.filter(l => l.active).forEach(location => {
                    const div = document.createElement('div');
                    div.className = 'location-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = location.id;
                    checkbox.checked = user.locations.includes(location.id);
                    checkbox.id = `loc-edit-${location.id}`;
                    
                    const label = document.createElement('label');
                    label.textContent = location.name;
                    label.htmlFor = `loc-edit-${location.id}`;
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    locationAccessList.appendChild(div);
                });
                
                document.getElementById('userModal').style.display = 'flex';
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#userList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterLocations() {
            const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminLocationList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
    </script>
</body>
</html>
