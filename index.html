<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Manager - Real Time Online</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      padding: 20px 0;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 5px;
    }
    .subtitle {
      font-size: 1rem;
      opacity: 0.8;
    }
    .user-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .user-role {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    .stats {
      display: flex;
      gap: 20px;
    }
    .stat-box {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .stat-label {
      font-size: 0.8rem;
    }
    .section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filters select, .filters input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      min-width: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }
    tr:hover {
      background-color: #f8f9fa;
    }
    .category-header {
      background-color: #f1f8ff !important;
      font-weight: bold;
    }
    .tab-navigation {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
    }
    .tab-button {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: #7f8c8d;
      border-bottom: 3px solid transparent;
    }
    .tab-button.active {
      color: #3498db;
      border-bottom: 3px solid #3498db;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .quantity-controls {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-wrap: wrap;
    }
    .quantity-btn {
      padding: 5px 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-weight: bold;
    }
    .quantity-btn:hover {
      background: #2980b9;
    }
    .quantity-input {
      width: 80px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      text-align: center;
    }
    .admin-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .admin-btn:hover {
      background: #c0392b;
    }
    .add-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .add-btn:hover {
      background: #219653;
    }
    .edit-btn {
      background: #f39c12;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin: 2px;
    }
    .edit-btn:hover {
      background: #e67e22;
    }
    .count-summary {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #d1e7f7;
    }
    .summary-row:last-child {
      border-bottom: none;
    }
    .reset-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .analysis-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #3498db;
    }
    .analysis-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #ecf0f1;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #3498db;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }
    .decimal-btn {
      padding: 3px 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .custom-increment {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .custom-increment-input {
      width: 60px;
      padding: 3px;
      border: 1px solid #ddd;
      border-radius: 3px;
      text-align: center;
    }
    .month-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #e8f4fd;
      border-radius: 8px;
      flex-wrap: wrap;
    }
    .location-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .location-btn {
      padding: 10px 20px;
      background: #ecf0f1;
      border: 2px solid #bdc3c7;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    .location-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    .status-banner {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    .status-open {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-closed {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .readonly-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: #e74c3c;
    }
    .relative-container {
      position: relative;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .login-form input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .login-form button {
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 15px;
    }
    .form-group label {
      font-weight: 600;
      color: #2c3e50;
    }
    .form-group input, .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .admin-only {
      border-left: 4px solid #e74c3c;
      background: #fdf2f2;
    }
    .user-management {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .user-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #3498db;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #7f8c8d;
    }
    .location-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .protection-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      font-size: 1.5rem;
      text-align: center;
    }
    .protection-code {
      background: white;
      padding: 30px;
      border-radius: 10px;
      color: #333;
      max-width: 400px;
      width: 90%;
    }
    .protection-code input {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
      border: 2px solid #3498db;
      border-radius: 5px;
      font-size: 1.2rem;
      text-align: center;
    }
    .protection-code button {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
    }
    .sync-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      z-index: 1001;
    }
    .sync-online {
      background: #27ae60;
      color: white;
    }
    .sync-offline {
      background: #e74c3c;
      color: white;
    }
    .sync-syncing {
      background: #f39c12;
      color: white;
    }
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .stats, .filters, .month-selector {
        flex-direction: column;
      }
      
      .analysis-grid, .user-management {
        grid-template-columns: 1fr;
      }
      
      .quantity-controls {
        flex-wrap: wrap;
      }
      
      .tab-navigation {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Sync Indicator -->
  <div id="syncIndicator" class="sync-indicator sync-offline">Offline</div>

  <!-- Protection Overlay -->
  <div id="protectionOverlay" class="protection-overlay">
    <div class="protection-code">
      <h2>ðŸ”’ Inventory System Access</h2>
      <h3>Real-Time Inventory Management</h3>
      <p>Enter security code to continue</p>
      <p><small>Use: <strong>BFS2024INV</strong></small></p>
      <input type="password" id="protectionCode" placeholder="Enter access code" autocomplete="off" onkeypress="if(event.key === 'Enter') checkProtectionCode()">
      <button onclick="checkProtectionCode()">Unlock System</button>
      <p id="protectionError" style="color: red; display: none; margin-top: 10px;">Invalid access code</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container" style="display: none;">
    <h2>Inventory System Login</h2>
    <div class="login-form">
      <input type="text" id="username" placeholder="Username" autocomplete="off" value="admin">
      <input type="password" id="password" placeholder="Password" autocomplete="new-password" value="admin123">
      <button onclick="login()">Login</button>
    </div>
    <div style="margin-top: 20px; text-align: center;">
      <p><strong>Real-Time Inventory System</strong></p>
      <p>All changes sync instantly across all devices</p>
      <p><small>Auto-filled: admin / admin123</small></p>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="container" style="display: none;">
    <header>
      <div class="header-content">
        <div>
          <h1>Real-Time Inventory Tracker</h1>
          <p class="subtitle">Live Sync Across All Devices</p>
        </div>
        <div class="user-info">
          <div class="user-role" id="userRoleDisplay">Role: Loading...</div>
          <div class="stats">
            <div class="stat-box">
              <div class="stat-value" id="totalProducts">0</div>
              <div class="stat-label">Products</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="totalCategories">0</div>
              <div class="stat-label">Categories</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="totalCounted">0</div>
              <div class="stat-label">Counted Items</div>
            </div>
          </div>
          <button class="admin-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <!-- Location Selector -->
    <div class="section">
      <h3>Select Location</h3>
      <div class="location-selector" id="locationSelector">
        <!-- Locations loaded from Firebase -->
      </div>
    </div>

    <!-- Month Selector -->
    <div class="section">
      <div class="month-selector">
        <div>
          <strong>Current Period:</strong> 
          <span id="currentPeriodDisplay"></span>
        </div>
        <div>
          <strong>Status:</strong> 
          <span id="countingStatus"></span>
        </div>
        <select id="yearSelect" onchange="updateMonthOptions()">
          <option value="">Select Year</option>
        </select>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="">Select Month</option>
        </select>
        <button class="quantity-btn" onclick="createNewMonth()">Start New Month</button>
      </div>
      <div id="statusBanner" class="status-banner"></div>
    </div>

    <!-- Tabs -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="openTab('counting')">Quantity Counting</button>
      <button class="tab-button" onclick="openTab('products')">All Products</button>
      <button class="tab-button" onclick="openTab('analysis')">Analysis</button>
      <button class="tab-button" onclick="openTab('summary')">Count Summary</button>
      <button class="tab-button" onclick="openTab('archive')">Monthly Archive</button>
    </div>

    <!-- Counting Tab -->
    <div id="counting" class="tab-content active">
      <div class="section relative-container">
        <div id="readonlyOverlay" class="readonly-overlay" style="display: none;">
          Counting Period Closed - Read Only Mode
        </div>
        <h2>Quantity Counting - <span id="locationDisplay"></span></h2>
        <p>Real-time updates. Changes sync instantly across all devices.</p>
        <div class="filters">
          <select id="countingCategoryFilter" onchange="filterCountingProducts()">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="countingSearch" placeholder="Search products..." onkeyup="filterCountingProducts()">
        </div>
        <table id="countingTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Price (â‚¬)</th>
              <th>Quantity</th>
              <th>Total Value</th>
            </tr>
          </thead>
          <tbody id="countingList"></tbody>
        </table>
      </div>
    </div>

    <!-- Products Tab -->
    <div id="products" class="tab-content">
      <div class="section">
        <h2>Complete Product Catalog</h2>
        <div class="filters">
          <select id="categoryFilter" onchange="filterProducts()">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()">
        </div>
        <table id="productTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Category</th>
              <th>Unit</th>
              <th>Price (â‚¬)</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>
    </div>

    <!-- Analysis Tab -->
    <div id="analysis" class="tab-content">
      <div class="section">
        <h2>Inventory Analysis - <span id="analysisLocation"></span></h2>
        <div class="analysis-grid">
          <div class="analysis-card">
            <h4>Total Inventory Value</h4>
            <div class="analysis-value" id="totalInventoryValue">â‚¬0.00</div>
            <div class="progress-bar">
              <div class="progress-fill" id="inventoryProgress" style="width: 0%"></div>
            </div>
          </div>
          <div class="analysis-card">
            <h4>Most Valuable Category</h4>
            <div class="analysis-value" id="topCategory">-</div>
            <div id="topCategoryValue">â‚¬0.00</div>
          </div>
          <div class="analysis-card">
            <h4>Items Counted</h4>
            <div class="analysis-value" id="itemsCounted">0</div>
            <div>out of <span id="totalItems">0</span> products</div>
          </div>
          <div class="analysis-card">
            <h4>Average Price per Item</h4>
            <div class="analysis-value" id="avgPrice">â‚¬0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Tab -->
    <div id="summary" class="tab-content">
      <div class="section">
        <h2>Count Summary - <span id="summaryLocation"></span></h2>
        <div class="count-summary">
          <h3>Summary by Category</h3>
          <div id="categorySummary"></div>
          <button class="reset-btn" onclick="resetCurrentCounts()">Reset Current Counts</button>
        </div>
        <div class="count-summary" style="margin-top: 20px;">
          <h3>Total Counted Items</h3>
          <div class="summary-row">
            <span>Total Items Counted:</span>
            <span id="totalItemsCounted">0</span>
          </div>
          <div class="summary-row">
            <span>Total Value:</span>
            <span id="totalCountedValue">â‚¬0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Archive Tab -->
    <div id="archive" class="tab-content">
      <div class="section">
        <h2>Monthly Archive</h2>
        <div class="filters">
          <select id="archiveLocationFilter" onchange="displayArchive()">
            <option value="all">All Locations</option>
          </select>
          <select id="archiveYearFilter" onchange="displayArchive()">
            <option value="all">All Years</option>
          </select>
        </div>
        <table id="archiveTable">
          <thead>
            <tr>
              <th>Month/Year</th>
              <th>Location</th>
              <th>Total Items</th>
              <th>Total Value</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="archiveList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==================== SIMPLIFIED WORKING VERSION ====================
    const PROTECTION_CODES = ['BFS2024INV', 'SHAKTIINV24', 'FOODSERVICES', 'HAFERKATER'];
    
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCvENxXAfEqgegtr5RFIYcolV_eURTcbzA",
      authDomain: "invbfs.firebaseapp.com",
      databaseURL: "https://invbfs-default-rtdb.firebaseio.com",
      projectId: "invbfs",
      storageBucket: "invbfs.appspot.com",
      messagingSenderId: "183500505178",
      appId: "1:183500505178:web:0ca737b5d200005bbc9863"
    };

    // Global variables
    let currentUser = null;
    let currentLocation = 'ostbahnhof';
    let currentMonth = '';
    let db = null;
    let firebaseInitialized = false;
    let products = [];
    let users = [];
    let locations = [];
    let monthlyData = {};

    // ==================== DEFAULT USERS (GUARANTEED LOGIN) ====================
    const DEFAULT_USERS = [
      { 
        username: 'admin', 
        password: 'admin123', 
        role: 'admin', 
        locations: ['ostbahnhof', 'potsdam'], 
        lastLogin: null 
      },
      { 
        username: 'user', 
        password: 'user123', 
        role: 'inventory', 
        locations: ['ostbahnhof'], 
        lastLogin: null 
      }
    ];

    // ==================== PROTECTION & LOGIN ====================
    function checkProtectionCode() {
      const inputCode = document.getElementById('protectionCode').value.trim();
      const errorMsg = document.getElementById('protectionError');
      
      if (PROTECTION_CODES.includes(inputCode)) {
        document.getElementById('protectionOverlay').style.display = 'none';
        showLoginScreen();
      } else {
        errorMsg.textContent = 'Invalid access code. Try: BFS2024INV';
        errorMsg.style.display = 'block';
        document.getElementById('protectionCode').value = '';
        document.getElementById('protectionCode').focus();
      }
    }

    function showLoginScreen() {
      console.log('Showing login screen');
      document.getElementById('protectionOverlay').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('app').style.display = 'none';
      // Auto-fill credentials for testing
      document.getElementById('username').value = 'admin';
      document.getElementById('password').value = 'admin123';
    }

    // ==================== SIMPLIFIED LOGIN (ALWAYS WORKS) ====================
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      console.log('Login attempt:', username);
      
      // Always accept admin/admin123 for testing
      if (username === 'admin' && password === 'admin123') {
        console.log('Login successful');
        currentUser = {
          username: 'admin',
          role: 'admin',
          locations: ['ostbahnhof', 'potsdam']
        };
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // Initialize app
        initializeApp();
      } else {
        alert('Invalid credentials. Use: admin / admin123');
      }
    }

    function logout() {
      console.log('Logging out');
      currentUser = null;
      document.getElementById('app').style.display = 'none';
      showLoginScreen();
    }

    // ==================== APP INITIALIZATION ====================
    function initializeApp() {
      console.log('Initializing app...');
      
      // Initialize Firebase
      initializeFirebase();
      
      // Set current month
      const today = new Date();
      const year = today.getFullYear();
      const month = (today.getMonth() + 1).toString().padStart(2, '0');
      currentMonth = `${year}-${month}`;
      
      // Update UI
      updateUserRoleDisplay();
      setupLocationSelector();
      setupYearMonthSelectors();
      updateMonthDisplay();
      updateCategoryFilter();
      displayProducts();
      displayCountingProducts();
      updateSummary();
      updateAnalysis();
      
      console.log('App initialized successfully');
    }

    function initializeFirebase() {
      console.log('Initializing Firebase...');
      
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log('Firebase initialized successfully');
        }
        
        db = firebase.database();
        firebaseInitialized = true;
        
        // Monitor connection status
        const connectedRef = db.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          const isConnected = snap.val();
          console.log('Firebase connection:', isConnected);
          
          const indicator = document.getElementById('syncIndicator');
          if (isConnected) {
            indicator.className = 'sync-indicator sync-online';
            indicator.textContent = 'Online';
            // Load data when connected
            loadFirebaseData();
          } else {
            indicator.className = 'sync-indicator sync-offline';
            indicator.textContent = 'Offline';
          }
        });
        
      } catch (error) {
        console.error('Firebase initialization error:', error);
        firebaseInitialized = false;
        document.getElementById('syncIndicator').className = 'sync-indicator sync-offline';
        document.getElementById('syncIndicator').textContent = 'Offline';
      }
    }

    async function loadFirebaseData() {
      if (!firebaseInitialized || !db) {
        console.log('Firebase not available, using local data');
        // Use local product data
        products = getDefaultProducts();
        locations = getDefaultLocations();
        users = DEFAULT_USERS;
        
        updateCategoryFilter();
        displayProducts();
        displayCountingProducts();
        return;
      }
      
      try {
        console.log('Loading data from Firebase...');
        
        // Load products
        const productsSnapshot = await db.ref('products').once('value');
        if (productsSnapshot.exists()) {
          const productsObj = productsSnapshot.val();
          products = Object.values(productsObj);
          console.log('Products loaded from Firebase:', products.length);
        } else {
          // Initialize with default products
          products = getDefaultProducts();
          await saveProductsToFirebase();
        }
        
        // Load monthly data
        const monthlySnapshot = await db.ref('monthlyData').once('value');
        if (monthlySnapshot.exists()) {
          monthlyData = monthlySnapshot.val();
          console.log('Monthly data loaded from Firebase');
        }
        
        // Update UI
        updateCategoryFilter();
        displayProducts();
        displayCountingProducts();
        
      } catch (error) {
        console.error('Error loading Firebase data:', error);
        // Fallback to local data
        products = getDefaultProducts();
        locations = getDefaultLocations();
        updateCategoryFilter();
        displayProducts();
        displayCountingProducts();
      }
    }

    function getDefaultProducts() {
      return [
        // Your complete product list here (all 150+ products)
        { id: '382224', name: 'B1774_Porridgebecher 500St', unit: 'stuck', category: 'Verbrauch', price: 0.075 },
        { id: '252437', name: 'B1774_Deckel Porridge Be.500St', unit: 'stuck', category: 'Verbrauch', price: 0.071 },
        { id: '370981', name: 'B1774_Kaffeebech. 200ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.049 },
        { id: '802049', name: 'B1774_Servietten 5000St', unit: 'stuck', category: 'Verbrauch', price: 0.09 },
        { id: '343306', name: 'B1774_GroÃŸe Bowl-Schale 300St', unit: 'stuck', category: 'Verbrauch', price: 0.158 },
        { id: '966396', name: 'B1774_Blockbodenb.klein 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
        { id: '368945', name: 'B1774_GroÃŸe Bowl-Deckel 300St', unit: 'stuck', category: 'Verbrauch', price: 0.148 },
        { id: '854238', name: 'B1774_Blockbodenbeu.groÃŸ 800St', unit: 'stuck', category: 'Verbrauch', price: 0.043 },
        { id: '340091', name: 'LÃ–FFEL HOLZ 16,5CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.027 },
        { id: '317674', name: 'B1774_Kaffe Deckel 90mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.047 },
        { id: '461226', name: 'B1774_Snack-Pap.Zuschn.500St', unit: 'stuck', category: 'Verbrauch', price: 0.187 },
        { id: '448199', name: 'Bechermanschetten braun 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.039 },
        { id: '69636', name: 'B1774_Vitrin.Bowl klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.121 },
        { id: '545740', name: 'Hand.Pap.2lg 25x23 TGQ20x150Bl', unit: 'stuck', category: 'Verbrauch', price: 0.008 },
        { id: '59784', name: 'DECKEL PLA PORTIONSBECHER 2000', unit: 'stuck', category: 'Verbrauch', price: 0.037 },
        { id: '472974', name: 'B1774_Vitri.Deckel.klein 300St', unit: 'stuck', category: 'Verbrauch', price: 0.12 },
        { id: '754897', name: 'Sahneabdeckpa.18X24cm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.01 },
        { id: '92548', name: 'MS 120L Stand.blau 25St', unit: 'stuck', category: 'Verbrauch', price: 0.023 },
        { id: '361533', name: 'B1774_Kaffee Bech.300ml 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.034 },
        { id: '413902', name: 'KÃ¼chentÃ¼cher 3lg. TGQ 4x64Bl', unit: 'stuck', category: 'Verbrauch', price: 0.839 },
        { id: '383208', name: 'GABEL HOLZ 16CM GB 10x100ST', unit: 'stuck', category: 'Verbrauch', price: 0.028 },
        { id: '35236', name: 'Dressingbech.30ml transp.100St', unit: 'stuck', category: 'Verbrauch', price: 0.022 },
        { id: '830712', name: 'B1774_Papiertasche klein 250St', unit: 'stuck', category: 'Verbrauch', price: 0.115 },
        { id: '318372', name: 'NITRIL HANDSCH.L WE.PUDE.100ST', unit: 'stuck', category: 'Verbrauch', price: 0.056 },
        { id: '331635', name: 'Deckel DressingCup trans.100St', unit: 'stuck', category: 'Verbrauch', price: 0.017 },
        { id: '105439', name: 'B1774_Kaffe.Deckel 80mm 1000St', unit: 'stuck', category: 'Verbrauch', price: 0.04 },
        // ... Add all your other products here
        { id: '298009', name: 'B1774_Bio Espresso 1kg', unit: 'stuck', category: 'Trockenware', price: 16.761 },
        { id: '896293', name: 'B1774_Bio Granola 4,5kg', unit: 'stuck', category: 'Trockenware', price: 48.532 },
        { id: '768559', name: 'Weizentort.Grill.30cm Fu.18St', unit: 'stuck', category: 'Trockenware', price: 5.99 },
        // Continue with all your products...
      ];
    }

    function getDefaultLocations() {
      return [
        { id: 'ostbahnhof', name: 'Haferkater Ostbahnhof', active: true },
        { id: 'potsdam', name: 'Haferkater Potsdam', active: true }
      ];
    }

    async function saveProductsToFirebase() {
      if (!firebaseInitialized || !db) return;
      
      try {
        const productsObj = {};
        products.forEach(product => {
          productsObj[product.id] = product;
        });
        
        await db.ref('products').set(productsObj);
        console.log('Products saved to Firebase');
      } catch (error) {
        console.error('Error saving products:', error);
      }
    }

    // ==================== UI FUNCTIONS ====================
    function updateUserRoleDisplay() {
      if (currentUser) {
        const roleText = currentUser.role === 'admin' ? 'Administrator' : 'Inventory User';
        document.getElementById('userRoleDisplay').textContent = `Role: ${roleText}`;
      }
    }

    function setupLocationSelector() {
      const locationSelector = document.getElementById('locationSelector');
      if (!locationSelector) return;
      
      locationSelector.innerHTML = '';
      
      const userLocations = getDefaultLocations();
      
      userLocations.forEach(location => {
        const button = document.createElement('button');
        button.className = `location-btn ${location.id === currentLocation ? 'active' : ''}`;
        button.textContent = location.name;
        button.onclick = () => {
          currentLocation = location.id;
          document.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          updateUI();
        };
        locationSelector.appendChild(button);
      });
    }

    function setupYearMonthSelectors() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      
      if (!yearSelect || !monthSelect) return;
      
      // Set up years
      yearSelect.innerHTML = '<option value="">Select Year</option>';
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
        if (year === currentYear) {
          option.selected = true;
        }
      }
      
      updateMonthOptions();
      
      // Set current month
      const [year, month] = currentMonth.split('-');
      monthSelect.value = currentMonth;
    }

    function updateMonthOptions() {
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      const selectedYear = yearSelect.value;
      
      monthSelect.innerHTML = '<option value="">Select Month</option>';
      
      if (selectedYear) {
        for (let month = 1; month <= 12; month++) {
          const option = document.createElement('option');
          const monthStr = month.toString().padStart(2, '0');
          option.value = `${selectedYear}-${monthStr}`;
          option.textContent = new Date(selectedYear, month - 1).toLocaleString('default', { month: 'long' });
          monthSelect.appendChild(option);
        }
      }
    }

    function changeMonth() {
      const monthSelect = document.getElementById('monthSelect');
      const selectedMonth = monthSelect.value;
      
      if (selectedMonth) {
        currentMonth = selectedMonth;
        updateMonthDisplay();
        updateUI();
      }
    }

    function updateMonthDisplay() {
      if (!currentMonth) return;
      
      const [year, month] = currentMonth.split('-');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('currentPeriodDisplay').textContent = `${monthNames[parseInt(month) - 1]} ${year}`;
      
      // Update location displays
      const locationName = getLocationDisplayName(currentLocation);
      document.getElementById('locationDisplay').textContent = locationName;
      document.getElementById('analysisLocation').textContent = locationName;
      document.getElementById('summaryLocation').textContent = locationName;
      
      updateCountingStatus();
    }

    function getLocationDisplayName(locationId) {
      const location = getDefaultLocations().find(l => l.id === locationId);
      return location ? location.name : locationId;
    }

    function updateCountingStatus() {
      const today = new Date();
      const [year, month] = currentMonth.split('-');
      const countingDeadline = new Date(year, parseInt(month), 10);
      
      // Initialize month data if it doesn't exist
      if (!monthlyData[currentLocation]) monthlyData[currentLocation] = {};
      if (!monthlyData[currentLocation][currentMonth]) {
        monthlyData[currentLocation][currentMonth] = {
          counts: {},
          created: new Date().toISOString(),
          status: 'open'
        };
      }
      
      const monthData = monthlyData[currentLocation][currentMonth];
      
      let status, bannerClass, bannerText;
      
      if (today > countingDeadline && monthData.status === 'open') {
        monthData.status = 'closed';
      }
      
      if (monthData.status === 'closed') {
        status = 'CLOSED';
        bannerClass = 'status-closed';
        bannerText = `Counting period for ${document.getElementById('currentPeriodDisplay').textContent} is CLOSED. No further edits allowed.`;
        document.getElementById('readonlyOverlay').style.display = 'flex';
      } else {
        status = 'OPEN';
        bannerClass = 'status-open';
        const daysLeft = Math.ceil((countingDeadline - today) / (1000 * 60 * 60 * 24));
        bannerText = `Counting period for ${document.getElementById('currentPeriodDisplay').textContent} is OPEN. ${daysLeft} days left until closing on the 10th of next month.`;
        document.getElementById('readonlyOverlay').style.display = 'none';
      }
      
      document.getElementById('countingStatus').textContent = status;
      const banner = document.getElementById('statusBanner');
      banner.className = `status-banner ${bannerClass}`;
      banner.textContent = bannerText;
    }

    // ==================== PRODUCT FUNCTIONS ====================
    function updateCategoryFilter() {
      const categories = [...new Set(products.map(p => p.category))].sort();
      const filter1 = document.getElementById('categoryFilter');
      const filter2 = document.getElementById('countingCategoryFilter');
      
      if (filter1 && filter2) {
        filter1.innerHTML = filter2.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(category => {
          const option1 = document.createElement('option');
          option1.value = category;
          option1.textContent = category;
          filter1.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = category;
          option2.textContent = category;
          filter2.appendChild(option2);
        });
      }
    }

    function displayProducts() {
      const tbody = document.getElementById('productList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      const categoryFilter = document.getElementById('categoryFilter')?.value || '';
      const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
      
      let filteredProducts = products;
      if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
      if (searchTerm) filteredProducts = filteredProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
      
      if (filteredProducts.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `<td colspan="5" style="text-align: center;">No products found</td>`;
        return;
      }
      
      let currentCategory = '';
      filteredProducts.sort((a, b) => {
        if (a.category !== b.category) return a.category.localeCompare(b.category);
        return a.name.localeCompare(b.name);
      }).forEach(product => {
        if (product.category !== currentCategory) {
          currentCategory = product.category;
          const headerRow = tbody.insertRow();
          headerRow.className = 'category-header';
          headerRow.innerHTML = `<td colspan="5">${currentCategory}</td>`;
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${product.id}</td>
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>${product.unit}</td>
          <td>â‚¬${product.price.toFixed(2)}</td>
        `;
      });
      
      // Update stats
      if (document.getElementById('totalProducts')) {
        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('totalCategories').textContent = [...new Set(products.map(p => p.category))].length;
      }
    }

    function displayCountingProducts() {
      const tbody = document.getElementById('countingList');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      const categoryFilter = document.getElementById('countingCategoryFilter')?.value || '';
      const searchTerm = document.getElementById('countingSearch')?.value.toLowerCase() || '';
      
      let filteredProducts = products;
      if (categoryFilter) filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
      if (searchTerm) filteredProducts = filteredProducts.filter(p => 
        p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm));
      
      if (filteredProducts.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `<td colspan="6" style="text-align: center;">No products found</td>`;
        return;
      }
      
      // Get counts for current location/month
      const counts = monthlyData[currentLocation]?.[currentMonth]?.counts || {};
      const isReadOnly = monthlyData[currentLocation]?.[currentMonth]?.status === 'closed';
      
      let currentCategory = '';
      filteredProducts.sort((a, b) => {
        if (a.category !== b.category) return a.category.localeCompare(b.category);
        return a.name.localeCompare(b.name);
      }).forEach(product => {
        if (product.category !== currentCategory) {
          currentCategory = product.category;
          const headerRow = tbody.insertRow();
          headerRow.className = 'category-header';
          headerRow.innerHTML = `<td colspan="6">${currentCategory}</td>`;
        }
        
        const count = parseFloat(counts[product.id]) || 0;
        const totalValue = count * product.price;
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>${product.unit}</td>
          <td>â‚¬${product.price.toFixed(2)}</td>
          <td>
            <div class="quantity-controls">
              <button class="quantity-btn" onclick="decrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>-1</button>
              <button class="decimal-btn" onclick="decrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>-0.1</button>
              <input type="number" class="quantity-input" value="${formatDecimal(count)}" 
                     onchange="setManualCount('${product.id}', this.value)" 
                     onblur="setManualCount('${product.id}', this.value)"
                     min="0" step="0.01" placeholder="0.00" ${isReadOnly ? 'disabled' : ''}>
              <button class="decimal-btn" onclick="incrementCount('${product.id}', 0.1)" ${isReadOnly ? 'disabled' : ''}>+0.1</button>
              <button class="quantity-btn" onclick="incrementCount('${product.id}', 1)" ${isReadOnly ? 'disabled' : ''}>+1</button>
            </div>
          </td>
          <td>â‚¬${totalValue.toFixed(2)}</td>
        `;
      });
      
      updateTotalCounted();
    }

    // ==================== COUNTING FUNCTIONS ====================
    async function incrementCount(productId, increment = 1) {
      if (isCountingClosed()) return;
      
      if (!monthlyData[currentLocation]) monthlyData[currentLocation] = {};
      if (!monthlyData[currentLocation][currentMonth]) {
        monthlyData[currentLocation][currentMonth] = {
          counts: {},
          created: new Date().toISOString(),
          status: 'open'
        };
      }
      
      const currentCount = parseFloat(monthlyData[currentLocation][currentMonth].counts[productId]) || 0;
      const newCount = currentCount + increment;
      monthlyData[currentLocation][currentMonth].counts[productId] = newCount;
      
      // Save to Firebase if available
      await saveCountToFirebase(productId, newCount);
      
      updateTotalCounted();
      updateSummary();
      updateAnalysis();
      displayCountingProducts();
    }

    async function decrementCount(productId, decrement = 1) {
      if (isCountingClosed()) return;
      
      const currentCount = parseFloat(monthlyData[currentLocation]?.[currentMonth]?.counts?.[productId]) || 0;
      const newCount = Math.max(0, currentCount - decrement);
      
      if (!monthlyData[currentLocation]) monthlyData[currentLocation] = {};
      if (!monthlyData[currentLocation][currentMonth]) {
        monthlyData[currentLocation][currentMonth] = {
          counts: {},
          created: new Date().toISOString(),
          status: 'open'
        };
      }
      
      monthlyData[currentLocation][currentMonth].counts[productId] = newCount;
      await saveCountToFirebase(productId, newCount);
      updateTotalCounted();
      updateSummary();
      updateAnalysis();
      displayCountingProducts();
    }

    async function setManualCount(productId, value) {
      if (isCountingClosed()) return;
      
      const numValue = parseFloat(value) || 0;
      if (numValue >= 0) {
        if (!monthlyData[currentLocation]) monthlyData[currentLocation] = {};
        if (!monthlyData[currentLocation][currentMonth]) {
          monthlyData[currentLocation][currentMonth] = {
            counts: {},
            created: new Date().toISOString(),
            status: 'open'
          };
        }
        
        monthlyData[currentLocation][currentMonth].counts[productId] = numValue;
        await saveCountToFirebase(productId, numValue);
        updateTotalCounted();
        updateSummary();
        updateAnalysis();
        displayCountingProducts();
      }
    }

    async function saveCountToFirebase(productId, count) {
      if (!firebaseInitialized || !db) return;
      
      try {
        const updates = {};
        updates[`monthlyData/${currentLocation}/${currentMonth}/counts/${productId}`] = count;
        
        await db.ref().update(updates);
        console.log('Count saved to Firebase:', productId, count);
      } catch (error) {
        console.error('Error saving count to Firebase:', error);
      }
    }

    function formatDecimal(value) {
      const num = parseFloat(value);
      return num % 1 === 0 ? num.toString() : num.toFixed(2);
    }

    function isCountingClosed() {
      const status = monthlyData[currentLocation]?.[currentMonth]?.status;
      if (status === 'closed') {
        alert('Counting period is closed. No further edits allowed.');
        return true;
      }
      return false;
    }

    function updateTotalCounted() {
      const counts = monthlyData[currentLocation]?.[currentMonth]?.counts || {};
      const totalCounted = Object.values(counts).reduce((sum, count) => sum + parseFloat(count), 0);
      if (document.getElementById('totalCounted')) {
        document.getElementById('totalCounted').textContent = formatDecimal(totalCounted);
      }
    }

    // ==================== SUMMARY FUNCTIONS ====================
    function updateSummary() {
      const counts = monthlyData[currentLocation]?.[currentMonth]?.counts || {};
      const categorySummary = document.getElementById('categorySummary');
      if (!categorySummary) return;
      
      categorySummary.innerHTML = '';
      const categories = {};
      
      products.forEach(product => {
        if (!categories[product.category]) categories[product.category] = { count: 0, value: 0 };
        const count = parseFloat(counts[product.id]) || 0;
        categories[product.category].count += count;
        categories[product.category].value += count * product.price;
      });
      
      Object.keys(categories).sort().forEach(category => {
        const data = categories[category];
        if (data.count > 0) {
          const row = document.createElement('div');
          row.className = 'summary-row';
          row.innerHTML = `<span>${category}:</span><span>${formatDecimal(data.count)} items (â‚¬${data.value.toFixed(2)})</span>`;
          categorySummary.appendChild(row);
        }
      });
      
      let totalItems = 0, totalValue = 0;
      Object.keys(counts).forEach(productId => {
        const product = products.find(p => p.id == productId);
        if (product) {
          totalItems += parseFloat(counts[productId]);
          totalValue += parseFloat(counts[productId]) * product.price;
        }
      });
      
      document.getElementById('totalItemsCounted').textContent = formatDecimal(totalItems);
      document.getElementById('totalCountedValue').textContent = `â‚¬${totalValue.toFixed(2)}`;
    }

    // ==================== ANALYSIS FUNCTIONS ====================
    function updateAnalysis() {
      const counts = monthlyData[currentLocation]?.[currentMonth]?.counts || {};
      
      let totalValue = 0;
      let itemsCounted = 0;
      const categoryValues = {};
      
      products.forEach(product => {
        const count = parseFloat(counts[product.id]) || 0;
        const value = count * product.price;
        totalValue += value;
        if (count > 0) itemsCounted++;
        
        if (!categoryValues[product.category]) {
          categoryValues[product.category] = 0;
        }
        categoryValues[product.category] += value;
      });
      
      document.getElementById('totalInventoryValue').textContent = `â‚¬${totalValue.toFixed(2)}`;
      document.getElementById('itemsCounted').textContent = formatDecimal(itemsCounted);
      document.getElementById('totalItems').textContent = products.length;
      
      const avgPrice = itemsCounted > 0 ? totalValue / itemsCounted : 0;
      document.getElementById('avgPrice').textContent = `â‚¬${avgPrice.toFixed(2)}`;
      
      let topCategory = '-';
      let topCategoryValue = 0;
      Object.keys(categoryValues).forEach(category => {
        if (categoryValues[category] > topCategoryValue) {
          topCategory = category;
          topCategoryValue = categoryValues[category];
        }
      });
      document.getElementById('topCategory').textContent = topCategory;
      document.getElementById('topCategoryValue').textContent = `â‚¬${topCategoryValue.toFixed(2)}`;
      
      const progressPercent = (itemsCounted / products.length) * 100;
      document.getElementById('inventoryProgress').style.width = `${progressPercent}%`;
    }

    // ==================== TAB FUNCTIONS ====================
    function openTab(tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');
      
      if (tabName === 'analysis') {
        updateAnalysis();
      }
    }

    // ==================== FILTER FUNCTIONS ====================
    function filterProducts() {
      displayProducts();
    }

    function filterCountingProducts() {
      displayCountingProducts();
    }

    // ==================== UPDATE UI ====================
    function updateUI() {
      updateMonthDisplay();
      displayProducts();
      displayCountingProducts();
      updateSummary();
      updateAnalysis();
    }

    // ==================== INITIALIZATION ====================
    function initializeProtection() {
      console.log('Starting inventory system...');
      document.getElementById('protectionOverlay').style.display = 'flex';
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'none';
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initializeProtection);

  </script>
</body>
</html>
